

<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SonicWall Management Console</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-50: #f0f9ff;
            --primary-100: #e0f2fe;
            --primary-200: #bae6fd;
            --primary-300: #7dd3fc;
            --primary-400: #38bdf8;
            --primary-500: #0ea5e9;
            --primary-600: #0284c7;
            --primary-700: #0369a1;
            --primary-800: #075985;
            --primary-900: #0c4a6e;
            
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            
            --success-50: #f0fdf4;
            --success-500: #22c55e;
            --success-600: #16a34a;
            
            --warning-50: #fffbeb;
            --warning-500: #f59e0b;
            --warning-600: #d97706;
            
            --error-50: #fef2f2;
            --error-500: #ef4444;
            --error-600: #dc2626;
            
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--gray-50);
            color: var(--gray-900);
            line-height: 1.6;
        }

        .app-container {
            min-height: 100vh;
            display: flex;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: white;
            border-right: 1px solid var(--gray-200);
            padding: 2rem 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }

        .sidebar-header {
            padding: 0 2rem 2rem;
            border-bottom: 1px solid var(--gray-200);
            margin-bottom: 2rem;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary-500), var(--primary-600));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.25rem;
            font-weight: 600;
        }

        .logo-text {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--gray-900);
        }

        .sidebar-nav {
            padding: 0 1rem;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            margin-bottom: 0.25rem;
            border-radius: 8px;
            text-decoration: none;
            color: var(--gray-600);
            font-weight: 500;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        /* Navigation Group (Users) */
        .nav-group {
            margin-bottom: 0.5rem;
        }

        .nav-group-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            color: var(--gray-700);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
        }

        .nav-group-header:hover {
            background: var(--gray-100);
            color: var(--gray-900);
        }

        .nav-group-header .nav-arrow {
            margin-left: auto;
            transition: transform 0.3s ease;
            font-size: 0.8rem;
        }

        .nav-group-header.open .nav-arrow {
            transform: rotate(180deg);
        }

        .nav-group-items {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .nav-group-items.open {
            max-height: 500px;
        }

        .nav-subitem {
            padding-left: 2.5rem;
            font-size: 0.9rem;
            margin-bottom: 0.2rem;
            position: relative;
        }

        .nav-subitem::before {
            content: '';
            position: absolute;
            left: 1.5rem;
            top: 50%;
            transform: translateY(-50%);
            width: 6px;
            height: 6px;
            background: var(--gray-400);
            border-radius: 50%;
        }

        .nav-subitem:hover::before {
            background: var(--primary-600);
        }

        .nav-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.6s;
        }

        .nav-item:hover::before {
            left: 100%;
        }

        .nav-item:hover {
            background: var(--gray-100);
            color: var(--gray-900);
            transform: translateX(5px);
        }

        .nav-item.active {
            background: var(--primary-50);
            color: var(--primary-700);
            transform: translateX(8px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
        }

        .nav-item.active .nav-icon {
            color: var(--primary-600);
        }

        .nav-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 280px;
            background: var(--gray-50);
        }

        /* Disclaimer Banner */
        .disclaimer-banner {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-bottom: 3px solid #f59e0b;
            padding: 1rem 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            animation: slideDown 0.5s ease-out;
            position: relative;
            z-index: 100;
            transition: all 0.3s ease;
        }

        .disclaimer-banner.collapsed {
            padding: 0.25rem 2rem;
            border-bottom: 2px solid #f59e0b;
        }

        .disclaimer-banner.collapsed .disclaimer-main {
            max-height: 0;
            opacity: 0;
            overflow: hidden;
        }

        .disclaimer-banner.collapsed .disclaimer-toggle {
            margin-top: 0;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-100%);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideUp {
            from {
                opacity: 1;
                transform: translateY(0);
            }
            to {
                opacity: 0;
                transform: translateY(-100%);
            }
        }

        .disclaimer-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            max-width: 1200px;
            width: 100%;
            margin: 0 auto;
        }

        .disclaimer-main {
            display: flex;
            align-items: center;
            gap: 1rem;
            width: 100%;
            transition: all 0.3s ease;
            max-height: 200px;
            opacity: 1;
        }

        .disclaimer-icon {
            font-size: 2rem;
            flex-shrink: 0;
            animation: pulse 2s infinite;
        }

        .disclaimer-text {
            flex: 1;
            color: #78350f;
            font-size: 0.95rem;
            line-height: 1.6;
        }

        .disclaimer-text strong {
            color: #92400e;
            font-weight: 700;
        }

        .disclaimer-toggle {
            background: rgba(146, 64, 14, 0.1);
            border: 2px solid #92400e;
            color: #92400e;
            font-size: 1rem;
            cursor: pointer;
            padding: 0.25rem 1rem;
            border-radius: 20px;
            transition: all 0.3s ease;
            font-weight: bold;
            margin-top: 0.5rem;
        }

        .disclaimer-toggle:hover {
            background: rgba(146, 64, 14, 0.25);
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(146, 64, 14, 0.3);
        }

        .disclaimer-banner.collapsed .disclaimer-toggle {
            margin-top: 0;
        }

        /* Header */
        .header {
            background: white;
            border-bottom: 1px solid var(--gray-200);
            padding: 1.5rem 2rem;
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-title {
            font-size: 1.875rem;
            font-weight: 700;
            color: var(--gray-900);
        }

        .header-stats {
            display: flex;
            gap: 2rem;
        }

        /* Global Search Bar */
        .global-search-container {
            background: white;
            padding: 1rem 2rem;
            border-bottom: 1px solid var(--gray-200);
            box-shadow: var(--shadow-sm);
        }

        .global-search-wrapper {
            max-width: 600px;
            margin: 0 auto;
            position: relative;
        }

        .global-search-input {
            width: 100%;
            padding: 0.75rem 1rem 0.75rem 3rem;
            border: 2px solid var(--gray-300);
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.2s ease;
            background: var(--gray-50);
        }

        .global-search-input:focus {
            outline: none;
            border-color: var(--primary-500);
            background: white;
            box-shadow: 0 0 0 3px var(--primary-100);
        }

        .global-search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-400);
            font-size: 1.2rem;
            pointer-events: none;
        }

        .global-search-clear {
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            background: var(--gray-200);
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            color: var(--gray-600);
            transition: all 0.2s ease;
        }

        .global-search-clear:hover {
            background: var(--gray-300);
        }

        .global-search-clear.visible {
            display: flex;
        }

        /* Search Results Dropdown */
        .search-results-dropdown {
            position: absolute;
            top: calc(100% + 0.5rem);
            left: 0;
            right: 0;
            background: white;
            border: 2px solid var(--primary-500);
            border-radius: 12px;
            box-shadow: var(--shadow-xl);
            max-height: 400px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .search-results-dropdown.visible {
            display: block;
        }

        .search-result-section {
            border-bottom: 1px solid var(--gray-200);
        }

        .search-result-section:last-child {
            border-bottom: none;
        }

        .search-result-header {
            padding: 0.75rem 1rem;
            background: var(--gray-50);
            font-weight: 600;
            font-size: 0.875rem;
            color: var(--gray-700);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .search-result-count {
            background: var(--primary-500);
            color: white;
            padding: 0.125rem 0.5rem;
            border-radius: 10px;
            font-size: 0.75rem;
            font-weight: 700;
        }

        .search-result-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 1rem;
            border-bottom: 1px solid var(--gray-100);
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .search-result-item:hover {
            background: var(--primary-50);
        }

        .search-result-icon {
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .search-result-info {
            flex: 1;
            min-width: 0;
        }

        .search-result-name {
            font-weight: 600;
            color: var(--gray-900);
            font-size: 0.95rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .search-result-detail {
            font-size: 0.85rem;
            color: var(--gray-600);
            margin-top: 0.125rem;
        }

        .search-result-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            white-space: nowrap;
        }

        .search-no-results {
            padding: 2rem 1rem;
            text-align: center;
            color: var(--gray-500);
        }

        .search-no-results-icon {
            font-size: 3rem;
            margin-bottom: 0.5rem;
        }

        .stat-item {
            text-align: center;
            padding: 1rem 1.5rem;
            background: var(--gray-50);
            border-radius: 12px;
            border: 1px solid var(--gray-200);
            min-width: 120px;
        }

        .stat-number {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 0.25rem;
        }

        .stat-label {
            font-size: 0.875rem;
            color: var(--gray-600);
            font-weight: 500;
        }

        /* Content Area */
        .content {
            padding: 2rem;
        }

        /* Keyframe Animations */
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes pulse {
            0%, 100% { 
                transform: scale(1);
                opacity: 1;
            }
            50% { 
                transform: scale(1.02);
                opacity: 0.9;
            }
        }

        /* Risky rules highlighting */
        .risky-rule {
            position: relative;
        }

        .risky-rule:hover {
            background: #fecaca !important;
            transform: scale(1.01);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.2);
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }

        @keyframes shimmer {
            0% { background-position: -200px 0; }
            100% { background-position: calc(200px + 100%) 0; }
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateX(-30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* Loading animations */
        .loading {
            animation: pulse 1.5s ease-in-out infinite;
        }

        .spinning {
            animation: rotate 1s linear infinite;
        }

        /* Stagger animations for lists */
        .firewall-card:nth-child(1) { animation-delay: 0.1s; }
        .firewall-card:nth-child(2) { animation-delay: 0.2s; }
        .firewall-card:nth-child(3) { animation-delay: 0.3s; }
        .firewall-card:nth-child(4) { animation-delay: 0.4s; }
        .firewall-card:nth-child(5) { animation-delay: 0.5s; }
        .firewall-card:nth-child(6) { animation-delay: 0.6s; }

        /* Add Firewall Section */
        .add-firewall-section {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--gray-200);
            margin-bottom: 2rem;
            animation: slideInUp 0.8s ease-out;
        }
        
        /* Section Header (for other tabs without add firewall form) */
        .section-header {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--gray-200);
            margin-bottom: 2rem;
            animation: slideInUp 0.8s ease-out;
        }

        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .section-title::before {
            content: '';
            width: 4px;
            height: 20px;
            background: var(--primary-500);
            border-radius: 2px;
        }

        /* Form Styles */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-label {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--gray-700);
            margin-bottom: 0.5rem;
        }

        .form-input {
            padding: 0.75rem 1rem;
            border: 1px solid var(--gray-300);
            border-radius: 8px;
            font-size: 0.875rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: white;
            animation: fadeIn 0.5s ease-out;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-500);
            box-shadow: 0 0 0 3px var(--primary-100);
            transform: scale(1.02);
        }

        .form-input:hover {
            border-color: var(--gray-400);
            transform: translateY(-1px);
        }

        .form-help {
            font-size: 0.75rem;
            color: var(--gray-500);
            margin-top: 0.25rem;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-decoration: none;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn-primary {
            background: var(--primary-600);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-700);
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
        }

        .btn-primary:active {
            transform: translateY(0) scale(0.98);
        }

        .btn-secondary {
            background: white;
            color: var(--gray-700);
            border: 1px solid var(--gray-300);
        }

        .btn-secondary:hover {
            background: var(--gray-50);
            border-color: var(--gray-400);
            transform: translateY(-1px) scale(1.02);
        }

        .btn-success {
            background: var(--success-600);
            color: white;
        }

        .btn-success:hover {
            background: var(--success-600);
            opacity: 0.9;
        }

        .btn-warning {
            background: var(--warning-500);
            color: white;
        }

        .btn-danger {
            background: var(--error-600);
            color: white;
        }

        .btn-danger:hover {
            background: var(--error-600);
            opacity: 0.9;
        }

        /* Firewall Grid */
        .firewall-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        /* Compact Row Layout - All info on one line for 200+ firewalls */
        #wan-management-grid {
            display: block !important;
            grid-template-columns: none !important;
        }
        
        #wan-management-grid .firewall-card {
            max-width: none !important;
            width: 100% !important;
            margin-bottom: 0.5rem !important;
            min-height: auto !important;
        }
        
        #active-directory-grid,
        #ssl-vpn-grid,
        #vpn-simple-grid {
            display: block !important;
            grid-template-columns: none !important;
        }
        
        #active-directory-grid .firewall-card,
        #ssl-vpn-grid .firewall-card,
        #vpn-simple-grid .firewall-card {
            max-width: none !important;
            width: 100% !important;
            padding: 0.75rem 1rem !important;
            margin-bottom: 0.5rem !important;
            display: flex !important;
            align-items: center !important;
            gap: 1rem !important;
            min-height: auto !important;
        }
        
        /* Compact card header - horizontal layout */
        #active-directory-grid .firewall-header,
        #ssl-vpn-grid .firewall-header,
        #vpn-simple-grid .firewall-header {
            flex: 0 0 200px !important;
            margin-bottom: 0 !important;
            display: flex !important;
            align-items: center !important;
            gap: 0.75rem !important;
        }
        
        /* Compact card info - horizontal layout with better spacing */
        #active-directory-grid .firewall-info,
        #ssl-vpn-grid .firewall-info,
        #vpn-simple-grid .firewall-info {
            flex: 1 !important;
            display: flex !important;
            align-items: center !important;
            gap: 1rem !important;
            margin-bottom: 0 !important;
            flex-wrap: wrap !important;
            justify-content: flex-start !important;
        }
        
        /* Compact info items - inline with better spacing */
        #wan-management-grid .firewall-info-item,
        #active-directory-grid .firewall-info-item,
        #ssl-vpn-grid .firewall-info-item,
        #vpn-simple-grid .firewall-info-item {
            margin-bottom: 0 !important;
            display: flex !important;
            align-items: center !important;
            gap: 0.25rem !important;
            white-space: nowrap !important;
            flex-shrink: 0 !important;
            min-width: fit-content !important;
        }
        
        #wan-management-grid .firewall-info-label,
        #active-directory-grid .firewall-info-label,
        #ssl-vpn-grid .firewall-info-label,
        #vpn-simple-grid .firewall-info-label {
            font-size: 0.8rem !important;
            color: var(--gray-600) !important;
            margin-right: 0 !important;
        }
        
        #wan-management-grid .firewall-info-value,
        #active-directory-grid .firewall-info-value,
        #ssl-vpn-grid .firewall-info-value,
        #vpn-simple-grid .firewall-info-value {
            font-size: 0.85rem !important;
            font-weight: 600 !important;
        }
        
        /* Compact actions */
        #wan-management-grid .firewall-actions,
        #active-directory-grid .firewall-actions,
        #ssl-vpn-grid .firewall-actions,
        #vpn-simple-grid .firewall-actions {
            flex: 0 0 auto !important;
            margin-top: 0 !important;
        }

        /* Firewall Card */
        .firewall-card {
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: 12px;
            padding: 1.5rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            transform: translateY(0);
            animation: slideInUp 0.6s ease-out;
        }

        .firewall-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--gray-300);
        }

        .firewall-card.connected::before {
            background: var(--success-500);
        }

        .firewall-card.disconnected::before {
            background: var(--error-500);
        }

        .firewall-card.testing::before {
            background: var(--warning-500);
        }

        .firewall-card:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            border-color: var(--primary-500);
        }

        .firewall-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .firewall-ip {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--gray-900);
        }

        .firewall-status {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .status-connected {
            background: var(--success-50);
            color: var(--success-600);
            border: 1px solid var(--success-200);
            animation: pulse 2s infinite;
        }

        .status-disconnected {
            background: var(--error-50);
            color: var(--error-600);
            border: 1px solid var(--error-200);
            animation: fadeIn 0.5s ease-out;
        }

        .status-testing {
            background: var(--warning-50);
            color: var(--warning-600);
            border: 1px solid var(--warning-200);
            animation: bounce 1s infinite;
        }

        .firewall-info {
            margin-bottom: 1.5rem;
        }

        .firewall-info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--gray-100);
            font-size: 0.875rem;
        }

        .firewall-info-item:last-child {
            border-bottom: none;
        }

        .firewall-info-label {
            color: var(--gray-600);
            font-weight: 500;
        }

        .firewall-info-value {
            color: var(--gray-900);
            font-weight: 500;
        }

        .firewall-actions {
            display: flex;
            gap: 0.75rem;
        }

        .firewall-actions .btn {
            flex: 1;
            justify-content: center;
            font-size: 0.875rem;
            padding: 0.625rem 1rem;
        }

        /* Search and Filters */
        .search-filters {
            display: flex;
            gap: 1rem;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }


        .filter-select {
            padding: 0.75rem 1rem;
            border: 1px solid var(--gray-300);
            border-radius: 8px;
            font-size: 0.875rem;
            background: white;
            min-width: 150px;
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
            margin-top: 2rem;
        }

        .pagination button {
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--gray-300);
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s;
            color: var(--gray-700);
        }

        .pagination button:hover:not(:disabled) {
            background: var(--gray-50);
            border-color: var(--gray-400);
        }

        .pagination button.active {
            background: var(--primary-600);
            color: white;
            border-color: var(--primary-600);
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Alerts */
        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-size: 0.875rem;
            font-weight: 500;
            border: 1px solid;
            animation: slideInUp 0.5s ease-out, pulse 0.5s ease-out 0.5s;
            transition: all 0.3s ease;
        }

        .alert-success {
            background: var(--success-50);
            color: var(--success-700);
            border-color: var(--success-200);
        }

        .alert-error {
            background: var(--error-50);
            color: var(--error-700);
            border-color: var(--error-200);
        }

        .alert-warning {
            background: var(--warning-50);
            color: var(--warning-700);
            border-color: var(--warning-200);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            background: white;
            border-radius: 12px;
            border: 1px solid var(--gray-200);
        }

        .empty-state-icon {
            width: 64px;
            height: 64px;
            margin: 0 auto 1rem;
            background: var(--gray-100);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: var(--gray-400);
        }

        .empty-state h3 {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: 0.5rem;
        }

        .empty-state p {
            color: var(--gray-600);
            margin-bottom: 1.5rem;
        }

        /* Users Sub-tabs */
        .users-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            border-bottom: 2px solid var(--gray-200);
            padding-bottom: 0;
        }

        .users-tab-btn {
            padding: 0.75rem 1.5rem;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            color: var(--gray-600);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.95rem;
        }

        .users-tab-btn:hover {
            color: var(--primary-600);
            background: var(--gray-50);
        }

        .users-tab-btn.active {
            color: var(--primary-600);
            border-bottom-color: var(--primary-600);
            font-weight: 600;
        }

        .users-subsection {
            animation: fadeIn 0.3s ease;
        }

        /* Users Summary Cards */
        .global-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid var(--gray-200);
            box-shadow: var(--shadow-sm);
            text-align: center;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .stat-card.critical {
            border-color: var(--danger-300);
            background: linear-gradient(135deg, #fff 0%, #fef2f2 100%);
        }

        .stat-card.warning {
            border-color: var(--warning-300);
            background: linear-gradient(135deg, #fff 0%, #fffbeb 100%);
        }

        .stat-card.info {
            border-color: var(--primary-300);
            background: linear-gradient(135deg, #fff 0%, #eff6ff 100%);
        }

        .stat-card h3 {
            font-size: 2.5rem;
            font-weight: 700;
            margin: 0;
            margin-bottom: 0.5rem;
        }

        .stat-card.critical h3 {
            color: var(--danger-600);
        }

        .stat-card.warning h3 {
            color: var(--warning-600);
        }

        .stat-card.info h3 {
            color: var(--primary-600);
        }

        .stat-card p {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--gray-700);
            margin: 0;
            margin-bottom: 0.25rem;
        }

        .stat-card small {
            font-size: 0.8rem;
            color: var(--gray-500);
        }

        /* User Table Styles */
        .users-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }

        .users-table th {
            background: var(--gray-50);
            padding: 0.75rem 1rem;
            text-align: left;
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--gray-700);
            border-bottom: 2px solid var(--gray-200);
        }

        .users-table td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--gray-100);
            font-size: 0.9rem;
        }

        .users-table tr:hover {
            background: var(--gray-50);
        }

        .users-table input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .actions-bar {
            display: flex;
            gap: 0.75rem;
            align-items: center;
            padding: 1rem;
            background: var(--gray-50);
            border-radius: 8px;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .actions-bar label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
            color: var(--gray-700);
            cursor: pointer;
        }

        .actions-bar .btn {
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
        }

        /* Firewall Accordion for Users */
        /* Module Sub-menu styles */
        .module-submenu {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid var(--gray-200);
            padding-bottom: 0.5rem;
        }

        .submenu-btn {
            background: var(--gray-100);
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--gray-900) !important;
        }

        .submenu-btn:hover {
            background: var(--gray-200);
            transform: translateY(-1px);
        }

        .submenu-btn.active {
            background: var(--primary-color);
            color: white;
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
        }

        .submenu-btn .submenu-icon {
            font-size: 1rem;
            color: var(--gray-900) !important;
        }

        .submenu-content {
            display: none;
        }

        .submenu-content.active {
            display: block;
        }

        .firewall-user-accordion {
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: 12px;
            margin-bottom: 1rem;
            overflow: hidden;
            animation: slideInUp 0.3s ease;
        }

        .firewall-user-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 1.5rem;
            background: var(--gray-50);
            cursor: pointer;
            transition: background 0.2s ease;
            border-bottom: 1px solid var(--gray-200);
        }

        .firewall-user-header:hover {
            background: var(--gray-100);
        }

        .firewall-user-header .fw-name {
            font-weight: 600;
            font-size: 1rem;
            color: var(--gray-900);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .firewall-user-header .arrow {
            transition: transform 0.3s ease;
            font-size: 1.2rem;
            color: var(--gray-500);
        }

        .firewall-user-header.open .arrow {
            transform: rotate(180deg);
        }

        .firewall-user-content {
            padding: 1.5rem;
            display: none;
        }

        .firewall-user-content.open {
            display: block;
        }

        /* 2FA Section */
        .tfa-section {
            display: none;
            margin-top: 1rem;
            padding: 1rem;
            background: var(--warning-50);
            border: 1px solid var(--warning-200);
            border-radius: 8px;
        }

        .tfa-section.show {
            display: block;
        }

        /* Loading States */
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .spinner {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border: 2px solid var(--gray-300);
            border-radius: 50%;
            border-top-color: var(--primary-600);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s;
            }
            
            .sidebar.open {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .firewall-grid {
                grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            }
            
            /* Responsive compact layout for tablets */
            #wan-management-grid .firewall-info,
            #active-directory-grid .firewall-info,
            #ssl-vpn-grid .firewall-info {
                gap: 1rem !important;
            }
            
            #wan-management-grid .firewall-info-item,
            #active-directory-grid .firewall-info-item,
            #ssl-vpn-grid .firewall-info-item {
                gap: 0.2rem !important;
            }
        }

        @media (max-width: 768px) {
            .header-stats {
                flex-direction: column;
                gap: 1rem;
            }
            
            .search-filters {
                flex-direction: column;
                align-items: stretch;
            }
            
            
            .firewall-grid {
                grid-template-columns: 1fr;
            }
            
            /* Mobile: wrap info items for small screens */
            #wan-management-grid .firewall-info,
            #active-directory-grid .firewall-info,
            #ssl-vpn-grid .firewall-info {
                flex-wrap: wrap !important;
                gap: 0.75rem !important;
            }
            
            #wan-management-grid .firewall-header,
            #active-directory-grid .firewall-header,
            #ssl-vpn-grid .firewall-header {
                flex: 0 0 150px !important;
            }
        }

        /* Copyright */
        .copyright {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            font-size: 0.75rem;
            color: var(--gray-500);
            background: white;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            border: 1px solid var(--gray-200);
            box-shadow: var(--shadow-sm);
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            z-index: 1000;
            animation: fadeIn 0.3s ease-out;
        }

        .modal-overlay.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideInUp 0.3s ease-out;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--gray-900);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray-500);
            transition: color 0.2s;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
        }

        .modal-close:hover {
            color: var(--gray-900);
            background: var(--gray-100);
        }

        /* Security Score Circle */
        .security-score-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }

        .security-score-circle {
            width: 70px;
            height: 70px;
            position: relative;
        }

        .security-score-svg {
            transform: rotate(-90deg);
            width: 100%;
            height: 100%;
        }

        .security-score-bg {
            fill: none;
            stroke: var(--gray-200);
            stroke-width: 6;
        }

        .security-score-progress {
            fill: none;
            stroke-width: 6;
            stroke-linecap: round;
            transition: stroke-dashoffset 0.5s ease, stroke 0.3s ease;
        }

        .security-score-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .security-score-value {
            font-size: 1.25rem;
            font-weight: 700;
            line-height: 1;
        }

        .security-score-label {
            font-size: 0.65rem;
            color: var(--gray-600);
            text-transform: uppercase;
            font-weight: 600;
        }

        .security-score-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-align: center;
            white-space: nowrap;
        }

        .score-critical {
            background: #fee2e2;
            color: #991b1b;
        }

        .score-warning {
            background: #fef3c7;
            color: #92400e;
        }

        .score-good {
            background: #dcfce7;
            color: #166534;
        }

        /* Modal Styles - Modern Clean Design */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            z-index: 10000;
            overflow-y: auto;
            padding: 2rem;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            animation: backdropFadeIn 0.3s ease-out;
        }

        @keyframes backdropFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: white;
            border-radius: 24px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            width: 100%;
            max-width: 1200px;
            position: relative;
            animation: modalSlideIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes modalSlideIn {
            from {
                transform: translateY(-50px) scale(0.95);
                opacity: 0;
            }
            to {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }

        .modal-header {
            padding: 2rem 2.5rem;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, var(--primary-50), var(--gray-50));
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.75rem;
            background: linear-gradient(135deg, var(--primary-600), var(--primary-500));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 700;
        }

        .modal-body {
            padding: 2rem 2.5rem;
            background: var(--gray-50);
        }

        .modal-close {
            background: var(--gray-100);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1.5rem;
            line-height: 1;
            color: var(--gray-600);
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            background: var(--error-100);
            color: var(--error-600);
            transform: rotate(90deg);
        }

        /* Dashboard Module Cards - Modern Clean */
        .dashboard-module-card {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            border: 2px solid var(--gray-200);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .dashboard-module-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, transparent, var(--module-color), transparent);
            animation: shimmer 3s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .dashboard-module-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px -8px rgba(59, 130, 246, 0.2);
            border-color: var(--primary-300);
        }

        /* CSS Variables for consistent colors */
        :root {
            --primary-50: #eff6ff;
            --primary-100: #dbeafe;
            --primary-200: #bfdbfe;
            --primary-300: #93c5fd;
            --primary-400: #60a5fa;
            --primary-500: #3b82f6;
            --primary-600: #2563eb;
            --primary-700: #1d4ed8;
            --primary-800: #1e40af;
            --primary-900: #1e3a8a;
            
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            
            --success-50: #ecfdf5;
            --success-100: #d1fae5;
            --success-200: #a7f3d0;
            --success-600: #059669;
            
            --error-50: #fef2f2;
            --error-100: #fee2e2;
            --error-200: #fecaca;
            --error-600: #dc2626;
        }

        /* Animation for module cards */
        @keyframes cardFadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Spinner animation for loader */
        @keyframes spin {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }

        /* Analytics Styles */
        .analytics-scoreboard,
        .analytics-charts,
        .analytics-modules,
        .analytics-ranking {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--gray-200);
        }

        .global-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--primary-50), var(--gray-50));
            border-radius: 12px;
            padding: 1.5rem;
            border: 2px solid var(--gray-200);
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--card-color);
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--gray-800);
            margin: 0.5rem 0;
        }

        .stat-label {
            font-size: 0.9rem;
            color: var(--gray-600);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }

        .stat-trend {
            font-size: 0.85rem;
            color: var(--gray-500);
            margin-top: 0.5rem;
        }

        .chart-container {
            min-height: 400px;
            background: var(--gray-50);
            border-radius: 12px;
            padding: 1.5rem;
        }

        .module-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .module-stat-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            border: 2px solid var(--gray-200);
            text-align: center;
            transition: all 0.3s;
        }

        .module-stat-card:hover {
            border-color: var(--primary-300);
            transform: translateY(-2px);
        }

        .module-stat-value {
            font-size: 2rem;
            font-weight: 700;
            margin: 0.5rem 0;
        }

        .ranking-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .ranking-item {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            border: 2px solid var(--gray-200);
            display: flex;
            align-items: center;
            gap: 1.5rem;
            transition: all 0.3s;
        }

        .ranking-item:hover {
            border-color: var(--primary-300);
            transform: translateX(4px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .ranking-position {
            font-size: 2rem;
            font-weight: 800;
            color: var(--gray-400);
            min-width: 50px;
            text-align: center;
        }

        .ranking-position.top-3 {
            background: linear-gradient(135deg, #f59e0b, #f97316);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .ranking-firewall-info {
            flex: 1;
        }

        .ranking-firewall-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--gray-800);
            margin-bottom: 0.25rem;
        }

        .ranking-firewall-ip {
            font-size: 0.85rem;
            color: var(--gray-500);
        }

        .ranking-score-container {
            min-width: 80px;
        }

        .bar-chart {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .bar-chart-item {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .bar-label {
            min-width: 150px;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--gray-700);
        }

        .bar-container {
            flex: 1;
            height: 32px;
            background: var(--gray-200);
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }

        .bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--bar-start-color), var(--bar-end-color));
            border-radius: 8px;
            transition: width 1s ease-out;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 0.75rem;
            color: white;
            font-weight: 600;
            font-size: 0.85rem;
        }

        .bar-value {
            min-width: 60px;
            text-align: right;
            font-weight: 700;
            color: var(--gray-700);
        }

        /* Custom Scrollbar for Analytics */
        .bar-chart::-webkit-scrollbar,
        .ranking-list > div::-webkit-scrollbar {
            width: 8px;
        }

        .bar-chart::-webkit-scrollbar-track,
        .ranking-list > div::-webkit-scrollbar-track {
            background: var(--gray-100);
            border-radius: 4px;
        }

        .bar-chart::-webkit-scrollbar-thumb,
        .ranking-list > div::-webkit-scrollbar-thumb {
            background: var(--primary-300);
            border-radius: 4px;
        }

        .bar-chart::-webkit-scrollbar-thumb:hover,
        .ranking-list > div::-webkit-scrollbar-thumb:hover {
            background: var(--primary-400);
        }

        /* Language Selector */
        .language-selector {
            position: relative;
        }

        #language-select {
            padding: 0.5rem 1rem;
            border: 2px solid var(--primary-200);
            border-radius: 8px;
            background: white;
            color: var(--gray-700);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
        }

        #language-select:hover {
            border-color: var(--primary-400);
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.1);
        }

        #language-select:focus {
            outline: none;
            border-color: var(--primary-500);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .header-content {
            display: flex;
            align-items: center;
            gap: 2rem;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <div class="logo-icon"></div>
                    <div class="logo-text">SonicWall Backup Incident Manager</div>
                </div>
            </div>
            
            <div class="sidebar-nav">
                <a href="#" class="nav-item active" data-tab="firewalls">
                    <span class="nav-icon"></span>
                    Firewalls
                </a>
                <a href="#" class="nav-item" data-tab="wan-management">
                    <span class="nav-icon"></span>
                    WAN Management
                </a>
                
                <!-- Users Parent Group -->
                <div class="nav-group">
                    <div class="nav-group-header" onclick="toggleUsersMenu()">
                        <span class="nav-icon"></span>
                        <span>Users</span>
                        <span class="nav-arrow" id="users-arrow"></span>
                    </div>
                    <div class="nav-group-items" id="users-submenu">
                        <a href="#" class="nav-item nav-subitem" data-tab="local-users">
                            <span class="nav-icon"></span>
                            LOCAL Users
                        </a>
                        <a href="#" class="nav-item nav-subitem" data-tab="ldap">
                            <span class="nav-icon"></span>
                            LDAP
                        </a>
                        <a href="#" class="nav-item nav-subitem" data-tab="radius">
                            <span class="nav-icon"></span>
                            RADIUS
                        </a>
                        <a href="#" class="nav-item nav-subitem" data-tab="tacacs">
                            <span class="nav-icon"></span>
                            TACACS+
                        </a>
                        <a href="#" class="nav-item nav-subitem" data-tab="sso">
                            <span class="nav-icon"></span>
                            SSO
                        </a>
                    </div>
                </div>
                
                <a href="#" class="nav-item" data-tab="ipsec-vpn">
                    <span class="nav-icon"></span>
                    IPSEC VPN
                </a>
                <a href="#" class="nav-item" data-tab="ssl-vpn">
                    <span class="nav-icon"></span>
                    SSL VPN
                </a>
                <a href="#" class="nav-item" data-tab="pppoe-pptp-l2tp">
                    <span class="nav-icon"></span>
                    PPPoE/PPTP/L2TP
                </a>
                <a href="#" class="nav-item" data-tab="cse">
                    <span class="nav-icon"></span>
                    CSE
                </a>
                
                <!-- Analytics Section (Separated) -->
                <div class="nav-divider" style="margin: 1rem 0; border-top: 1px solid var(--gray-200);"></div>
                <a href="#" class="nav-item" data-tab="analytics" style="background: linear-gradient(135deg, var(--primary-50), var(--success-50));">
                    <span class="nav-icon"></span>
                    Analytics
                </a>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Disclaimer Banner -->
            <div class="disclaimer-banner" id="disclaimer-banner">
                <div class="disclaimer-content">
                    <div class="disclaimer-main">
                        <div class="disclaimer-icon"></div>
                        <div class="disclaimer-text">
                            <strong>Disclaimer:</strong> This is NOT an official SonicWall tool. This application is provided as-is for management purposes only. 
                            The user assumes all responsibility for its use. Always follow security best practices and backup your configurations.
                            <br>
                            <span style="font-size: 0.85rem; margin-top: 0.5rem; display: block;">
                                 For issues or feature requests, contact <strong>Guillaume SEVRIN</strong>
                            </span>
                        </div>
                    </div>
                    <button class="disclaimer-toggle" onclick="toggleDisclaimer()" id="disclaimer-toggle" title="Collapse disclaimer"></button>
                </div>
            </div>

            <!-- Header -->
            <header class="header">
                <div class="header-content">
                    <h1 class="header-title" data-i18n="header.title">Firewall Management</h1>
                    <div class="language-selector">
                        <select id="language-select" onchange="changeLanguage(this.value)">
                            <option value="en"> English</option>
                            <option value="fr"> Franais</option>
                            <option value="es"> Espaol</option>
                            <option value="it"> Italiano</option>
                        </select>
                    </div>
                    <div class="header-stats">
                        <div class="stat-item">
                            <div class="stat-number" id="total-firewalls">0</div>
                            <div class="stat-label">Total</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="connected-firewalls">0</div>
                            <div class="stat-label">Connected</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="disconnected-firewalls">0</div>
                            <div class="stat-label">Disconnected</div>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Global Search Bar -->
            <div class="global-search-container">
                <div class="global-search-wrapper">
                    <span class="global-search-icon"></span>
                    <input 
                        type="text" 
                        id="global-search-input" 
                        class="global-search-input" 
                        placeholder="Search firewalls by name, IP, or configuration..."
                        autocomplete="off"
                    >
                    <button id="global-search-clear" class="global-search-clear" title="Clear search"></button>
                    
                    <!-- Search Results Dropdown -->
                    <div id="search-results-dropdown" class="search-results-dropdown"></div>
                </div>
            </div>

            <!-- Content -->
            <div class="content">
                <!-- Firewalls Section -->
                <section id="firewalls-section">
                    <!-- Add Firewall Section -->
                    <div class="add-firewall-section">
                        <h2 class="section-title">Add New Firewall</h2>
                        <div id="alert-container"></div>
                        
                        <form id="add-firewall-form">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label" for="firewall-name">Firewall Name</label>
                                    <input type="text" id="firewall-name" class="form-input" placeholder="HQ-Firewall-01" required>
                                    <div class="form-help">Friendly name for this firewall</div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label" for="firewall-ip">IP Address</label>
                                    <input type="text" id="firewall-ip" class="form-input" placeholder="192.168.1.1:443" required>
                                    <div class="form-help">Include port if needed (ex: 192.168.1.1:8443)</div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label" for="firewall-username">Username</label>
                                    <input type="text" id="firewall-username" class="form-input" placeholder="admin" required>
                                </div>

                                <div class="form-group">
                                    <label class="form-label" for="firewall-password">Password</label>
                                    <input type="password" id="firewall-password" class="form-input" required>
                                </div>

                                <div class="form-group">
                                    <label class="form-label" for="firewall-otp">OTP Code (Optional)</label>
                                    <input type="text" id="firewall-otp" class="form-input" placeholder="123456" maxlength="6" pattern="\d{6}">
                                    <div class="form-help">Enter your OTP/2FA code if enabled (6 digits)</div>
                                </div>
                            </div>

                            <div style="margin-top: 1.5rem;">
                                <button type="submit" class="btn btn-primary">
                                    <span></span> Add Firewall
                                </button>
                            </div>
                        </form>
                    </div>
                    <!-- Filters -->
                    <div class="search-filters">
                        <select id="status-filter" class="filter-select">
                            <option value="">All Status</option>
                            <option value="connected">Connected</option>
                            <option value="disconnected">Disconnected</option>
                            <option value="testing">Testing</option>
                        </select>
                        <button class="btn btn-secondary" onclick="refreshAllFirewalls()">
                            <span></span> Refresh All
                        </button>
                        <button class="btn btn-danger" onclick="clearAllFirewalls()">
                            <span></span> Clear All
                        </button>
                    </div>

                    <!-- Firewall Grid -->
                    <div class="firewall-grid" id="firewall-grid">
                        <div class="empty-state">
                            <div class="empty-state-icon"></div>
                            <h3>No firewalls added</h3>
                            <p>Add your first firewall using the form above</p>
                        </div>
                    </div>

                    <!-- Pagination -->
                    <div class="pagination" id="pagination" style="display: none;">
                        <button id="prev-page" onclick="changePage(-1)"> Previous</button>
                        <div id="page-numbers"></div>
                        <button id="next-page" onclick="changePage(1)">Next </button>
                    </div>
                </section>

                <!-- WAN Management Section -->
                <section id="wan-management-section" style="display: none;">
                    <div class="section-header">
                        <h2 class="section-title">WAN Management</h2>
                        <p style="color: var(--gray-600); margin-bottom: 2rem;">WAN-to-WAN management rules and security remediation</p>
                        
                        <!-- WAN Management Sub-menu -->
                        <div class="module-submenu">
                            <button class="submenu-btn active" data-submenu="monitoring" onclick="switchWANSubmenu('monitoring')">
                                <span class="submenu-icon"></span>
                                Monitoring
                            </button>
                            <button class="submenu-btn" data-submenu="remediation" onclick="switchWANSubmenu('remediation')">
                                <span class="submenu-icon"></span>
                                Remediation
                            </button>
                        </div>
                        
                        <div id="wan-alert-container"></div>

                        <!-- Monitoring View -->
                        <div id="wan-monitoring" class="submenu-content active">
                            <div style="margin-bottom: 1rem;">
                                <input 
                                    type="text" 
                                    id="wan-search" 
                                    placeholder=" Rechercher un firewall..." 
                                    oninput="filterAccordions('wan-management-grid', this.value)"
                                    style="
                                        width: 100%;
                                        padding: 0.75rem 1rem;
                                        border: 1px solid var(--gray-300);
                                        border-radius: 8px;
                                        font-size: 0.95rem;
                                    "
                                >
                            </div>

                            <div class="firewall-grid" id="wan-management-grid">
                                <div class="empty-state">
                                    <div class="empty-state-icon"></div>
                                    <h3>No WAN Management Data</h3>
                                    <p>Loading WAN management configuration automatically...</p>
                                </div>
                            </div>
                        </div>

                        <!-- Remediation View -->
                        <div id="wan-remediation" class="submenu-content">
                            <div style="margin-bottom: 1.5rem; padding: 1rem; background: #dbeafe; border-left: 4px solid #3b82f6; border-radius: 8px;">
                                <strong style="color: #1e40af;"> Note importante sur la remediation WAN Management</strong>
                                <p style="margin: 0.5rem 0 0 0; font-size: 0.9rem; color: var(--gray-700);">
                                    Suite  la compromission des backups SonicWall, les rgles WAN-to-WAN avec <strong>source ANY</strong> doivent tre scurises. 
                                    Vous devrez crer un <strong>objet address IPv4</strong> avec votre IP publique et remplacer la source ANY dans les rgles  risque.
                                </p>
                            </div>
                            <div id="wan-remediation-grid">
                                <div class="empty-state">
                                    <div class="empty-state-icon"></div>
                                    <h3>WAN Management Remediation</h3>
                                    <p>Loading remediation data...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- LOCAL Users Section -->
                <section id="local-users-section" style="display: none;">
                    <div class="section-header">
                        <h2 class="section-title">LOCAL Users</h2>
                        <p style="color: var(--gray-600); margin-bottom: 2rem;">Local user accounts and TOTP security status</p>
                        
                        <!-- LOCAL Users Sub-menu -->
                        <div class="module-submenu">
                            <button class="submenu-btn active" data-submenu="monitoring" onclick="switchLocalUsersSubmenu('monitoring')">
                                <span class="submenu-icon"></span>
                                Monitoring
                            </button>
                            <button class="submenu-btn" data-submenu="remediation" onclick="switchLocalUsersSubmenu('remediation')">
                                <span class="submenu-icon"></span>
                                Remediation
                            </button>
                        </div>
                        
                        <div id="local-alert-container"></div>

                        <!-- Monitoring View -->
                        <div id="local-users-monitoring" class="submenu-content active">
                            <div style="margin-bottom: 1rem;">
                                <input 
                                    type="text" 
                                    id="local-users-search" 
                                    placeholder=" Rechercher un firewall ou utilisateur..." 
                                    oninput="filterAccordions('local-users-grid', this.value)"
                                    style="
                                        width: 100%;
                                        padding: 0.75rem 1rem;
                                        border: 1px solid var(--gray-300);
                                        border-radius: 8px;
                                        font-size: 0.95rem;
                                    "
                                >
                            </div>
                            <div id="local-users-grid">
                                <div class="empty-state">
                                    <div class="empty-state-icon"></div>
                                    <h3>No Local Users Data</h3>
                                    <p>Loading local users automatically...</p>
                                </div>
                            </div>
                        </div>

                        <!-- Remediation View -->
                        <div id="local-users-remediation" class="submenu-content">
                            <div style="margin-bottom: 1.5rem; padding: 1rem; background: #dbeafe; border-left: 4px solid #3b82f6; border-radius: 8px;">
                                <strong style="color: #1e40af;"> Note importante sur la remediation</strong>
                                <p style="margin: 0.5rem 0 0 0; font-size: 0.9rem; color: var(--gray-700);">
                                    Pour viter toute dsynchronisation avec le firewall, le <strong>compte admin principal</strong> (utilis pour l'accs API) 
                                    <strong>n'est pas inclus</strong> dans le changement de mot de passe forc. Seuls les autres utilisateurs (admin secondaires et utilisateurs gnraux) 
                                    seront affects par cette action.
                                </p>
                            </div>
                            <div id="local-users-remediation-grid">
                                <div class="empty-state">
                                    <div class="empty-state-icon"></div>
                                    <h3>Local Users Remediation</h3>
                                    <p>Select a firewall to perform remediation actions</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- LDAP Section -->
                <section id="ldap-section" style="display: none;">
                    <div class="section-header">
                        <h2 class="section-title">LDAP / Active Directory Configuration</h2>
                        <p style="color: var(--gray-600); margin-bottom: 2rem;">LDAP/AD bind passwords and authentication settings</p>
                        
                        <!-- LDAP Sub-menu -->
                        <div class="module-submenu">
                            <button class="submenu-btn active" data-submenu="monitoring" onclick="switchLDAPSubmenu('monitoring')">
                                <span class="submenu-icon"></span>
                                Monitoring
                            </button>
                            <button class="submenu-btn" data-submenu="remediation" onclick="switchLDAPSubmenu('remediation')">
                                <span class="submenu-icon"></span>
                                Remediation
                            </button>
                        </div>
                        
                        <div id="ldap-alert-container"></div>

                        <!-- Monitoring View -->
                        <div id="ldap-monitoring" class="submenu-content active">
                            <div style="margin-bottom: 1rem;">
                                <input 
                                    type="text" 
                                    id="ldap-search" 
                                    placeholder=" Rechercher un firewall..." 
                                    oninput="filterAccordions('ldap-grid', this.value)"
                                    style="
                                        width: 100%;
                                        padding: 0.75rem 1rem;
                                        border: 1px solid var(--gray-300);
                                        border-radius: 8px;
                                        font-size: 0.95rem;
                                    "
                                >
                            </div>
                            <div id="ldap-grid">
                                <div class="empty-state">
                                    <div class="empty-state-icon"></div>
                                    <h3>No LDAP Data</h3>
                                    <p>Loading LDAP configuration automatically...</p>
                                </div>
                            </div>
                        </div>

                        <!-- Remediation View -->
                        <div id="ldap-remediation" class="submenu-content">
                            <div style="margin-bottom: 1.5rem; padding: 1rem; background: #dbeafe; border-left: 4px solid #3b82f6; border-radius: 8px;">
                                <strong style="color: #1e40af;"> Note importante sur la remediation LDAP</strong>
                                <p style="margin: 0.5rem 0 0 0; font-size: 0.9rem; color: var(--gray-700);">
                                    Suite  la compromission des backups SonicWall, le <strong>bind password LDAP</strong> doit tre chang. 
                                    Vous pourrez configurer un <strong>nouveau bind user et mot de passe</strong> qui sera appliqu sur le firewall et sauvegard en base de donnes.
                                </p>
                            </div>
                            <div id="ldap-remediation-grid">
                                <div class="empty-state">
                                    <div class="empty-state-icon"></div>
                                    <h3>LDAP Remediation</h3>
                                    <p>Select a firewall to perform remediation actions</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- RADIUS Section -->
                <section id="radius-section" style="display: none;">
                    <div class="section-header">
                        <h2 class="section-title">RADIUS Configuration</h2>
                        <p style="color: var(--gray-600); margin-bottom: 2rem;">RADIUS authentication and accounting servers</p>
                        
                        <!-- RADIUS Sub-menu -->
                        <div class="module-submenu">
                            <button class="submenu-btn active" data-submenu="monitoring" onclick="switchRADIUSSubmenu('monitoring')">
                                <span class="submenu-icon"></span>
                                Monitoring
                            </button>
                            <button class="submenu-btn" data-submenu="remediation" onclick="switchRADIUSSubmenu('remediation')">
                                <span class="submenu-icon"></span>
                                Remediation
                            </button>
                        </div>
                        
                        <div id="radius-alert-container"></div>

                        <!-- Monitoring View -->
                        <div id="radius-monitoring" class="submenu-content active">
                            <div style="margin-bottom: 1rem;">
                                <input 
                                    type="text" 
                                    id="radius-search" 
                                    placeholder=" Rechercher un firewall ou serveur..." 
                                    oninput="filterAccordions('radius-grid', this.value)"
                                    style="
                                        width: 100%;
                                        padding: 0.75rem 1rem;
                                        border: 1px solid var(--gray-300);
                                        border-radius: 8px;
                                        font-size: 0.95rem;
                                    "
                                >
                            </div>
                            
                            <div id="radius-grid">
                                <div class="empty-state">
                                    <div class="empty-state-icon"></div>
                                    <h3>No RADIUS Data</h3>
                                    <p>Loading RADIUS configuration automatically...</p>
                                </div>
                            </div>
                        </div>

                        <!-- Remediation View -->
                        <div id="radius-remediation" class="submenu-content">
                            <div style="margin-bottom: 1.5rem; padding: 1rem; background: #dbeafe; border-left: 4px solid #3b82f6; border-radius: 8px;">
                                <strong style="color: #1e40af;"> Note importante sur la remediation RADIUS</strong>
                                <p style="margin: 0.5rem 0 0 0; font-size: 0.9rem; color: var(--gray-700);">
                                    Suite  la compromission des backups SonicWall, les <strong>shared secrets RADIUS</strong> doivent tre changs. 
                                    Vous pourrez configurer de <strong>nouveaux shared secrets</strong> pour chaque serveur RADIUS.
                                </p>
                            </div>
                            <div id="radius-remediation-grid">
                                <div class="empty-state">
                                    <div class="empty-state-icon"></div>
                                    <h3>RADIUS Remediation</h3>
                                    <p>Select a firewall to perform remediation actions</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- TACACS+ Section -->
                <section id="tacacs-section" style="display: none;">
                    <div class="section-header">
                        <h2 class="section-title">TACACS+ Configuration</h2>
                        <p style="color: var(--gray-600); margin-bottom: 2rem;">TACACS+ authentication and accounting servers</p>
                        
                        <!-- TACACS+ Sub-menu -->
                        <div class="module-submenu">
                            <button class="submenu-btn active" data-submenu="monitoring" onclick="switchTACACSSubmenu('monitoring')">
                                <span class="submenu-icon"></span>
                                Monitoring
                            </button>
                            <button class="submenu-btn" data-submenu="remediation" onclick="switchTACACSSubmenu('remediation')">
                                <span class="submenu-icon"></span>
                                Remediation
                            </button>
                        </div>
                        
                        <div id="tacacs-alert-container"></div>

                        <!-- Monitoring View -->
                        <div id="tacacs-monitoring" class="submenu-content active">
                            <div style="margin-bottom: 1rem;">
                                <input 
                                    type="text" 
                                    id="tacacs-search" 
                                    placeholder=" Rechercher un firewall ou serveur..." 
                                    oninput="filterAccordions('tacacs-grid', this.value)"
                                    style="
                                        width: 100%;
                                        padding: 0.75rem 1rem;
                                        border: 1px solid var(--gray-300);
                                        border-radius: 8px;
                                        font-size: 0.95rem;
                                    "
                                >
                            </div>
                            
                            <div id="tacacs-grid">
                                <div class="empty-state">
                                    <div class="empty-state-icon"></div>
                                    <h3>No TACACS+ Data</h3>
                                    <p>Loading TACACS+ configuration automatically...</p>
                                </div>
                            </div>
                        </div>

                        <!-- Remediation View -->
                        <div id="tacacs-remediation" class="submenu-content">
                            <div style="margin-bottom: 1.5rem; padding: 1rem; background: #dbeafe; border-left: 4px solid #3b82f6; border-radius: 8px;">
                                <strong style="color: #1e40af;"> Note importante sur la remediation TACACS+</strong>
                                <p style="margin: 0.5rem 0 0 0; font-size: 0.9rem; color: var(--gray-700);">
                                    Suite  la compromission des backups SonicWall, les <strong>shared secrets TACACS+</strong> doivent tre changs. 
                                    Vous pourrez configurer de <strong>nouveaux shared secrets</strong> pour chaque serveur TACACS+.
                                </p>
                            </div>
                            <div id="tacacs-remediation-grid">
                                <div class="empty-state">
                                    <div class="empty-state-icon"></div>
                                    <h3>TACACS+ Remediation</h3>
                                    <p>Select a firewall to perform remediation actions</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- SSO Section -->
                <section id="sso-section" style="display: none;">
                    <div class="section-header">
                        <h2 class="section-title">SSO Configuration</h2>
                        <p style="color: var(--gray-600); margin-bottom: 2rem;">SSO agents, Terminal Services and RADIUS accounting clients</p>
                        
                        <!-- SSO Sub-menu -->
                        <div class="module-submenu">
                            <button class="submenu-btn active" data-submenu="monitoring" onclick="switchSSOSubmenu('monitoring')">
                                <span class="submenu-icon"></span>
                                Monitoring
                            </button>
                            <button class="submenu-btn" data-submenu="remediation" onclick="switchSSOSubmenu('remediation')">
                                <span class="submenu-icon"></span>
                                Remediation
                            </button>
                        </div>
                        
                        <div id="sso-alert-container"></div>

                        <!-- Monitoring View -->
                        <div id="sso-monitoring" class="submenu-content active">
                            <div style="margin-bottom: 1rem;">
                                <input 
                                    type="text" 
                                    id="sso-search" 
                                    placeholder=" Rechercher un firewall ou agent..." 
                                    oninput="filterAccordions('sso-grid', this.value)"
                                    style="
                                        width: 100%;
                                        padding: 0.75rem 1rem;
                                        border: 1px solid var(--gray-300);
                                        border-radius: 8px;
                                        font-size: 0.95rem;
                                    "
                                >
                            </div>
                            
                            <div id="sso-grid">
                                <div class="empty-state">
                                    <div class="empty-state-icon"></div>
                                    <h3>No SSO Data</h3>
                                    <p>Loading SSO configuration automatically...</p>
                                </div>
                            </div>
                        </div>

                        <!-- Remediation View -->
                        <div id="sso-remediation" class="submenu-content">
                            <div style="margin-bottom: 1.5rem; padding: 1rem; background: #dbeafe; border-left: 4px solid #3b82f6; border-radius: 8px;">
                                <strong style="color: #1e40af;"> Note importante sur la remediation SSO</strong>
                                <p style="margin: 0.5rem 0 0 0; font-size: 0.9rem; color: var(--gray-700);">
                                    Suite  la compromission des backups SonicWall, les <strong>shared keys SSO</strong> doivent tre changs. 
                                    Vous devez changer les shared keys pour <strong>tous les types d'agents configurs</strong> (SSO Agent, TS Agent, RADIUS Acct).
                                </p>
                            </div>
                            <div id="sso-remediation-grid">
                                <div class="empty-state">
                                    <div class="empty-state-icon"></div>
                                    <h3>SSO Remediation</h3>
                                    <p>Select a firewall to perform remediation actions</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- IPSEC VPN Section -->
                <section id="ipsec-vpn-section" style="display: none;">
                    <div class="section-header">
                        <h2 class="section-title">IPSEC VPN Tunnels</h2>
                        <p style="color: var(--gray-600); margin-bottom: 2rem;">Site-to-site VPN tunnels with aggressive mode detection and security remediation</p>
                        
                        <!-- IPSEC VPN Sub-menu -->
                        <div class="module-submenu">
                            <button class="submenu-btn active" data-submenu="monitoring" onclick="switchIPSECSubmenu('monitoring')">
                                <span class="submenu-icon"></span>
                                Monitoring
                            </button>
                            <button class="submenu-btn" data-submenu="remediation" onclick="switchIPSECSubmenu('remediation')">
                                <span class="submenu-icon"></span>
                                Remediation
                            </button>
                        </div>
                        
                        <div id="ipsec-alert-container"></div>

                        <!-- Monitoring View -->
                        <div id="ipsec-monitoring" class="submenu-content active">
                            <div style="margin-bottom: 1rem;">
                                <input 
                                    type="text" 
                                    id="ipsec-search" 
                                    placeholder=" Rechercher un firewall ou tunnel..." 
                                    oninput="filterAccordions('ipsec-grid', this.value)"
                                    style="
                                        width: 100%;
                                        padding: 0.75rem 1rem;
                                        border: 1px solid var(--gray-300);
                                        border-radius: 8px;
                                        font-size: 0.95rem;
                                    "
                                >
                            </div>

                            <div id="ipsec-grid">
                                <div class="empty-state">
                                    <div class="empty-state-icon"></div>
                                    <h3>No IPSEC VPN Data</h3>
                                    <p>Loading VPN tunnel configuration automatically...</p>
                                </div>
                            </div>
                        </div>

                        <!-- Remediation View -->
                        <div id="ipsec-remediation" class="submenu-content">
                            <div style="margin-bottom: 1.5rem; padding: 1rem; background: #dbeafe; border-left: 4px solid #3b82f6; border-radius: 8px;">
                                <strong style="color: #1e40af;"> Note importante sur la remediation IPSEC VPN</strong>
                                <p style="margin: 0.5rem 0 0 0; font-size: 0.9rem; color: var(--gray-700);">
                                    Les tunnels VPN en mode <strong>Aggressive</strong> prsentent des risques de scurit. 
                                    Vous pouvez dsactiver ces tunnels ou les convertir en mode <strong>Main</strong> pour une meilleure scurit.
                                </p>
                            </div>
                            <div id="ipsec-remediation-grid">
                                <div class="empty-state">
                                    <div class="empty-state-icon"></div>
                                    <h3>IPSEC VPN Remediation</h3>
                                    <p>Loading remediation data...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- SSL VPN Section -->
                <section id="ssl-vpn-section" style="display: none;">
                    <div class="section-header">
                        <h2 class="section-title">SSL VPN Configuration</h2>
                        <p style="color: var(--gray-600); margin-bottom: 2rem;">SSL VPN security status based on user authentication configuration</p>
                        
                        <!-- SSL VPN Sub-menu -->
                        <div class="module-submenu">
                            <button class="submenu-btn active" data-submenu="monitoring" onclick="switchSSLVPNSubmenu('monitoring')">
                                <span class="submenu-icon"></span>
                                Monitoring
                            </button>
                            <button class="submenu-btn" data-submenu="remediation" onclick="switchSSLVPNSubmenu('remediation')">
                                <span class="submenu-icon"></span>
                                Remediation
                            </button>
                        </div>
                        
                        <div id="ssl-alert-container"></div>

                        <!-- Monitoring View -->
                        <div id="ssl-monitoring" class="submenu-content active">
                            <div style="margin-bottom: 1rem;">
                                <input 
                                    type="text" 
                                    id="ssl-vpn-search" 
                                    placeholder=" Rechercher un firewall..." 
                                    oninput="filterAccordions('ssl-vpn-grid', this.value)"
                                    style="
                                        width: 100%;
                                        padding: 0.75rem 1rem;
                                        border: 1px solid var(--gray-300);
                                        border-radius: 8px;
                                        font-size: 0.95rem;
                                    "
                                >
                            </div>

                            <div id="ssl-vpn-grid">
                                <div class="empty-state">
                                    <div class="empty-state-icon"></div>
                                    <h3>No SSL VPN Data</h3>
                                    <p>Loading SSL VPN configuration automatically...</p>
                                </div>
                            </div>
                        </div>

                        <!-- Remediation View -->
                        <div id="ssl-remediation" class="submenu-content">
                            <div style="margin-bottom: 1.5rem; padding: 1rem; background: #dbeafe; border-left: 4px solid #3b82f6; border-radius: 8px;">
                                <strong style="color: #1e40af;"> Logique de scurit SSL VPN</strong>
                                <p style="margin: 0.5rem 0 0 0; font-size: 0.9rem; color: var(--gray-700);">
                                    Pour que SSL VPN soit considr comme <strong>scuris</strong>, deux options sont disponibles :<br><br>
                                    
                                    <strong>Option 1 :</strong> Dsactiver SSL VPN sur les zones WAN (recommand si non utilis)<br><br>
                                    
                                    <strong>Option 2 :</strong> Si SSL VPN sur WAN est ncessaire, les conditions suivantes doivent tre remplies :<br>
                                     <strong>Local Users</strong> doit tre rsolu (mots de passe changs, TOTP retir)<br>
                                     <strong>LDAP</strong> doit tre rsolu (si configur) - bind password chang<br>
                                     <strong>RADIUS</strong> doit tre rsolu (si configur) - secrets changs<br>
                                     <strong>TACACS+</strong> doit tre rsolu (si configur) - secrets changs
                                </p>
                            </div>
                            <div id="ssl-remediation-grid">
                                <div class="empty-state">
                                    <div class="empty-state-icon"></div>
                                    <h3>SSL VPN Remediation</h3>
                                    <p>Loading remediation data...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- PPPoE/PPTP/L2TP Section -->
                <section id="pppoe-pptp-l2tp-section" style="display: none;">
                    <div class="section-header">
                        <h2 class="section-title">PPPoE/PPTP/L2TP</h2>
                        <p style="color: var(--gray-600); margin-bottom: 2rem;">WAN interface protocols and password security</p>
                        <div id="pppoe-pptp-l2tp-alert-container"></div>

                        <!-- Module Submenu -->
                        <div class="module-submenu">
                            <button class="submenu-btn active" onclick="switchPPPoESubmenu('monitoring')">Monitoring</button>
                            <button class="submenu-btn" onclick="switchPPPoESubmenu('remediation')">Remediation</button>
                        </div>

                        <div style="margin-bottom: 1rem;">
                            <input 
                                type="text" 
                                id="pppoe-search" 
                                placeholder=" Rechercher un firewall ou interface..." 
                                oninput="filterAccordions('pppoe-pptp-l2tp-grid', this.value)"
                                style="
                                    width: 100%;
                                    padding: 0.75rem 1rem;
                                    border: 1px solid var(--gray-300);
                                    border-radius: 8px;
                                    font-size: 0.95rem;
                                "
                            >
                        </div>

                        <!-- PPPoE/PPTP/L2TP Grid -->
                        <div id="pppoe-pptp-l2tp-grid">
                            <div class="empty-state">
                                <div class="empty-state-icon"></div>
                                <h3>No PPPoE/PPTP/L2TP Data</h3>
                                <p>Loading WAN interface protocols automatically...</p>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Cloud Secure Edge Section -->
                <section id="cse-section" style="display: none;">
                    <div class="section-header">
                        <h2 class="section-title">Cloud Secure Edge (CSE)</h2>
                        <p style="color: var(--gray-600); margin-bottom: 2rem;">Cloud Secure Edge connectors and configuration</p>
                        
                        <!-- CSE Sub-menu -->
                        <div class="module-submenu">
                            <button class="submenu-btn active" data-submenu="monitoring" onclick="switchCSESubmenu('monitoring')">
                                <span class="submenu-icon"></span>
                                Monitoring
                            </button>
                            <button class="submenu-btn" data-submenu="remediation" onclick="switchCSESubmenu('remediation')">
                                <span class="submenu-icon"></span>
                                Remediation
                            </button>
                        </div>
                        
                        <div id="cse-alert-container"></div>

                        <!-- Monitoring View -->
                        <div id="cse-monitoring" class="submenu-content active">
                            <div style="margin-bottom: 1rem;">
                                <input 
                                    type="text" 
                                    id="cse-search" 
                                    placeholder=" Rechercher un firewall ou connector..." 
                                    oninput="filterAccordions('cse-grid', this.value)"
                                    style="
                                        width: 100%;
                                        padding: 0.75rem 1rem;
                                        border: 1px solid var(--gray-300);
                                        border-radius: 8px;
                                        font-size: 0.95rem;
                                    "
                                >
                            </div>

                            <div id="cse-grid">
                                <div class="empty-state">
                                    <div class="empty-state-icon"></div>
                                    <h3>No CSE Data</h3>
                                    <p>Loading Cloud Secure Edge configuration automatically...</p>
                                </div>
                            </div>
                        </div>

                        <!-- Remediation View -->
                        <div id="cse-remediation" class="submenu-content">
                            <div style="margin-bottom: 1.5rem; padding: 1rem; background: #dbeafe; border-left: 4px solid #3b82f6; border-radius: 8px;">
                                <strong style="color: #1e40af;"> Note importante sur la remediation CSE</strong>
                                <p style="margin: 0.5rem 0 0 0; font-size: 0.9rem; color: var(--gray-700);">
                                    Suite  la compromission des backups SonicWall, vous devez <strong>dissocier manuellement</strong> le Firewall Connector 
                                    dans MySonicWall avant de pouvoir ractiver CSE. Une fois l'action manuelle effectue, vous devrez attendre 30 secondes 
                                    avant de pouvoir ractiver CSE automatiquement via l'interface.
                                </p>
                                <div style="margin-top: 1rem; padding: 1rem; background: #f9fafb; border-radius: 6px; border: 1px solid #e5e7eb;">
                                    <h4 style="margin: 0 0 0.5rem 0; color: #374151; font-size: 0.95rem;"> tapes manuelles dans MySonicWall :</h4>
                                    <ol style="margin: 0; padding-left: 1.2rem; color: var(--gray-700); font-size: 0.9rem;">
                                        <li>Connectez-vous  <strong>MySonicWall</strong></li>
                                        <li>Allez dans <strong>Products</strong> et slectionnez le Tenant</li>
                                        <li>Recherchez le produit <strong>"SonicWall Cloud Secure Edge"</strong></li>
                                        <li>Dans les dtails, cliquez sur <strong>"Firewall Connection"</strong></li>
                                        <li>Cliquez sur l'<strong>icne poubelle</strong> pour dissocier le connector</li>
                                    </ol>
                                </div>
                            </div>
                            <div id="cse-remediation-grid">
                                <div class="empty-state">
                                    <div class="empty-state-icon"></div>
                                    <h3>CSE Remediation</h3>
                                    <p>Select a firewall to perform remediation actions</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Analytics Section -->
                <section id="analytics-section" style="display: none;">
                    <div class="section-header">
                        <h2 class="section-title">Analytics & Reporting</h2>
                        <p style="color: var(--gray-600); margin-bottom: 2rem;">Global security insights and firewall performance metrics</p>
                    </div>

                    <!-- Global Scoreboard -->
                    <div class="analytics-scoreboard">
                        <h3 style="font-size: 1.25rem; font-weight: 600; color: var(--gray-800); margin-bottom: 1.5rem;">
                            Global Security Overview
                        </h3>
                        <div id="global-stats-grid" class="global-stats-grid">
                            <!-- Will be populated dynamically -->
                        </div>
                    </div>

                    <!-- Security Score Chart -->
                    <div class="analytics-charts">
                        <h3 style="font-size: 1.25rem; font-weight: 600; color: var(--gray-800); margin-bottom: 1.5rem;">
                            Firewall Security Scores
                        </h3>
                        <div id="security-score-chart" class="chart-container">
                            <!-- Will be populated dynamically -->
                        </div>
                    </div>

                    <!-- Module Status Distribution -->
                    <div class="analytics-modules">
                        <h3 style="font-size: 1.25rem; font-weight: 600; color: var(--gray-800); margin-bottom: 1.5rem;">
                            Module Status Distribution
                        </h3>
                        <div id="module-distribution-chart" class="module-grid">
                            <!-- Will be populated dynamically -->
                        </div>
                    </div>

                    <!-- Firewall Ranking -->
                    <div class="analytics-ranking">
                        <h3 style="font-size: 1.25rem; font-weight: 600; color: var(--gray-800); margin-bottom: 1.5rem;">
                            Firewall Security Ranking
                        </h3>
                        <div id="firewall-ranking-list" class="ranking-list">
                            <!-- Will be populated dynamically -->
                        </div>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- Copyright -->
    <div class="copyright">
         2025 Guillaume SEVRIN
    </div>

    <!-- Include translations -->
    <script src="{{ url_for('static', filename='translations.js') }}"></script>
    
    <script>
        // Global variables
        // Variables globales (accessibles depuis window pour la recherche)
        window.firewalls = [];
        let firewalls = window.firewalls;  // Alias pour compatibilit
        let filteredFirewalls = [];
        let currentPage = 1;
        const itemsPerPage = 12;
        let searchTimeout;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize language first
            if (typeof initLanguage === 'function') {
                initLanguage();
            }
            initializeApp();
        });


        async function initializeApp() {
            setupEventListeners();
            // Open Users menu by default
            const usersSubmenu = document.getElementById('users-submenu');
            const usersArrow = document.getElementById('users-arrow');
            const usersHeader = document.querySelector('.nav-group-header');
            if (usersSubmenu && usersArrow && usersHeader) {
                usersSubmenu.classList.add('open');
                usersHeader.classList.add('open');
            }
            
            // Load firewalls from database
            await loadFirewalls();
            
            // Check for localStorage migration
            await migrateFromLocalStorage();
        }

        // Helper function to safely parse JSON responses
        async function safeJsonParse(response) {
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                const text = await response.text();
                console.error('Expected JSON but got:', text.substring(0, 200));
                throw new Error('Server returned non-JSON response. Check if the Flask server is running correctly.');
            }
            return await response.json();
        }

        async function loadFirewalls() {
            try {
                const response = await fetch('/api/firewalls');
                const result = await safeJsonParse(response);
                
                if (result.success) {
                    window.firewalls = result.firewalls || [];
                    firewalls = window.firewalls;
                    console.log(` Loaded ${firewalls.length} firewall(s) from database`);
                    renderFirewalls();
                    updateStats();
                } else {
                    console.error('Error loading firewalls:', result.message);
                    window.firewalls = [];
                    firewalls = window.firewalls;
                    renderFirewalls();
                    updateStats();
                }
            } catch (error) {
                console.error('Error loading firewalls:', error);
                window.firewalls = [];
                firewalls = window.firewalls;
                renderFirewalls();
                updateStats();
            }
        }

        async function migrateFromLocalStorage() {
            // Vrifier s'il y a des firewalls dans localStorage
            const localFirewalls = JSON.parse(localStorage.getItem('firewalls') || '[]');
            
            if (localFirewalls.length > 0) {
                console.log(` Migration: ${localFirewalls.length} firewall(s) trouv(s) dans localStorage`);
                
                let migratedCount = 0;
                let errorCount = 0;
                
                for (const fw of localFirewalls) {
                    try {
                        const response = await fetch('/api/firewalls', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                name: fw.name || fw.ip,
                                ip: fw.ip,
                                username: fw.username,
                                password: fw.password,
                                otp: fw.otp || false
                            })
                        });
                        
                        const result = await safeJsonParse(response);
                        if (result.success) {
                            migratedCount++;
                        } else {
                            // Probablement dj existant, pas grave
                            console.log(`  Firewall ${fw.ip} dj en base`);
                        }
                    } catch (error) {
                        errorCount++;
                        console.error(`Error migrating firewall ${fw.ip}:`, error);
                    }
                }
                
                // Supprimer de localStorage aprs la tentative de migration
                // (mme si les firewalls existaient dj en base)
                localStorage.removeItem('firewalls');
                console.log(` Migration termine: ${migratedCount} firewall(s) migr(s), ${localFirewalls.length - migratedCount} dj existant(s)`);
                
                // Recharger depuis la DB
                await loadFirewalls();
            }
        }

        function toggleUsersMenu() {
            const submenu = document.getElementById('users-submenu');
            const arrow = document.getElementById('users-arrow');
            const header = document.querySelector('.nav-group-header');
            
            if (submenu && arrow && header) {
                submenu.classList.toggle('open');
                header.classList.toggle('open');
            }
        }

        function toggleDisclaimer() {
            const banner = document.getElementById('disclaimer-banner');
            const toggle = document.getElementById('disclaimer-toggle');
            
            if (banner && toggle) {
                const isCollapsed = banner.classList.contains('collapsed');
                
                if (isCollapsed) {
                    // Expand
                    banner.classList.remove('collapsed');
                    toggle.innerHTML = '';
                    toggle.title = 'Collapse disclaimer';
                    localStorage.setItem('disclaimerCollapsed', 'false');
                } else {
                    // Collapse
                    banner.classList.add('collapsed');
                    toggle.innerHTML = '';
                    toggle.title = 'Expand disclaimer';
                    localStorage.setItem('disclaimerCollapsed', 'true');
                }
            }
        }

        // Restaurer l'tat du disclaimer au chargement
        document.addEventListener('DOMContentLoaded', function() {
            const disclaimerCollapsed = localStorage.getItem('disclaimerCollapsed');
            if (disclaimerCollapsed === 'true') {
                const banner = document.getElementById('disclaimer-banner');
                const toggle = document.getElementById('disclaimer-toggle');
                if (banner && toggle) {
                    banner.classList.add('collapsed');
                    toggle.innerHTML = '';
                    toggle.title = 'Expand disclaimer';
                }
            }
        });

        function setupEventListeners() {
            // Form submission
            document.getElementById('add-firewall-form').addEventListener('submit', handleAddFirewall);
            
            // Filters
            document.getElementById('status-filter').addEventListener('change', handleFilter);
            
            // Navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                console.log('Attaching click event to nav item:', item.dataset.tab);
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    console.log('Nav item clicked:', item.dataset.tab);
                    console.log('About to call switchTab with:', item.dataset.tab);
                    console.log('Calling switchTab directly...');
                    switchTab(item.dataset.tab);
                    console.log('switchTab call completed');
                });
            });
        }

        // Add firewall
        async function handleAddFirewall(e) {
            e.preventDefault();
            
            const name = document.getElementById('firewall-name').value.trim();
            const ip = document.getElementById('firewall-ip').value.trim();
            const username = document.getElementById('firewall-username').value.trim();
            const password = document.getElementById('firewall-password').value;
            const otpCode = document.getElementById('firewall-otp').value.trim();

            showAlert('warning', 'Testing connection...', 'alert-container');

            try {
                // 1. Tester la connexion
                const testResponse = await fetch('/api/test-connection', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ip, username, password, otp_code: otpCode })
                });

                const testResult = await testResponse.json();

                if (testResult.success) {
                    // 2. Ajouter  la base de donnes
                    const addResponse = await fetch('/api/firewalls', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            name: name,
                            ip: ip,
                            username: username,
                            password: password,
                            otp: otpCode ? true : false
                        })
                    });

                    const addResult = await addResponse.json();

                    if (addResult.success) {
                        showAlert('success', ' Firewall added and encrypted in database!', 'alert-container');
                        
                        // Reset form
                        document.getElementById('add-firewall-form').reset();
                        
                        // Recharger depuis la DB
                        await loadFirewalls();
                    } else {
                        showAlert('error', addResult.message, 'alert-container');
                    }
                } else {
                    showAlert('error', testResult.message, 'alert-container');
                }
            } catch (error) {
                showAlert('error', 'Connection error: ' + error.message, 'alert-container');
            }
        }

        // Search and filter
        function handleFilter() {
            filterFirewalls();
        }

        function filterFirewalls() {
            const searchTerm = '';  // Maintenant gr par la recherche globale
            const statusFilter = document.getElementById('status-filter').value;
            
            filteredFirewalls = firewalls.filter(fw => {
                const matchesSearch = fw.ip.toLowerCase().includes(searchTerm) || 
                                    fw.username.toLowerCase().includes(searchTerm);
                const matchesStatus = !statusFilter || fw.status === statusFilter;
                return matchesSearch && matchesStatus;
            });
            
            currentPage = 1;
            renderFirewalls();
        }

        // Security Score Calculation
        async function calculateSecurityScore(firewall) {
            const modules = {
                'local_users': { weight: 10, status: null, config: null },
                'ldap': { weight: 10, status: null, config: null },
                'radius': { weight: 10, status: null, config: null },
                'tacacs': { weight: 10, status: null, config: null },
                'sso': { weight: 15, status: null, config: null },
                'wan_management': { weight: 15, status: null, config: null },
                'ipsec': { weight: 10, status: null, config: null },
                'ssl_vpn': { weight: 10, status: null, config: null },
                'cse': { weight: 10, status: null, config: null }
            };

            // Fetch status AND config for each module to check if it's actually at risk
            for (const [moduleName, module] of Object.entries(modules)) {
                try {
                    // Get remediation status
                    const statusResponse = await fetch(`/api/remediation/status/${firewall.id}/${moduleName}`);
                    const statusData = await statusResponse.json();
                    module.status = statusData.status;

                    // Get actual configuration to check if there's a real problem
                    // Par dfaut, on suppose qu'il y a un problme SAUF si vrifi explicitement
                    let hasRealProblem = true;  // Changed from false to true!
                    let configChecked = false;
                    
                    if (moduleName === 'wan_management') {
                        try {
                            const wanResponse = await fetch('/api/wan-management', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    ip: firewall.ip,
                                    username: firewall.username,
                                    password: firewall.password
                                })
                            });
                            const wanData = await wanResponse.json();
                            const atRiskRules = (wanData.wan_to_wan_rules || []).filter(r => r.is_at_risk);
                            hasRealProblem = atRiskRules.length > 0;
                            configChecked = true;
                        } catch (e) {
                            console.error(`Error checking WAN config:`, e);
                        }
                    }
                    // Pour les autres modules, on se base uniquement sur le statut de remediation
                    // Si pas de statut en DB = on suppose qu'il y a un problme

                    module.config = { hasRealProblem, configChecked };
                    
                    let statusText = 'NO DATA';
                    if (module.status) {
                        if (module.status.is_resolved) statusText = 'GREEN';
                        else if (configChecked && !hasRealProblem) statusText = 'GREEN (SAFE)';
                        else statusText = 'RED';
                    } else if (configChecked && !hasRealProblem) {
                        statusText = 'GREEN (NO PROBLEM)';
                    } else {
                        statusText = 'RED (NO STATUS)';
                    }
                    
                    console.log(`[Score] ${moduleName}:`, statusText);
                } catch (error) {
                    console.error(`Error fetching ${moduleName} status:`, error);
                }
            }

            // Calculate score
            let totalScore = 0;
            let maxScore = 100; // Total always 100 points

            for (const [moduleName, module] of Object.entries(modules)) {
                const hasRealProblem = module.config?.hasRealProblem !== false; // true by default
                const configChecked = module.config?.configChecked || false;
                const isResolved = module.status?.is_resolved || false;
                let pointsEarned = 0;
                
                // If module is resolved OR (config was checked AND no real problem) = GREEN
                if (isResolved || (configChecked && !hasRealProblem)) {
                    pointsEarned = module.weight;
                    totalScore += module.weight;
                    console.log(`[Score Detail] ${moduleName}: +${module.weight} pts (GREEN - ${isResolved ? 'resolved' : 'no problem detected'})`);
                }
                // If timer is active = ORANGE (half points)
                else if (module.status?.verification_method === 'timer_expired_waiting_reactivation' || 
                         module.status?.verification_method === 'pending') {
                    pointsEarned = module.weight * 0.5;
                    totalScore += module.weight * 0.5;
                    console.log(`[Score Detail] ${moduleName}: +${module.weight * 0.5} pts (ORANGE - timer active)`);
                }
                // Else = RED (0 points)
                else {
                    console.log(`[Score Detail] ${moduleName}: +0 pts (RED - ${module.status ? 'problem not resolved' : 'no status'})`);
                }
            }

            // Score is already on 100
            const score = Math.round(totalScore);

            console.log(`[Score] Final score for firewall ${firewall.id}: ${score}/100 (${totalScore} points earned)`);

            return {
                score,
                modules,
                totalScore,
                maxScore
            };
        }

        function getScoreColor(score) {
            if (score >= 71) return '#22c55e'; // Green
            if (score >= 41) return '#f59e0b'; // Orange
            return '#ef4444'; // Red
        }

        function getScoreBadge(score) {
            if (score >= 71) return { class: 'score-good', text: ' Bon tat' };
            if (score >= 41) return { class: 'score-warning', text: ' Attention' };
            return { class: 'score-critical', text: ' Critique' };
        }

        function renderSecurityScore(score) {
            const color = getScoreColor(score);
            const badge = getScoreBadge(score);
            const circumference = 2 * Math.PI * 30; // radius = 30
            const offset = circumference - (score / 100) * circumference;

            // Aplat de couleur selon le score
            return `
                <div class="security-score-container">
                    <div class="security-score-circle">
                        <svg class="security-score-svg" viewBox="0 0 70 70">
                            <circle class="security-score-bg" cx="35" cy="35" r="30"></circle>
                            <circle 
                                class="security-score-progress security-score-animated" 
                                cx="35" 
                                cy="35" 
                                r="30"
                                stroke="${color}"
                                stroke-dasharray="${circumference}"
                                stroke-dashoffset="${circumference}"
                                data-final-offset="${offset}"
                            ></circle>
                        </svg>
                        <div class="security-score-text">
                            <div class="security-score-value security-score-value-animated" style="color: ${color};" data-final-score="${score}">0</div>
                            <div class="security-score-label">Score</div>
                        </div>
                    </div>
                    <div class="security-score-badge ${badge.class}">${badge.text}</div>
                </div>
            `;
        }

        // Render firewalls
        function renderFirewalls() {
            const container = document.getElementById('firewall-grid');
            const paginationContainer = document.getElementById('pagination');
            
            // Use filtered firewalls if search/filter is active, otherwise use all firewalls
            const firewallsToRender = filteredFirewalls.length > 0 ? filteredFirewalls : firewalls;
            
            if (firewallsToRender.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon"></div>
                        <h3>No firewalls found</h3>
                        <p>${firewalls.length === 0 ? 'Add your first firewall using the form above' : 'No firewalls match your search criteria'}</p>
                    </div>
                `;
                paginationContainer.style.display = 'none';
                return;
            }

            // Pagination
            const totalPages = Math.ceil(firewallsToRender.length / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageFirewalls = firewallsToRender.slice(startIndex, endIndex);

            // Render firewall cards
            container.innerHTML = pageFirewalls.map(fw => `
                <div class="firewall-card ${fw.status}" id="firewall-${fw.id}">
                    <div class="firewall-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.25rem;">
                                <div class="firewall-ip" style="font-size: 1.25rem; font-weight: 700; color: var(--gray-900);">
                                    ${fw.name || fw.ip}
                                </div>
                                <span class="firewall-status status-${fw.status}">${getStatusText(fw.status)}</span>
                            </div>
                            ${fw.name ? `<div style="font-size: 0.85rem; color: var(--gray-500);">${fw.ip}</div>` : ''}
                        </div>
                        <div id="score-${fw.id}" style="display: flex; flex-direction: column; align-items: center; gap: 0.25rem; margin-left: 1rem;">
                            <div style="width: 70px; height: 70px; display: flex; align-items: center; justify-content: center;">
                                <div style="font-size: 1.5rem;"></div>
                            </div>
                        </div>
                    </div>
                    <div class="firewall-info">
                        <div class="firewall-info-item">
                            <span class="firewall-info-label">Username:</span>
                            <span class="firewall-info-value">${fw.username}</span>
                        </div>
                        <div class="firewall-info-item">
                            <span class="firewall-info-label">Last Check:</span>
                            <span class="firewall-info-value">${formatDate(fw.lastChecked)}</span>
                        </div>
                        <div class="firewall-info-item">
                            <span class="firewall-info-label">API URL:</span>
                            <span class="firewall-info-value">https://${fw.ip}/api/sonicos/</span>
                        </div>
                    </div>
                    <div class="firewall-actions">
                        <button class="btn btn-primary" onclick="showFirewallDashboard(${fw.id})" style="background: var(--primary-500);">
                            Audit
                        </button>
                        <button class="btn btn-secondary" onclick="testConnection(${fw.id})">
                            Test
                        </button>
                        <button class="btn btn-secondary" onclick="editFirewall(${fw.id})">
                            <span></span> Edit
                        </button>
                        <button class="btn btn-danger" onclick="removeFirewall(${fw.id})">
                            <span></span> Delete
                        </button>
                    </div>
                </div>
            `).join('');

            // Show/hide pagination
            if (totalPages > 1) {
                paginationContainer.style.display = 'flex';
                renderPagination(totalPages);
            } else {
                paginationContainer.style.display = 'none';
            }

            // Calculate and display security scores asynchronously
            pageFirewalls.forEach(async (fw) => {
                try {
                    const scoreData = await calculateSecurityScore(fw);
                    const scoreElement = document.getElementById(`score-${fw.id}`);
                    if (scoreElement) {
                        scoreElement.innerHTML = renderSecurityScore(scoreData.score);
                        
                        // Animer le cercle et le compteur aprs un court dlai
                        setTimeout(() => {
                            animateSecurityScore(scoreElement);
                        }, 100);
                    }
                } catch (error) {
                    console.error(`Error calculating score for firewall ${fw.id}:`, error);
                    const scoreElement = document.getElementById(`score-${fw.id}`);
                    if (scoreElement) {
                        scoreElement.innerHTML = '<div style="font-size: 1.5rem;"></div>';
                    }
                }
            });
        }

        // Animate security score circle and counter
        function animateSecurityScore(container) {
            const circle = container.querySelector('.security-score-animated');
            const valueElement = container.querySelector('.security-score-value-animated');
            
            if (!circle || !valueElement) return;
            
            const finalOffset = parseFloat(circle.getAttribute('data-final-offset'));
            const finalScore = parseInt(valueElement.getAttribute('data-final-score'));
            
            // Animer le cercle
            circle.style.transition = 'stroke-dashoffset 1.5s ease-out';
            circle.style.strokeDashoffset = finalOffset;
            
            // Animer le compteur
            const duration = 1500; // 1.5 secondes
            const startTime = performance.now();
            
            function updateCounter(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                
                // Easing function (ease-out)
                const easeOut = 1 - Math.pow(1 - progress, 3);
                const currentScore = Math.round(easeOut * finalScore);
                
                valueElement.textContent = currentScore;
                
                if (progress < 1) {
                    requestAnimationFrame(updateCounter);
                } else {
                    valueElement.textContent = finalScore;
                }
            }
            
            requestAnimationFrame(updateCounter);
        }

        // Pagination
        function renderPagination(totalPages) {
            const pageNumbers = document.getElementById('page-numbers');
            const prevBtn = document.getElementById('prev-page');
            const nextBtn = document.getElementById('next-page');
            
            // Previous button
            prevBtn.disabled = currentPage === 1;
            
            // Next button
            nextBtn.disabled = currentPage === totalPages;
            
            // Page numbers
            let pageNumbersHtml = '';
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            
            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }
            
            for (let i = startPage; i <= endPage; i++) {
                pageNumbersHtml += `<button class="${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">${i}</button>`;
            }
            
            pageNumbers.innerHTML = pageNumbersHtml;
        }

        function changePage(direction) {
            const firewallsToRender = filteredFirewalls.length > 0 ? filteredFirewalls : firewalls;
            const totalPages = Math.ceil(firewallsToRender.length / itemsPerPage);
            
            const newPage = currentPage + direction;
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                renderFirewalls();
            }
        }

        function goToPage(page) {
            currentPage = page;
            renderFirewalls();
        }

        // Firewall operations
        async function testConnection(id) {
            const firewall = firewalls.find(fw => fw.id === id);
            if (!firewall) return;

            firewall.status = 'testing';
            renderFirewalls();

            try {
                const response = await fetch('/api/test-connection', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        ip: firewall.ip,
                        username: firewall.username,
                        password: firewall.password
                    })
                });

                const result = await response.json();
                const newStatus = result.success ? 'connected' : 'disconnected';
                
                // Mettre  jour le statut dans la DB
                await fetch(`/api/firewalls/${firewall.id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        status: newStatus
                    })
                });
                
                // Recharger depuis la DB
                await loadFirewalls();

                if (!result.success) {
                    showAlert('error', `Connection failed: ${result.message}`, 'alert-container');
                }
            } catch (error) {
                // Mettre  jour le statut dans la DB
                await fetch(`/api/firewalls/${firewall.id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        status: 'disconnected'
                    })
                });
                
                await loadFirewalls();
                showAlert('error', 'Test error: ' + error.message, 'alert-container');
            }
        }

        async function removeFirewall(id) {
            if (confirm('Are you sure you want to delete this firewall?')) {
                try {
                    const response = await fetch(`/api/firewalls/${id}`, {
                        method: 'DELETE'
                    });

                    const result = await response.json();

                    if (result.success) {
                        showAlert('success', result.message, 'alert-container');
                        await loadFirewalls();
                    } else {
                        showAlert('error', result.message, 'alert-container');
                    }
                } catch (error) {
                    showAlert('error', 'Error deleting firewall: ' + error.message, 'alert-container');
                }
            }
        }

        // Utility functions
        function refreshAllFirewalls() {
            if (firewalls.length === 0) return;
            
            showAlert('warning', 'Refreshing all firewalls...', 'alert-container');
            
            firewalls.forEach(fw => {
                testConnection(fw.id);
            });
        }

        async function clearAllFirewalls() {
            if (confirm('Are you sure you want to delete ALL firewalls? This cannot be undone!')) {
                try {
                    // Supprimer tous les firewalls un par un
                    const deletePromises = firewalls.map(fw => 
                        fetch(`/api/firewalls/${fw.id}`, { method: 'DELETE' })
                    );
                    
                    await Promise.all(deletePromises);
                    
                    showAlert('success', 'All firewalls deleted from database', 'alert-container');
                    await loadFirewalls();
                } catch (error) {
                    showAlert('error', 'Error deleting firewalls: ' + error.message, 'alert-container');
                }
            }
        }

        function updateStats() {
            const total = firewalls.length;
            const connected = firewalls.filter(fw => fw.status === 'connected').length;
            const disconnected = firewalls.filter(fw => fw.status === 'disconnected').length;
            
            document.getElementById('total-firewalls').textContent = total;
            document.getElementById('connected-firewalls').textContent = connected;
            document.getElementById('disconnected-firewalls').textContent = disconnected;
        }

        function showAlert(type, message, containerId) {
            const container = document.getElementById(containerId);
            const alertClass = type === 'success' ? 'alert-success' : 
                              type === 'error' ? 'alert-error' : 'alert-warning';
            
            // Create alert with animation
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert ${alertClass}`;
            alertDiv.textContent = message;
            
            // Add entrance animation
            alertDiv.style.opacity = '0';
            alertDiv.style.transform = 'translateY(-20px)';
            
            container.innerHTML = '';
            container.appendChild(alertDiv);
            
            // Trigger animation
            requestAnimationFrame(() => {
                alertDiv.style.transition = 'all 0.3s ease-out';
                alertDiv.style.opacity = '1';
                alertDiv.style.transform = 'translateY(0)';
            });
            
            setTimeout(() => {
                // Exit animation
                alertDiv.style.transition = 'all 0.3s ease-out';
                alertDiv.style.opacity = '0';
                alertDiv.style.transform = 'translateY(-20px)';
                
                setTimeout(() => {
                    container.innerHTML = '';
                }, 300);
            }, 5000);
        }

        function getStatusText(status) {
            switch(status) {
                case 'connected': return 'Connected';
                case 'disconnected': return 'Disconnected';
                case 'testing': return 'Testing';
                default: return 'Unknown';
            }
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('fr-FR');
        }

        // WAN Management Functions
        async function checkWANManagement() {
            console.log('=== WAN Management Debug ===');
            console.log('Firewalls available:', firewalls.length);
            console.log('Firewalls data:', firewalls);
            
            if (firewalls.length === 0) {
                showAlert('warning', 'No firewalls available. Add firewalls first.', 'wan-alert-container');
                return;
            }

            showAlert('warning', 'Checking WAN management configuration...', 'wan-alert-container');
            
            const wanData = [];
            
            for (const firewall of firewalls) {
                console.log('Processing firewall:', firewall);
                try {
                    console.log('Sending request to /api/wan-management for:', firewall.ip);
                    const response = await fetch('/api/wan-management', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            ip: firewall.ip,
                            username: firewall.username,
                            password: firewall.password
                        })
                    });

                    console.log('Response status:', response.status);
                    const result = await response.json();
                    console.log('Response result:', result);
                    
                    // Get remediation status
                    const statusResponse = await fetch(`/api/remediation/status/${firewall.id}/wan_management`);
                    const statusData = await statusResponse.json();
                    
                    wanData.push({
                        firewall: firewall,
                        wanManagement: result.wan_management_enabled || false,
                        httpsSource: result.https_source || 'Not configured',
                        wanToWanRules: result.wan_to_wan_rules || [],
                        remediationStatus: statusData.status || null,
                        lastChecked: new Date().toISOString()
                    });
                } catch (error) {
                    console.error('Error in WAN Management check:', error);
                    wanData.push({
                        firewall: firewall,
                        wanManagement: false,
                        httpsSource: 'Error',
                        wanToWanRules: [],
                        error: error.message,
                        lastChecked: new Date().toISOString()
                    });
                }
            }

            console.log('About to render WAN Management data:', wanData);
            renderWANManagement(wanData);
            showAlert('success', 'WAN management check completed', 'wan-alert-container');
        }

        function renderWANManagement(wanData) {
            console.log('=== renderWANManagement called with:', wanData);
            const container = document.getElementById('wan-management-grid');
            console.log('Container found:', container);
            
            if (wanData.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon"></div>
                        <h3>No WAN Management Data</h3>
                        <p>Click "Check All Firewalls" to analyze WAN management configuration</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = wanData.map(data => {
                // Use is_at_risk flag from backend
                const riskyRules = data.wanToWanRules ? data.wanToWanRules.filter(rule => rule.is_at_risk) : [];
                
                // Check remediation status
                const isResolved = data.remediationStatus?.is_resolved || false;
                const hasActions = data.remediationStatus !== null;
                
                // Determine color based on remediation status
                let bgColor, hoverColor;
                if (riskyRules.length === 0) {
                    bgColor = 'white';
                    hoverColor = 'var(--gray-50)';
                } else if (isResolved) {
                    bgColor = '#dcfce7';  // Vert
                    hoverColor = '#bbf7d0';
                } else if (hasActions) {
                    bgColor = '#fef3c7';  // Orange
                    hoverColor = '#fde68a';
                } else {
                    bgColor = '#fee2e2';  // Rouge
                    hoverColor = '#fecaca';
                }
                
                const hasRisk = riskyRules.length > 0 && !isResolved;
                
                return `
                <div class="firewall-user-accordion" style="background: ${bgColor} !important; ${isResolved ? 'border: 2px solid #22c55e !important;' : (riskyRules.length > 0 ? 'border: 2px solid ' + (hasActions ? '#f59e0b' : '#ef4444') + ' !important;' : '')}">
                    <div class="firewall-user-header" onclick="toggleUserAccordion('wan-${data.firewall.id}')" style="background: ${bgColor} !important;" onmouseover="this.parentElement.style.background='${hoverColor} !important'" onmouseout="this.parentElement.style.background='${bgColor} !important'">
                        <div style="display: flex; align-items: center; gap: 1rem; width: 100%;">
                        <!-- Firewall Name/IP -->
                        <div style="min-width: 200px; flex-shrink: 0;">
                            <div style="font-size: 1rem; font-weight: 700; color: ${isResolved ? '#166534' : hasRisk ? '#991b1b' : 'var(--gray-900)'}; white-space: nowrap;">
                                ${isResolved ? ' ' : hasRisk ? ' ' : ''}${data.firewall.name || data.firewall.ip}
                            </div>
                            ${data.firewall.name ? `<div style="font-size: 0.75rem; color: var(--gray-500); margin-top: 0.1rem;">${data.firewall.ip}</div>` : ''}
                        </div>
                        
                        <!-- Status -->
                        <div style="min-width: 80px; flex-shrink: 0;">
                            <span class="firewall-status status-${data.wanManagement ? 'connected' : 'disconnected'}" style="white-space: nowrap; font-size: 0.8rem;">
                                ${data.wanManagement ? ' Enabled' : ' Disabled'}
                            </span>
                        </div>
                        
                        <!-- Rules Count -->
                        <div style="min-width: 100px; flex-shrink: 0;">
                            <span style="font-size: 0.8rem; color: var(--gray-600);">
                                ${data.wanToWanRules ? data.wanToWanRules.length : 0} rules
                            </span>
                        </div>
                        
                        <!-- Security Warnings -->
                        <div style="flex: 1; display: flex; align-items: center; gap: 0.5rem; justify-content: flex-end;">
                            ${data.wanManagement ? `
                                <div style="background: #dc2626; color: white; padding: 0.2rem 0.4rem; border-radius: 4px; font-size: 0.65rem; font-weight: 700; white-space: nowrap;">
                                    WAN ENABLED
                                </div>
                            ` : ''}
                            ${isResolved ? `
                                <span class="badge badge-success" style="font-size: 0.8rem; padding: 0.4rem 0.8rem;"> RSOLU - Rgles scurises</span>
                            ` : riskyRules.length > 0 && hasActions ? `
                                <span class="badge badge-warning" style="font-size: 0.8rem; padding: 0.4rem 0.8rem;"> ${riskyRules.length} rgle${riskyRules.length > 1 ? 's' : ''} restante${riskyRules.length > 1 ? 's' : ''}</span>
                            ` : riskyRules.length > 0 ? `
                                <span class="badge badge-danger" style="font-size: 0.8rem; padding: 0.4rem 0.8rem;"> ${riskyRules.length} rgle${riskyRules.length > 1 ? 's' : ''}  risque</span>
                            ` : ''}
                        </div>
                        
                        </div>
                        <span class="arrow"></span>
                    </div>
                    
                    <!-- Collapsible Details -->
                    <div id="wan-${data.firewall.id}" class="firewall-user-content" style="background: ${bgColor} !important;">
                        <div class="firewall-info" style="margin-bottom: 1rem; background: transparent !important;">
                            <div class="firewall-info-item">
                                <span class="firewall-info-label">WAN Management:</span>
                                <span class="firewall-info-value">${data.wanManagement ? ' Enabled' : ' Disabled'}</span>
                            </div>
                            <div class="firewall-info-item">
                                <span class="firewall-info-label">HTTPS Source:</span>
                                <span class="firewall-info-value">${data.httpsSource || 'Not configured'}</span>
                            </div>
                            <div class="firewall-info-item">
                                <span class="firewall-info-label">Rules Count:</span>
                                <span class="firewall-info-value">${data.wanToWanRules ? data.wanToWanRules.length : 0}</span>
                            </div>
                            <div class="firewall-info-item">
                                <span class="firewall-info-label">Last Checked:</span>
                                <span class="firewall-info-value">${formatDate(data.lastChecked)}</span>
                            </div>
                            ${data.error ? `
                            <div class="firewall-info-item">
                                <span class="firewall-info-label">Error:</span>
                                <span class="firewall-info-value" style="color: var(--error-600);">${data.error}</span>
                            </div>
                            ` : ''}
                        </div>
                        
                        <!-- Access Rules Table -->
                        ${data.wanToWanRules && data.wanToWanRules.length > 0 ? `
                        <div class="access-rules-section" style="background: transparent !important;">
                            ${(() => {
                                const riskyRules = data.wanToWanRules.filter(rule => 
                                    rule.source_address.toLowerCase().includes('any') && 
                                    (rule.service.toLowerCase().includes('http') || rule.service.toLowerCase().includes('management'))
                                );
                                return riskyRules.length > 0 ? `
                                    <div style="background: #fee2e2; border: 2px solid #ef4444; border-radius: 8px; padding: 0.75rem; margin-bottom: 1rem; animation: pulse 2s infinite;">
                                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                                            <span style="font-size: 1.2rem;"></span>
                                            <div>
                                                <strong style="color: #dc2626; font-size: 0.85rem;">SECURITY RISK DETECTED!</strong>
                                                <p style="margin: 0.25rem 0 0 0; color: #991b1b; font-size: 0.75rem;">
                                                    ${riskyRules.length} rule(s) allow ANY source to access HTTP/HTTPS Management
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                ` : '';
                            })()}
                            <div style="display: flex; justify-content: space-between; align-items: center; margin: 1rem 0 0.5rem 0;">
                                <h4 style="margin: 0; color: var(--gray-700); font-size: 0.9rem; font-weight: 600;">Access Rules:</h4>
                                <div style="display: flex; gap: 0.5rem; align-items: center;">
                                    <select id="status-filter-${data.firewall.id}" style="padding: 0.25rem 0.5rem; border: 1px solid var(--gray-300); border-radius: 4px; font-size: 0.8rem; background: white;" onchange="filterAccessRules('${data.firewall.id}')">
                                        <option value="all">All Status</option>
                                        <option value="enabled">Enabled</option>
                                        <option value="disabled">Disabled</option>
                                    </select>
                                    <select id="risk-filter-${data.firewall.id}" style="padding: 0.25rem 0.5rem; border: 1px solid var(--error-300); border-radius: 4px; font-size: 0.8rem; background: white; color: var(--error-700); font-weight: 600;" onchange="filterAccessRules('${data.firewall.id}')">
                                        <option value="all">All Rules</option>
                                        <option value="risky"> Risky Rules Only</option>
                                    </select>
                                </div>
                            </div>
                            <div style="overflow-x: auto;">
                                <table style="width: 100%; border-collapse: collapse; font-size: 0.85rem; table-layout: fixed; background: transparent !important;">
                                    <thead>
                                        <tr style="background: transparent !important; border-bottom: 2px solid var(--gray-200);">
                                            <th style="padding: 0.75rem 0.5rem; text-align: left; font-weight: 600; color: var(--gray-700); border-right: 1px solid var(--gray-200); width: 15%; background: transparent !important;">Source Zone</th>
                                            <th style="padding: 0.75rem 0.5rem; text-align: left; font-weight: 600; color: var(--gray-700); border-right: 1px solid var(--gray-200); width: 15%; background: transparent !important;">Dest Zone</th>
                                            <th style="padding: 0.75rem 0.5rem; text-align: left; font-weight: 600; color: var(--gray-700); border-right: 1px solid var(--gray-200); width: 20%; background: transparent !important;">Source Address</th>
                                            <th style="padding: 0.75rem 0.5rem; text-align: left; font-weight: 600; color: var(--gray-700); border-right: 1px solid var(--gray-200); width: 20%; background: transparent !important;">Dest Address</th>
                                            <th style="padding: 0.75rem 0.5rem; text-align: left; font-weight: 600; color: var(--gray-700); border-right: 1px solid var(--gray-200); width: 15%; background: transparent !important;">Service</th>
                                            <th style="padding: 0.75rem 0.5rem; text-align: left; font-weight: 600; color: var(--gray-700); width: 10%; background: transparent !important;">Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="access-rules-tbody-${data.firewall.id}" style="background: transparent !important;">
                                        ${data.wanToWanRules.map(rule => {
                                            const isRisky = rule.source_address.toLowerCase().includes('any') && 
                                                           (rule.service.toLowerCase().includes('http') || rule.service.toLowerCase().includes('management'));
                                            return `
                                            <tr class="access-rule-row" data-status="${rule.enabled ? 'enabled' : 'disabled'}" data-risky="${isRisky ? 'risky' : 'safe'}" style="border-bottom: 1px solid var(--gray-100); background: transparent !important;">
                                                <td style="padding: 0.75rem 0.5rem; border-right: 1px solid var(--gray-200); font-weight: 600; color: var(--gray-800); background: transparent !important;">${rule.from_zone}</td>
                                                <td style="padding: 0.75rem 0.5rem; border-right: 1px solid var(--gray-200); font-weight: 600; color: var(--gray-800); background: transparent !important;">${rule.to_zone}</td>
                                                <td style="padding: 0.75rem 0.5rem; border-right: 1px solid var(--gray-200); color: ${isRisky ? '#dc2626' : 'var(--gray-700)'}; font-weight: ${isRisky ? '700' : '500'}; background: transparent !important;">${rule.source_address}</td>
                                                <td style="padding: 0.75rem 0.5rem; border-right: 1px solid var(--gray-200); color: var(--gray-700); background: transparent !important;">${rule.destination_address}</td>
                                                <td style="padding: 0.75rem 0.5rem; border-right: 1px solid var(--gray-200); color: ${isRisky ? '#dc2626' : 'var(--gray-700)'}; font-weight: ${isRisky ? '700' : '500'}; background: transparent !important;">${rule.service}</td>
                                                <td style="padding: 0.75rem 0.5rem; text-align: center; background: transparent !important;">
                                                    <span style="padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600; background: transparent !important; color: ${rule.enabled ? 'var(--success-700)' : 'var(--gray-600)'};">
                                                        ${rule.enabled ? ' Active' : ' Inactive'}
                                                    </span>
                                                </td>
                                            </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        ` : ''}
                        
                        <div class="firewall-actions" style="margin-top: 1rem; background: transparent !important;">
                            <button class="btn btn-secondary" onclick="refreshWANStatus('${data.firewall.id}')">
                                <span></span> Refresh
                            </button>
                        </div>
                    </div>
                </div>
                `;
            }).join('');
        }

        function toggleWANDetails(firewallId) {
            const detailsDiv = document.getElementById(`wan-details-${firewallId}`);
            const toggleIcon = document.getElementById(`wan-toggle-icon-${firewallId}`);
            
            if (detailsDiv.style.display === 'none' || detailsDiv.style.display === '') {
                // Open
                detailsDiv.style.display = 'block';
                toggleIcon.style.transform = 'rotate(180deg)';
            } else {
                // Close
                detailsDiv.style.display = 'none';
                toggleIcon.style.transform = 'rotate(0deg)';
            }
        }

        function refreshWANStatus(firewallId = null) {
            if (firewallId) {
                // Refresh specific firewall
                checkWANManagement();
            } else {
                // Refresh all
                checkWANManagement();
            }
        }

        function switchWANSubmenu(view) {
            // Update buttons
            document.querySelectorAll('#wan-management-section .submenu-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.getAttribute('data-submenu') === view) {
                    btn.classList.add('active');
                }
            });
            
            // Update content
            document.getElementById('wan-monitoring').classList.toggle('active', view === 'monitoring');
            document.getElementById('wan-remediation').classList.toggle('active', view === 'remediation');
            
            // Load remediation data if switching to remediation
            if (view === 'remediation') {
                loadWANRemediation();
            }
        }

        async function loadWANRemediation() {
            if (firewalls.length === 0) {
                showAlert('warning', 'No firewalls available. Add firewalls first.', 'wan-alert-container');
                return;
            }

            const remediationGrid = document.getElementById('wan-remediation-grid');
            remediationGrid.innerHTML = '';

            for (const firewall of firewalls) {
                try {
                    // Get WAN management data
                    const wanResponse = await fetch('/api/wan-management', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            ip: firewall.ip,
                            username: firewall.username,
                            password: firewall.password
                        })
                    });
                    const wanData = await wanResponse.json();
                    
                    // Get remediation status
                    const statusResponse = await fetch(`/api/remediation/status/${firewall.id}/wan_management`);
                    const statusData = await statusResponse.json();
                    
                    const rules = wanData.wan_to_wan_rules || [];
                    const atRiskRules = rules.filter(r => r.is_at_risk);
                    console.log('WAN Remediation - atRiskRules:', atRiskRules);
                    console.log('UUIDs:', atRiskRules.map(r => r.uuid));
                    
                    const isResolved = statusData.status?.is_resolved || false;
                    const hasActions = statusData.actions && statusData.actions.length > 0;
                    
                    let statusColor, statusText, statusIcon;
                    if (atRiskRules.length === 0) {
                        statusColor = '#dcfce7';
                        statusText = ' SAFE - Aucune rgle  risque';
                        statusIcon = '';
                    } else if (isResolved) {
                        statusColor = '#dcfce7';
                        statusText = ' RSOLU - Toutes les rgles scurises';
                        statusIcon = '';
                    } else if (hasActions) {
                        // Partiellement rsolu (des actions ont t faites mais pas tout)
                        statusColor = '#fef3c7';
                        statusText = ` PARTIELLEMENT RSOLU - ${atRiskRules.length} rgle(s) restante(s)  scuriser`;
                        statusIcon = '';
                    } else {
                        statusColor = '#fee2e2';
                        statusText = ` CRITIQUE - ${atRiskRules.length} rgle(s)  risque (source ANY)`;
                        statusIcon = '';
                    }
                    
                    const firewallCard = document.createElement('div');
                    firewallCard.className = 'remediation-card';
                    firewallCard.style.cssText = `
                        background: ${statusColor};
                        border: 2px solid ${statusColor === '#fee2e2' ? '#ef4444' : statusColor === '#fef3c7' ? '#f59e0b' : 'var(--gray-200)'};
                        border-radius: 12px;
                        padding: 1.5rem;
                        margin-bottom: 1rem;
                        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                    `;
                    
                    let rulesHTML = '';
                    if (atRiskRules.length > 0) {
                        rulesHTML = '<strong>Rgles  risque:</strong><ul style="margin: 0.5rem 0; padding-left: 1.5rem;">';
                        atRiskRules.forEach(rule => {
                            rulesHTML += `<li>${rule.name} - Source: ${rule.source_address}  Dest: ${rule.destination_address}</li>`;
                        });
                        rulesHTML += '</ul>';
                    }
                    
                    firewallCard.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <div>
                                <h3 style="margin: 0; font-size: 1.1rem;">
                                     ${firewall.name || firewall.ip} (${firewall.ip})
                                </h3>
                                <p style="margin: 0.5rem 0 0 0; color: var(--gray-600); font-size: 0.9rem;">
                                    ${statusIcon} ${statusText}
                                </p>
                            </div>
                        </div>
                        
                        ${rulesHTML ? `<div style="margin-bottom: 1rem;">${rulesHTML}</div>` : ''}
                        
                        ${isResolved ? `
                            <div style="background: #dcfce7; border: 1px solid #22c55e; border-radius: 8px; padding: 1rem;">
                                <strong> Problme rsolu</strong><br>
                                ${statusData.status?.notes || 'Rgles scurises'}
                            </div>
                        ` : atRiskRules.length > 0 ? `
                            <div style="margin-bottom: 1rem;">
                                ${hasActions ? `
                                    <div style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; padding: 0.75rem; margin-bottom: 0.75rem; font-size: 0.9rem;">
                                        <strong> Action partielle effectue</strong><br>
                                        ${statusData.status?.notes || 'Certaines rgles ont t scurises'}
                                    </div>
                                ` : ''}
                                <button 
                                    class="btn wan-remediation-btn ${hasActions ? 'btn-warning' : 'btn-danger'}" 
                                    data-firewall-id="${firewall.id}"
                                    style="${hasActions ? 'background: #f59e0b; border-color: #f59e0b;' : ''}">
                                     Scuriser les ${hasActions ? 'rgles restantes' : 'rgles'}
                                </button>
                            </div>
                        ` : `
                            <div style="background: #dcfce7; border: 1px solid #22c55e; border-radius: 8px; padding: 1rem;">
                                <strong> Safe</strong> - Aucune rgle WAN-to-WAN avec source ANY
                            </div>
                        `}
                    `;
                    
                    remediationGrid.appendChild(firewallCard);
                    
                    // Attacher l'event listener au bouton
                    const button = firewallCard.querySelector('.wan-remediation-btn');
                    if (button) {
                        button.addEventListener('click', () => {
                            console.log('Button clicked, calling confirmWANRemediation');
                            confirmWANRemediation(firewall.id, atRiskRules.map(r => r.uuid));
                        });
                    }
                } catch (error) {
                    console.error('Error loading WAN remediation:', error);
                }
            }
        }

        function confirmWANRemediation(firewallId, ruleUuids) {
            console.log('confirmWANRemediation called');
            console.log('firewallId:', firewallId, 'type:', typeof firewallId);
            console.log('ruleUuids:', ruleUuids);
            
            const firewall = firewalls.find(f => f.id === firewallId);
            console.log('firewall found:', firewall);
            
            if (!firewall) {
                showAlert('error', 'Firewall non trouv', 'wan-alert-container');
                return;
            }

            const modalHtml = `
                <div id="wan-remediation-modal" style="
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0,0,0,0.5);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 9999;
                ">
                    <div style="
                        background: white;
                        border-radius: 12px;
                        padding: 2rem;
                        max-width: 500px;
                        width: 90%;
                        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                    ">
                        <h3 style="margin: 0 0 1rem 0; color: var(--gray-900);">
                             Scuriser les rgles WAN Management
                        </h3>
                        <p style="margin-bottom: 1.5rem; color: var(--gray-600);">
                            Pour scuriser les rgles  risque, vous devez crer un objet address IPv4 avec votre IP publique.
                            Cet objet remplacera la source "ANY" dans les ${ruleUuids.length} rgle(s) slectionne(s).
                        </p>
                        
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">
                                Nom de l'objet address:
                            </label>
                            <input 
                                type="text" 
                                id="wan-object-name" 
                                placeholder="Ex: Mon_IP_Publique"
                                style="
                                    width: 100%;
                                    padding: 0.5rem;
                                    border: 1px solid var(--gray-300);
                                    border-radius: 4px;
                                    font-size: 0.9rem;
                                "
                            >
                        </div>
                        
                        <div style="margin-bottom: 1.5rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">
                                Votre IP publique:
                            </label>
                            <input 
                                type="text" 
                                id="wan-object-ip" 
                                placeholder="Ex: 203.0.113.42"
                                style="
                                    width: 100%;
                                    padding: 0.5rem;
                                    border: 1px solid var(--gray-300);
                                    border-radius: 4px;
                                    font-size: 0.9rem;
                                "
                            >
                        </div>
                        
                        <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
                            <button class="btn btn-secondary" onclick="closeWANModal()">Annuler</button>
                            <button class="btn btn-danger" id="wan-execute-btn">
                                Scuriser maintenant
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Attacher l'event listener au bouton "Scuriser maintenant"
            const executeBtn = document.getElementById('wan-execute-btn');
            if (executeBtn) {
                executeBtn.addEventListener('click', () => {
                    executeWANRemediation(firewallId, ruleUuids);
                });
            }
        }

        function closeWANModal() {
            const modal = document.getElementById('wan-remediation-modal');
            if (modal) {
                modal.remove();
            }
        }

        async function executeWANRemediation(firewallId, ruleUuids) {
            const objectName = document.getElementById('wan-object-name')?.value?.trim();
            const objectIp = document.getElementById('wan-object-ip')?.value?.trim();
            
            if (!objectName) {
                alert('Veuillez entrer un nom pour l\'objet address');
                return;
            }
            
            if (!objectIp) {
                alert('Veuillez entrer votre IP publique');
                return;
            }
            
            // Basic IP validation
            const ipPattern = /^(\d{1,3}\.){3}\d{1,3}$/;
            if (!ipPattern.test(objectIp)) {
                alert('Format d\'IP invalide. Utilisez le format xxx.xxx.xxx.xxx');
                return;
            }

            closeWANModal();

            try {
                showAlert('warning', 'Scurisation des rgles WAN en cours...', 'wan-alert-container');
                
                const response = await fetch('/api/remediation/wan-management/fix-rules', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        firewall_id: firewallId,
                        object_name: objectName,
                        object_ip: objectIp,
                        rule_uuids: ruleUuids
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert('success', `${result.message}`, 'wan-alert-container');
                    // Reload remediation view
                    loadWANRemediation();
                    // Reload monitoring view
                    checkWANManagement();
                } else {
                    showAlert('error', `Erreur: ${result.message}`, 'wan-alert-container');
                }
            } catch (error) {
                console.error('Error executing WAN remediation:', error);
                showAlert('error', `Erreur lors de l'excution: ${error.message}`, 'wan-alert-container');
            }
        }

        // Active Directory Functions
        async function checkActiveDirectory() {
            if (firewalls.length === 0) {
                showAlert('warning', 'No firewalls available. Add firewalls first.', 'ad-alert-container');
                return;
            }

            showAlert('warning', 'Checking Active Directory configuration...', 'ad-alert-container');
            
            const adData = [];
            
            for (const firewall of firewalls) {
                try {
                    const response = await fetch('/api/active-directory', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            ip: firewall.ip,
                            username: firewall.username,
                            password: firewall.password
                        })
                    });

                    const result = await response.json();
                    
                    const adConfig = result.ad_config || {};
                    
                    adData.push({
                        firewall: firewall,
                        adEnabled: adConfig.enabled || false,
                        bindPassword: adConfig.bind_password || 'Not configured',
                        originalBindPassword: adConfig.original_bind_password || '',
                        domain: adConfig.domain || 'Not configured',
                        server: adConfig.server || 'Not configured',
                        baseDN: adConfig.base_dn || 'Not configured',
                        bindUser: adConfig.bind_user || 'Not configured',
                        lastChecked: new Date().toISOString()
                    });
                } catch (error) {
                    adData.push({
                        firewall: firewall,
                        adEnabled: false,
                        bindPassword: 'Error',
                        originalBindPassword: '',
                        domain: 'Error',
                        server: 'Error',
                        baseDN: 'Error',
                        bindUser: 'Error',
                        error: error.message,
                        lastChecked: new Date().toISOString()
                    });
                }
            }

            renderActiveDirectory(adData);
            showAlert('success', 'Active Directory check completed', 'ad-alert-container');
        }

        function renderActiveDirectory(adData) {
            const container = document.getElementById('active-directory-grid');
            
            if (adData.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon"></div>
                        <h3>No Active Directory Data</h3>
                        <p>Click "Check AD Configuration" to analyze Active Directory settings</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = adData.map(data => {
                // Check if AD is enabled with a bind password (security risk)
                const hasBindPassword = data.adEnabled && 
                                       data.bindPassword !== 'Not configured' && 
                                       data.bindPassword !== 'Error' && 
                                       data.originalBindPassword;
                
                return `
                <div class="firewall-card ${data.adEnabled ? 'connected' : 'disconnected'}" id="ad-${data.firewall.id}" style="padding: 0.75rem 1rem; display: flex; align-items: center; gap: 1rem; background: ${hasBindPassword ? '#fee2e2' : 'white'}; transition: all 0.2s;">
                    <!-- Firewall Name/IP -->
                    <div style="min-width: 200px; flex-shrink: 0;">
                        <div style="font-size: 1rem; font-weight: 700; color: ${hasBindPassword ? '#991b1b' : 'var(--gray-900)'}; white-space: nowrap;">
                            ${hasBindPassword ? ' ' : ''}${data.firewall.name || data.firewall.ip}
                        </div>
                        ${data.firewall.name ? `<div style="font-size: 0.75rem; color: var(--gray-500); margin-top: 0.1rem;">${data.firewall.ip}</div>` : ''}
                    </div>
                    
                    <!-- AD Status -->
                    <div style="min-width: 120px; flex-shrink: 0;">
                        <span class="firewall-status status-${data.adEnabled ? 'connected' : 'disconnected'}" style="white-space: nowrap; font-size: 0.8rem;">
                            ${data.adEnabled ? ' Enabled' : ' Disabled'}
                        </span>
                    </div>
                    
                    <!-- Server Info -->
                    <div style="min-width: 150px; flex-shrink: 0;">
                        <span style="font-size: 0.8rem; color: var(--gray-600);">
                            <strong>Server:</strong> ${data.server || 'None'}
                        </span>
                    </div>
                    
                    <!-- Base DN -->
                    <div style="min-width: 200px; flex-shrink: 0;">
                        <span style="font-size: 0.8rem; color: var(--gray-600);">
                            <strong>Base DN:</strong> ${data.baseDN || 'N/A'}
                        </span>
                    </div>
                    
                    <!-- Bind User -->
                    <div style="min-width: 150px; flex-shrink: 0;">
                        <span style="font-size: 0.8rem; color: var(--gray-600);">
                            <strong>Bind User:</strong> ${data.bindUser || 'N/A'}
                        </span>
                    </div>
                    
                    <!-- Bind Password Status -->
                    <div style="min-width: 120px; flex-shrink: 0;">
                        <span style="font-size: 0.8rem; color: ${hasBindPassword ? '#dc2626' : 'var(--gray-600)'}; font-weight: ${hasBindPassword ? '700' : '500'};">
                            <strong>Password:</strong> ${hasBindPassword ? ' SET' : 'Not Set'}
                        </span>
                    </div>
                    
                    <!-- Security Warning -->
                    <div style="flex: 1; display: flex; align-items: center; gap: 0.5rem; justify-content: flex-end;">
                        ${hasBindPassword ? `
                            <div style="background: #dc2626; color: white; padding: 0.2rem 0.4rem; border-radius: 4px; font-size: 0.65rem; font-weight: 700; white-space: nowrap;">
                                BIND PASSWORD RISK
                            </div>
                        ` : ''}
                    </div>
                    
                    <!-- Last Checked -->
                    <div style="min-width: 150px; flex-shrink: 0; text-align: right;">
                        <span style="font-size: 0.75rem; color: var(--gray-500);">
                            ${formatDate(data.lastChecked)}
                        </span>
                </div>
            `}).join('');
        }


        function refreshADStatus(firewallId = null) {
            if (firewallId) {
                // Refresh specific firewall
                checkActiveDirectory();
            } else {
                // Refresh all
                checkActiveDirectory();
            }
        }

        // IPSEC VPN Functions
        async function checkIPSECVPN() {
            if (firewalls.length === 0) {
                showAlert('warning', 'No firewalls available. Add firewalls first.', 'ipsec-alert-container');
                return;
            }

            showAlert('warning', 'Checking IPSEC VPN tunnels...', 'ipsec-alert-container');
            
            const vpnData = [];
            
            for (const firewall of firewalls) {
                try {
                    const response = await fetch('/api/ipsec-vpn', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            ip: firewall.ip,
                            username: firewall.username,
                            password: firewall.password
                        })
                    });

                    const result = await response.json();
                    
                    // Get remediation status
                    const statusResponse = await fetch(`/api/remediation/status/${firewall.id}/ipsec_vpn`);
                    const statusData = await statusResponse.json();
                    
                    vpnData.push({
                        firewall: firewall,
                        tunnels: result.tunnels || [],
                        aggressiveTunnels: result.tunnels ? result.tunnels.filter(t => t.enabled && t.mode === 'aggressive').length : 0,
                        lastChecked: new Date().toISOString(),
                        remediationStatus: statusData
                    });
                } catch (error) {
                    vpnData.push({
                        firewall: firewall,
                        tunnels: [],
                        aggressiveTunnels: 0,
                        error: error.message,
                        lastChecked: new Date().toISOString()
                    });
                }
            }

            renderIPSECVPN(vpnData);
            showAlert('success', 'IPSEC VPN check completed', 'ipsec-alert-container');
        }

        function renderIPSECVPN(data) {
            const grid = document.getElementById('ipsec-grid');
            
            if (data.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon"></div>
                        <h3>No VPN Tunnel Data</h3>
                        <p>Loading IPSEC VPN tunnels automatically...</p>
                    </div>
                `;
                return;
            }

            grid.innerHTML = data.map((item, index) => {
                const fwName = item.firewall.name || item.firewall.ip;
                const tunnels = item.tunnels || [];
                
                // Compter les tunnels par catgorie
                const aggressiveActiveTunnels = tunnels.filter(t => t.enabled && t.mode === 'aggressive').length;
                const mainActiveTunnels = tunnels.filter(t => t.enabled && t.mode !== 'aggressive').length;
                const activeTunnels = tunnels.filter(t => t.enabled).length;
                
                // Rcuprer le status de remediation
                const isResolved = item.remediationStatus?.status?.is_resolved || false;
                
                // Dterminer la couleur et le style en fonction du status (comme SSO)
                let bgColor, borderColor, textColor, hoverColor, badgeText, badgeClass;
                
                // PRIORIT 1 : Si rsolu  VERT
                if (isResolved) {
                    bgColor = '#dcfce7';
                    borderColor = '#22c55e';
                    textColor = '#166534';
                    hoverColor = '#bbf7d0';
                    badgeText = ' RSOLU - Passphrases changes';
                    badgeClass = 'badge-success';
                }
                // PRIORIT 2 : Tunnels actifs en Aggressive  ROUGE
                else if (aggressiveActiveTunnels > 0) {
                    bgColor = '#fee2e2';
                    borderColor = '#ef4444';
                    textColor = '#991b1b';
                    hoverColor = '#fecaca';
                    badgeText = ` ${aggressiveActiveTunnels} Aggressive actif${aggressiveActiveTunnels !== 1 ? 's' : ''} (CRITIQUE)`;
                    badgeClass = 'badge-danger';
                }
                // PRIORIT 3 : Tunnels actifs en Main  ORANGE
                else if (mainActiveTunnels > 0) {
                    bgColor = '#fef3c7';
                    borderColor = '#f59e0b';
                    textColor = '#92400e';
                    hoverColor = '#fde68a';
                    badgeText = ` ${mainActiveTunnels} Main actif${mainActiveTunnels !== 1 ? 's' : ''} (Passphrase  changer)`;
                    badgeClass = 'badge-warning';
                }
                // PRIORIT 4 : Pas de tunnels ou tous inactifs  GRIS/VERT
                else if (tunnels.length === 0) {
                    bgColor = 'var(--gray-50)';
                    borderColor = '';
                    textColor = 'var(--gray-900)';
                    hoverColor = 'var(--gray-100)';
                    badgeText = 'Aucun tunnel';
                    badgeClass = 'badge-secondary';
                } else {
                    bgColor = '#dcfce7';
                    borderColor = '#22c55e';
                    textColor = '#166534';
                    hoverColor = '#bbf7d0';
                    badgeText = 'Tous inactifs';
                    badgeClass = 'badge-success';
                }
                
                return `
                    <div class="firewall-user-accordion">
                        <div class="firewall-user-header ${''}" onclick="toggleUserAccordion('ipsec-${item.firewall.id}')" style="background: ${bgColor}; ${borderColor ? 'border: 2px solid ' + borderColor + ';' : ''}" onmouseover="this.style.background='${hoverColor}'" onmouseout="this.style.background='${bgColor}'">
                            <div class="fw-name">
                                <span></span>
                                <span style="color: ${textColor};">${fwName} (${item.firewall.ip})</span>
                            </div>
                            <span class="badge ${badgeClass}">${badgeText}</span>
                            ${activeTunnels > 0 ? `
                                <span class="badge badge-info">Total actifs: ${activeTunnels}</span>
                            ` : ''}
                            <span class="arrow"></span>
                        </div>
                        <div id="ipsec-${item.firewall.id}" class="firewall-user-content ${''}">
                            ${item.error ? `
                                <div class="alert alert-danger"><strong>Error:</strong> ${item.error}</div>
                            ` : tunnels.length === 0 ? `
                                <div class="empty-state"><p>No VPN tunnels configured on this firewall</p></div>
                            ` : `
                                <table class="users-table">
                                    <thead>
                                        <tr>
                                            <th>Tunnel Name</th>
                                            <th>Type</th>
                                            <th>Status</th>
                                            <th>Mode</th>
                                            <th>Risque</th>
                                            <th>Primary Gateway</th>
                                            <th>Local Network</th>
                                            <th>Remote Network</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${tunnels.map(tunnel => {
                                            const isAggressive = tunnel.mode === 'aggressive';
                                            const isActive = tunnel.enabled;
                                            const isAtRisk = tunnel.is_at_risk || (isActive && isAggressive);
                                            
                                            let rowBg = 'white';
                                            let riskBadge = '<span class="badge badge-secondary"></span>';
                                            
                                            if (isActive && isAggressive) {
                                                rowBg = '#fef2f2'; // Rouge clair
                                                riskBadge = '<span class="badge badge-danger"> CRITIQUE</span>';
                                            } else if (isActive) {
                                                rowBg = '#fffbeb'; // Orange clair
                                                riskBadge = '<span class="badge badge-warning"> Passphrase  changer</span>';
                                            }
                                            
                                            return `
                                                <tr style="background: ${rowBg};">
                                                    <td><strong>${tunnel.name}</strong></td>
                                                    <td><span class="badge badge-info">${tunnel.type || 'site-to-site'}</span></td>
                                                    <td>${isActive ? '<span class="badge badge-success"> Actif</span>' : '<span class="badge badge-secondary"> Inactif</span>'}</td>
                                                    <td>
                                                        ${isAggressive ? 
                                                            '<span class="badge badge-danger"> Aggressive</span>' : 
                                                            '<span class="badge badge-success"> Main</span>'}
                                                    </td>
                                                    <td>${riskBadge}</td>
                                                    <td>${tunnel.primary_gateway}</td>
                                                    <td>${tunnel.local_network}</td>
                                                    <td>${tunnel.remote_network}</td>
                                                </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            `}
                        </div>
                    </div>
                `;
            }).join('');
        }


        function refreshVPNStatus() {
            checkIPSECVPN();
        }

        function refreshIPSECStatus(firewallId = null) {
            checkIPSECVPN();
        }


        function switchIPSECSubmenu(submenu) {
            const section = document.getElementById('ipsec-vpn-section');
            section.querySelectorAll('.module-submenu .submenu-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            section.querySelector(`[data-submenu="${submenu}"]`).classList.add('active');
            
            section.querySelectorAll('.submenu-content').forEach(content => {
                content.classList.remove('active');
            });
            
            if (submenu === 'monitoring') {
                document.getElementById('ipsec-monitoring').classList.add('active');
                checkIPSECVPN(); // Load data when switching to monitoring
            } else if (submenu === 'remediation') {
                document.getElementById('ipsec-remediation').classList.add('active');
                loadIPSECRemediation();
            }
        }

        async function loadIPSECRemediation() {
            const grid = document.getElementById('ipsec-remediation-grid');
            
            if (firewalls.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon"></div>
                        <h3>No Firewalls Available</h3>
                        <p>Add firewalls first to perform remediation</p>
                    </div>
                `;
                return;
            }

            // Show loading
            grid.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon"></div>
                    <h3>Loading Remediation Data...</h3>
                    <p>Checking IPSEC VPN tunnels for remediation...</p>
                </div>
            `;

            const remediationData = [];
            
            for (const firewall of firewalls) {
                try {
                    // Get VPN data
                    const vpnResponse = await fetch('/api/ipsec-vpn', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            ip: firewall.ip,
                            username: firewall.username,
                            password: firewall.password
                        })
                    });

                    const vpnResult = await vpnResponse.json();
                    
                    // Get remediation status
                    const statusResponse = await fetch(`/api/remediation/status/${firewall.id}/ipsec_vpn`);
                    const statusData = await statusResponse.json();
                    
                    const tunnels = vpnResult.tunnels || [];
                    // Identifier les tunnels actifs en Aggressive (CRITIQUE) et Main (IMPORTANT)
                    const activeTunnels = tunnels.filter(t => t.enabled);
                    const aggressiveTunnels = activeTunnels.filter(t => t.mode === 'aggressive');
                    const mainTunnels = activeTunnels.filter(t => t.mode !== 'aggressive');
                    
                    // Extraire les tunnels dj modifis depuis les notes du status
                    let modifiedTunnelNames = [];
                    const notes = statusData.status?.notes;  // Corriger l'accs aux notes
                    if (notes) {
                        const match = notes.match(/Tunnels modifis: \[(.*?)\]/);
                        if (match) {
                            modifiedTunnelNames = match[1].split(',').map(t => t.trim()).filter(t => t);
                        }
                    }
                    
                    console.log(`[IPSEC DEBUG] Firewall: ${firewall.name}`);
                    console.log(`  Status notes: ${notes}`);
                    console.log(`  Modified tunnels from DB:`, modifiedTunnelNames);
                    console.log(`  Active tunnels:`, activeTunnels.map(t => t.name));
                    
                    // Filtrer pour ne garder que les tunnels actifs NON modifis
                    const tunnelsToModify = activeTunnels.filter(t => {
                        const isModified = modifiedTunnelNames.includes(t.name);
                        console.log(`    Tunnel "${t.name}": modified=${isModified}`);
                        return !isModified;
                    });
                    const aggressiveToModify = tunnelsToModify.filter(t => t.mode === 'aggressive');
                    const mainToModify = tunnelsToModify.filter(t => t.mode !== 'aggressive');
                    
                    console.log(`  Tunnels to modify:`, tunnelsToModify.map(t => t.name));
                    console.log(`  Aggressive to modify:`, aggressiveToModify.length);
                    console.log(`  Main to modify:`, mainToModify.length);
                    
                    remediationData.push({
                        firewall: firewall,
                        tunnels: tunnels,
                        activeTunnels: tunnelsToModify,  // Seulement ceux  modifier
                        aggressiveTunnels: aggressiveToModify,
                        mainTunnels: mainToModify,
                        modifiedTunnels: modifiedTunnelNames,
                        remediationStatus: statusData
                    });
                } catch (error) {
                    remediationData.push({
                        firewall: firewall,
                        tunnels: [],
                        activeTunnels: [],
                        aggressiveTunnels: [],
                        mainTunnels: [],
                        error: error.message,
                        remediationStatus: { is_resolved: false }
                    });
                }
            }

            renderIPSECRemediation(remediationData);
        }

        function renderIPSECRemediation(data) {
            const grid = document.getElementById('ipsec-remediation-grid');
            
            if (data.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon"></div>
                        <h3>No IPSEC VPN Remediation Data</h3>
                        <p>No firewalls available for remediation</p>
                    </div>
                `;
                return;
            }

            grid.innerHTML = data.map((item, index) => {
                const fwName = item.firewall.name || item.firewall.ip;
                const activeTunnels = item.activeTunnels || [];
                const aggressiveTunnels = item.aggressiveTunnels || [];
                const mainTunnels = item.mainTunnels || [];
                const modifiedTunnels = item.modifiedTunnels || [];
                const isResolved = item.remediationStatus?.status?.is_resolved || false;  // Corriger l'accs
                const hasActions = modifiedTunnels.length > 0;
                
                // Debug log
                console.log(`[IPSEC REMEDIATION RENDER] Firewall: ${fwName}`);
                console.log(`  - isResolved: ${isResolved}`);
                console.log(`  - activeTunnels: ${activeTunnels.length}`);
                console.log(`  - aggressiveTunnels: ${aggressiveTunnels.length}`);
                console.log(`  - mainTunnels: ${mainTunnels.length}`);
                console.log(`  - modifiedTunnels: ${modifiedTunnels.length}`);
                console.log(`  - hasActions: ${hasActions}`);
                console.log(`  - remediationStatus:`, item.remediationStatus);
                
                // Determine colors based on status (simplifi comme SSO)
                let bgColor, borderColor, textColor, hoverColor;
                
                // Si rsolu (comme SSO) : VERT
                if (isResolved) {
                    bgColor = '#dcfce7';
                    borderColor = '#22c55e';
                    textColor = '#166534';
                    hoverColor = '#bbf7d0';
                }
                // Si au moins 1 tunnel modifi mais pas tous : ORANGE
                else if (hasActions && activeTunnels.length > 0) {
                    bgColor = '#fef3c7';
                    borderColor = '#f59e0b';
                    textColor = '#92400e';
                    hoverColor = '#fde68a';
                }
                // Si des tunnels  risque (aggressive actifs) : ROUGE
                else if (aggressiveTunnels.length > 0) {
                    bgColor = '#fee2e2';
                    borderColor = '#ef4444';
                    textColor = '#991b1b';
                    hoverColor = '#fecaca';
                }
                // Si seulement des tunnels Main actifs : ORANGE
                else if (mainTunnels.length > 0) {
                    bgColor = '#fef3c7';
                    borderColor = '#f59e0b';
                    textColor = '#92400e';
                    hoverColor = '#fde68a';
                }
                // Sinon (aucun tunnel actif) : VERT
                else {
                    bgColor = '#dcfce7';
                    borderColor = '#22c55e';
                    textColor = '#166534';
                    hoverColor = '#bbf7d0';
                }
                
                return `
                    <div class="firewall-user-accordion" style="background: ${bgColor} !important; border: 2px solid ${borderColor} !important;">
                        <div class="firewall-user-header" onclick="toggleUserAccordion('ipsec-remediation-${item.firewall.id}')" style="background: ${bgColor} !important;" onmouseover="this.parentElement.style.background='${hoverColor} !important'" onmouseout="this.parentElement.style.background='${bgColor} !important'">
                            <div class="fw-name">
                                <span></span>
                                <span style="color: ${textColor};">${fwName} (${item.firewall.ip})</span>
                            </div>
                            <div style="flex: 1; display: flex; align-items: center; gap: 0.5rem; justify-content: flex-end;">
                                ${isResolved ? `
                                    <span class="badge badge-success" style="font-size: 0.8rem; padding: 0.4rem 0.8rem;"> RSOLU - Passphrases changes</span>
                                ` : aggressiveTunnels.length > 0 ? `
                                    <span class="badge badge-danger"> ${aggressiveTunnels.length} Aggressive (CRITIQUE)</span>
                                    ${mainTunnels.length > 0 ? `<span class="badge badge-warning"> ${mainTunnels.length} Main</span>` : ''}
                                ` : mainTunnels.length > 0 ? `
                                    <span class="badge badge-warning"> ${mainTunnels.length} Main actif${mainTunnels.length !== 1 ? 's' : ''} (Passphrase  changer)</span>
                                ` : `
                                    <span class="badge badge-success"> Aucun tunnel actif</span>
                                `}
                            </div>
                            <span class="arrow"></span>
                        </div>
                        <div id="ipsec-remediation-${item.firewall.id}" class="firewall-user-content" style="background: ${bgColor} !important;">
                            ${item.error ? `
                                <div class="alert alert-danger">
                                    <strong>Error:</strong> ${item.error}
                                </div>
                            ` : activeTunnels.length === 0 && isResolved ? `
                                <div style="margin-bottom: 1rem; padding: 1rem; background: #dcfce7; border: 1px solid #22c55e; border-radius: 8px;">
                                    <strong> RSOLU - Tous les tunnels actifs ont t scuriss</strong><br>
                                    ${modifiedTunnels.length > 0 ? `Les passphrases des tunnels suivants ont t changes : <strong>${modifiedTunnels.join(', ')}</strong>` : 'Tous les tunnels ncessitant une remediation ont eu leur passphrase change.'}
                                </div>
                            ` : activeTunnels.length === 0 ? `
                                <div style="margin-bottom: 1rem; padding: 1rem; background: #dcfce7; border: 1px solid #22c55e; border-radius: 8px;">
                                    <strong> Aucun tunnel actif</strong><br>
                                    Tous les tunnels IPSEC sont dsactivs. Aucune action requise.
                                </div>
                            ` : `
                                <div style="margin-bottom: 1rem;">
                                    ${hasActions ? `
                                        <div style="background: #dcfce7; border: 1px solid #22c55e; border-radius: 8px; padding: 1rem; margin-bottom: 0.75rem;">
                                            <strong> ${modifiedTunnels.length} tunnel${modifiedTunnels.length !== 1 ? 's' : ''} dj scuris${modifiedTunnels.length !== 1 ? 's' : ''}</strong><br>
                                            <small style="color: var(--gray-600);">${modifiedTunnels.join(', ')}</small>
                                        </div>
                                    ` : ''}
                                    
                                    ${activeTunnels.length === 0 && hasActions ? `
                                        <div style="margin-bottom: 1rem; padding: 1rem; background: #dcfce7; border: 1px solid #22c55e; border-radius: 8px;">
                                            <strong> RSOLU - Tous les tunnels actifs ont t scuriss</strong><br>
                                            Tous les tunnels ncessitant une remediation ont eu leur passphrase change.
                                        </div>
                                    ` : ''}
                                    
                                    ${aggressiveTunnels.length > 0 ? `
                                        <div style="background: #fee2e2; border: 2px solid #ef4444; border-radius: 8px; padding: 0.75rem; margin-bottom: 1rem;">
                                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                                <span style="font-size: 1.2rem;"></span>
                                                <div>
                                                    <strong>CRITIQUE!</strong> ${aggressiveTunnels.length} tunnel${aggressiveTunnels.length > 1 ? 's' : ''} en mode Aggressive (vulnrable aux attaques par force brute)
                                                </div>
                                            </div>
                                        </div>
                                    ` : ''}
                                    
                                    ${mainTunnels.length > 0 ? `
                                        <div style="background: #fef3c7; border: 2px solid #f59e0b; border-radius: 8px; padding: 0.75rem; margin-bottom: 1rem;">
                                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                                <span style="font-size: 1.2rem;"></span>
                                                <div>
                                                    <strong>IMPORTANT!</strong> ${mainTunnels.length} tunnel${mainTunnels.length > 1 ? 's' : ''} actif${mainTunnels.length > 1 ? 's' : ''} en mode Main - Passphrase  changer suite  la compromission des backups
                                                </div>
                                            </div>
                                        </div>
                                    ` : ''}
                                    
                                    <div style="margin-bottom: 1.5rem;">
                                        <h4 style="margin: 0 0 1rem 0; color: var(--gray-900); font-size: 1rem; font-weight: 600;"> Tunnels actifs ncessitant une remediation:</h4>
                                        
                                        ${activeTunnels.map((tunnel, idx) => {
                                            const isAggressive = tunnel.mode === 'aggressive';
                                            const tunnelId = `tunnel-${item.firewall.id}-${idx}`;
                                            return `
                                                <div style="margin-bottom: 1rem; padding: 1rem; background: white; border-radius: 8px; border-left: 4px solid ${isAggressive ? '#ef4444' : '#f59e0b'};">
                                                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.75rem;">
                                                        <div style="flex: 1;">
                                                            <div style="font-weight: 600; color: var(--gray-900); margin-bottom: 0.25rem;">
                                                                ${tunnel.name}
                                                                <span class="badge ${isAggressive ? 'badge-danger' : 'badge-warning'}" style="margin-left: 0.5rem;">
                                                                    ${isAggressive ? ' Aggressive (CRITIQUE)' : ' Main'}
                                                                </span>
                                                                <span class="badge badge-info" style="margin-left: 0.5rem;">${tunnel.type || 'site-to-site'}</span>
                                                            </div>
                                                            <div style="font-size: 0.85rem; color: var(--gray-600);">
                                                                Gateway: ${tunnel.primary_gateway} | Local: ${tunnel.local_network}  Remote: ${tunnel.remote_network}
                                                            </div>
                                                        </div>
                                                    </div>
                                                    
                                                    <div style="margin-top: 0.75rem;">
                                                        <label style="display: block; font-size: 0.9rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                                            Nouvelle Passphrase (Shared Secret):
                                                        </label>
                                                        <div style="display: flex; gap: 0.5rem; align-items: start;">
                                                            <input 
                                                                type="text" 
                                                                id="${tunnelId}-input"
                                                                class="form-input" 
                                                                placeholder="Entrez une nouvelle passphrase scurise (min. 20 caractres)"
                                                                style="flex: 1; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 4px; font-family: monospace;"
                                                            />
                                                            <button 
                                                                class="btn btn-primary ipsec-change-single-passphrase-btn"
                                                                data-firewall-id="${item.firewall.id}"
                                                                data-tunnel-name="${tunnel.name}"
                                                                data-tunnel-type="${tunnel.type || 'site-to-site'}"
                                                                data-tunnel-input-id="${tunnelId}-input"
                                                                style="background: #3b82f6; border-color: #3b82f6; white-space: nowrap;">
                                                                 Changer
                                                            </button>
                                                        </div>
                                                        <small style="color: var(--gray-600); font-size: 0.75rem; display: block; margin-top: 0.25rem;">
                                                             Assurez-vous de coordonner avec l'autre extrmit du tunnel avant de changer la passphrase
                                                        </small>
                                                    </div>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                    
                                    ${activeTunnels.length > 1 ? `
                                        <div style="margin-bottom: 1rem; padding: 1rem; background: #f0f9ff; border: 1px solid #0ea5e9; border-radius: 8px;">
                                            <strong> Astuce :</strong> Vous pouvez modifier les tunnels un par un en cliquant sur " Changer"  ct de chaque tunnel, 
                                            ou tous ensemble en remplissant tous les champs et en cliquant sur le bouton ci-dessous.
                                        </div>
                                        
                                        <div style="margin-bottom: 1rem;">
                                            <button 
                                                class="btn btn-primary ipsec-change-all-passphrase-btn" 
                                                data-firewall-id="${item.firewall.id}"
                                                style="background: #3b82f6; border-color: #3b82f6; width: 100%;">
                                                 Changer tous les tunnels en une fois (${activeTunnels.length} tunnel${activeTunnels.length !== 1 ? 's' : ''})
                                            </button>
                                        </div>
                                    ` : ''}
                                    
                                    <div style="margin-top: 0.5rem; padding: 0.75rem; background: #dbeafe; border-radius: 4px; font-size: 0.85rem;">
                                        <strong> Informations importantes:</strong><br>
                                         <strong>Mode Aggressive:</strong> CRITIQUE - Vulnrable aux attaques par force brute<br>
                                         <strong>Mode Main:</strong> IMPORTANT - Passphrase compromise dans les backups<br>
                                         <strong>Recommandation:</strong> Changer TOUTES les passphrases des tunnels actifs<br>
                                         <strong>Impact:</strong> Reconnexion du tunnel requise aprs le changement
                                    </div>
                                </div>
                            `}
                        </div>
                    </div>
                `;
            }).join('');
            
            // Attacher les event listeners pour les boutons individuels
            document.querySelectorAll('.ipsec-change-single-passphrase-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const firewallId = button.dataset.firewallId;
                    const tunnelName = button.dataset.tunnelName;
                    const tunnelType = button.dataset.tunnelType;
                    const inputId = button.dataset.tunnelInputId;
                    executeIPSECSinglePassphraseChange(firewallId, tunnelName, tunnelType, inputId);
                });
            });
            
            // Attacher les event listeners pour le bouton "tous ensemble"
            document.querySelectorAll('.ipsec-change-all-passphrase-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const firewallId = button.dataset.firewallId;
                    executeIPSECAllPassphrasesChange(firewallId);
                });
            });
        }
        
        async function executeIPSECSinglePassphraseChange(firewallId, tunnelName, tunnelType, inputId) {
            const input = document.getElementById(inputId);
            const newPassphrase = input.value.trim();
            
            if (!newPassphrase) {
                alert(' Veuillez entrer une passphrase avant de continuer.');
                input.style.borderColor = '#ef4444';
                return;
            }
            
            if (newPassphrase.length < 20) {
                if (!confirm(' La passphrase est courte (< 20 caractres). Voulez-vous continuer quand mme ?')) {
                    input.style.borderColor = '#f59e0b';
                    return;
                }
            }
            
            input.style.borderColor = 'var(--gray-300)';
            
            // Confirmation
            const confirmMsg = ` tes-vous sr de vouloir changer la passphrase du tunnel "${tunnelName}" ?\n\n IMPORTANT:\n Le tunnel VPN sera dconnect\n Vous devez coordonner avec l'autre extrmit\n Cette action est irrversible`;
            
            if (!confirm(confirmMsg)) {
                return;
            }
            
            showAlert('warning', `Changement de la passphrase du tunnel "${tunnelName}" en cours...`, 'ipsec-alert-container');
            
            try {
                const response = await fetch('/api/remediation/ipsec-vpn/fix-tunnels', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        firewall_id: firewallId,
                        action: 'change_passphrase',
                        tunnels: [{
                            name: tunnelName,
                            type: tunnelType,
                            new_passphrase: newPassphrase
                        }]
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert('success', result.message, 'ipsec-alert-container');
                    
                    // Vider le champ et le dsactiver
                    input.value = '';
                    input.disabled = true;
                    input.placeholder = ' Passphrase change avec succs';
                    
                    setTimeout(async () => {
                        await checkIPSECVPN();
                        await loadIPSECRemediation();
                    }, 500);
                } else {
                    showAlert('error', result.message, 'ipsec-alert-container');
                }
                
            } catch (error) {
                console.error('Error changing IPSEC passphrase:', error);
                showAlert('error', 'Erreur lors du changement de la passphrase', 'ipsec-alert-container');
            }
        }
        
        async function executeIPSECAllPassphrasesChange(firewallId) {
            // Rcuprer toutes les passphrases pour ce firewall
            const allInputs = document.querySelectorAll(`input[id^="tunnel-${firewallId}-"]`);
            
            const tunnelsData = [];
            let hasEmptyFields = false;
            let hasShortPassphrases = false;
            
            allInputs.forEach(input => {
                const newPassphrase = input.value.trim();
                
                // Trouver le bouton associ pour rcuprer les infos du tunnel
                const button = document.querySelector(`.ipsec-change-single-passphrase-btn[data-tunnel-input-id="${input.id}"]`);
                if (!button) return;
                
                const tunnelName = button.dataset.tunnelName;
                const tunnelType = button.dataset.tunnelType;
                
                if (!newPassphrase) {
                    hasEmptyFields = true;
                    input.style.borderColor = '#ef4444';
                } else if (newPassphrase.length < 20) {
                    hasShortPassphrases = true;
                    input.style.borderColor = '#f59e0b';
                    tunnelsData.push({
                        name: tunnelName,
                        type: tunnelType,
                        new_passphrase: newPassphrase
                    });
                } else {
                    input.style.borderColor = 'var(--gray-300)';
                    tunnelsData.push({
                        name: tunnelName,
                        type: tunnelType,
                        new_passphrase: newPassphrase
                    });
                }
            });
            
            if (hasEmptyFields) {
                alert(' Veuillez remplir toutes les passphrases avant de continuer.');
                return;
            }
            
            if (hasShortPassphrases) {
                if (!confirm(' Certaines passphrases sont courtes (< 20 caractres). Voulez-vous continuer quand mme ?')) {
                    return;
                }
            }
            
            if (tunnelsData.length === 0) {
                alert(' Aucune passphrase valide  changer.');
                return;
            }
            
            // Confirmation finale
            const confirmMsg = ` tes-vous sr de vouloir changer les passphrases de ${tunnelsData.length} tunnel(s) ?\n\n IMPORTANT:\n Les tunnels VPN seront dconnects\n Vous devez coordonner avec l'autre extrmit\n Cette action est irrversible`;
            
            if (!confirm(confirmMsg)) {
                return;
            }
            
            showAlert('warning', `Changement des passphrases pour ${tunnelsData.length} tunnel(s) en cours...`, 'ipsec-alert-container');
            
            try {
                const response = await fetch('/api/remediation/ipsec-vpn/fix-tunnels', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        firewall_id: firewallId,
                        action: 'change_passphrase',
                        tunnels: tunnelsData
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert('success', result.message, 'ipsec-alert-container');
                    
                    setTimeout(async () => {
                        await checkIPSECVPN();
                        await loadIPSECRemediation();
                    }, 500);
                } else {
                    showAlert('error', result.message, 'ipsec-alert-container');
                }
                
            } catch (error) {
                console.error('Error changing IPSEC passphrases:', error);
                showAlert('error', 'Erreur lors du changement des passphrases', 'ipsec-alert-container');
            }
        }


        // WAN Management - Filter access rules
        function filterAccessRules(firewallId) {
            const statusFilter = document.getElementById(`status-filter-${firewallId}`).value;
            const sourceFilter = document.getElementById(`source-filter-${firewallId}`).value;
            const riskFilter = document.getElementById(`risk-filter-${firewallId}`).value;
            const rows = document.querySelectorAll(`#access-rules-tbody-${firewallId} .access-rule-row`);
            
            rows.forEach(row => {
                const status = row.getAttribute('data-status');
                const source = row.getAttribute('data-source');
                const risky = row.getAttribute('data-risky');
                
                let showRow = true;
                
                // Filter by status
                if (statusFilter !== 'all' && status !== statusFilter) {
                    showRow = false;
                }
                
                // Filter by source
                if (sourceFilter !== 'all' && source !== sourceFilter) {
                    showRow = false;
                }
                
                // Filter by risk
                if (riskFilter === 'risky' && risky !== 'risky') {
                    showRow = false;
                }
                
                row.style.display = showRow ? 'table-row' : 'none';
            });
        }

        // Toggle bind password visibility
        function toggleBindPassword(firewallId, originalPassword) {
            const passwordElement = document.getElementById(`bind-password-${firewallId}`);
            const button = document.getElementById(`toggle-btn-${firewallId}`);
            
            if (!passwordElement || !button) {
                console.error('Password element or button not found for firewall:', firewallId);
                return;
            }
            
            if (passwordElement.textContent === '') {
                // Show password (truncated if too long)
                const displayPassword = originalPassword.length > 50 ? 
                    originalPassword.substring(0, 50) + '...' : 
                    originalPassword;
                passwordElement.textContent = displayPassword;
                passwordElement.title = originalPassword; // Full password in tooltip
                passwordElement.style.whiteSpace = 'nowrap';
                button.textContent = '';
                button.title = 'Hide password';
            } else {
                // Hide password
                passwordElement.textContent = '';
                passwordElement.title = '';
                passwordElement.style.whiteSpace = 'nowrap';
                button.textContent = '';
                button.title = 'Show password';
            }
        }

        // Tab management (defined after all other functions)
        function switchTab(tabName) {
            console.log('=== switchTab called with:', tabName);
            
            try {
                // Update navigation
                document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
                document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
                
                // Show/hide sections
                document.querySelectorAll('section[id$="-section"]').forEach(section => {
                    section.style.display = 'none';
                });
                document.getElementById(`${tabName}-section`).style.display = 'block';
                
                console.log('Navigation updated successfully');
                
                // Auto-load data for specific tabs
                console.log('Switching to tab:', tabName);
                
                // Auto-load if firewalls are available
                if (firewalls && firewalls.length > 0) {
                    if (tabName === 'wan-management') {
                        console.log('Auto-loading WAN Management...');
                        checkWANManagement();
                    } else if (tabName === 'local-users') {
                        console.log('Auto-loading LOCAL Users...');
                        checkLocalUsers();
                    } else if (tabName === 'ldap') {
                        console.log('Auto-loading LDAP...');
                        checkLDAP();
                    } else if (tabName === 'radius') {
                        console.log('Auto-loading RADIUS...');
                        checkRADIUS();
                    } else if (tabName === 'tacacs') {
                        console.log('Auto-loading TACACS+...');
                        checkTACACS();
                    } else if (tabName === 'sso') {
                        console.log('Auto-loading SSO...');
                        checkSSO();
                    } else if (tabName === 'ipsec-vpn') {
                        console.log('Auto-loading IPSEC VPN...');
                        checkIPSECVPN();
                    } else if (tabName === 'ssl-vpn') {
                        console.log('Auto-loading SSL VPN...');
                        checkSSLVPN();
                    } else if (tabName === 'cse') {
                        console.log('Auto-loading CSE...');
                        checkCSE();
                    } else if (tabName === 'pppoe-pptp-l2tp') {
                        console.log('Auto-loading PPPoE/PPTP/L2TP...');
                        checkPPPoEPPTPL2TP();
                    } else if (tabName === 'analytics') {
                        console.log('Auto-loading Analytics...');
                        loadAnalytics();
                    }
                }
                console.log('switchTab completed successfully');
            } catch (error) {
                console.error('Error in switchTab:', error);
            }
        }

        // LOCAL Users Functions
        async function checkLocalUsers() {
            if (firewalls.length === 0) {
                showAlert('warning', 'No firewalls available. Add firewalls first.', 'local-alert-container');
                return;
            }

            showAlert('warning', 'Checking local users...', 'local-alert-container');
            
            const localUsersData = [];
            
            for (const firewall of firewalls) {
                try {
                    const response = await fetch('/api/local-users', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            ip: firewall.ip,
                            username: firewall.username,
                            password: firewall.password
                        })
                    });

                    const result = await response.json();
                    
                    localUsersData.push({
                        firewall: firewall,
                        users: result.users || [],
                        adminsWithoutTOTP: result.admins_without_totp || 0,
                        lastChecked: new Date().toISOString()
                    });
                } catch (error) {
                    localUsersData.push({
                        firewall: firewall,
                        users: [],
                        adminsWithoutTOTP: 0,
                        error: error.message,
                        lastChecked: new Date().toISOString()
                    });
                }
            }

            await renderLocalUsers(localUsersData);
            showAlert('success', 'Local users check completed', 'local-alert-container');
        }

        async function renderLocalUsers(data) {
            const grid = document.getElementById('local-users-grid');
            
            if (data.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon"></div>
                        <h3>No Local Users Data</h3>
                        <p>Click "Check Local Users" to analyze user accounts and TOTP status</p>
                    </div>
                `;
                return;
            }

            // Check remediation status for each firewall
            const remediationPromises = data.map(async (item) => {
                try {
                    const response = await fetch(`/api/remediation/status/${item.firewall.id}/local_users`);
                    const statusData = await response.json();
                    return {
                        ...item,
                        remediationStatus: statusData
                    };
                } catch (error) {
                    return {
                        ...item,
                        remediationStatus: { is_resolved: false }
                    };
                }
            });

            const dataWithRemediation = await Promise.all(remediationPromises);
            
            // Render firewall accordions
            grid.innerHTML = dataWithRemediation.map((item, index) => {
                const fwName = item.firewall.name || item.firewall.ip;
                const hasUsers = item.users.length > 0;
                const isResolved = item.remediationStatus?.status?.is_resolved || false;
                
                // Vrifier les actions dj effectues
                const totpHasBeenUnbound = item.remediationStatus?.status?.notes && 
                    item.remediationStatus.status.notes.includes('TOTP dli');
                const passwordChangeForced = item.remediationStatus?.status?.notes && 
                    item.remediationStatus.status.notes.includes('Changement MDP forc');
                
                // Compter combien d'utilisateurs ont TOTP activ (seulement si pas encore unbind)
                const usersWithTOTP = totpHasBeenUnbound ? 0 : item.users.filter(u => u.one_time_password?.totp || u.totp_enabled || u.otp_enabled).length;
                const usersWithoutTOTP = item.users.length - usersWithTOTP;
                const hasUsersWithTOTP = usersWithTOTP > 0;
                
                // Dterminer la couleur (override si rsolu)
                let bgColor, borderColor, textColor, hoverColor, badgeHtml;
                
                // Vrifier si partiellement rsolu (une action faite mais pas les deux)
                const partiallyResolved = !isResolved && (totpHasBeenUnbound || passwordChangeForced);
                
                if (isResolved) {
                    // VERT : Problme totalement rsolu (TOTP + Passwords)
                    bgColor = '#dcfce7';
                    borderColor = '2px solid #22c55e';
                    textColor = '#166534';
                    hoverColor = '#bbf7d0';
                    badgeHtml = `
                        <span class="badge badge-success"> RSOLU - ${item.remediationStatus.status?.verification_method || 'Remediation effectue'}</span>
                    `;
                } else if (partiallyResolved) {
                    // ORANGE : Partiellement rsolu (une des deux actions faite)
                    bgColor = '#fef3c7';
                    borderColor = '2px solid #f59e0b';
                    textColor = '#92400e';
                    hoverColor = '#fde68a';
                    let actions = [];
                    let missing = [];
                    if (totpHasBeenUnbound) {
                        actions.push('TOTP dli ');
                        missing.push('Changement MDP requis');
                    }
                    if (passwordChangeForced) {
                        actions.push('MDP forc ');
                        missing.push('TOTP unbind requis');
                    }
                    badgeHtml = `
                        <span class="badge badge-warning"> ${actions.join(', ')} - ${missing.join(', ')}</span>
                    `;
                } else if (hasUsers && hasUsersWithTOTP) {
                    // ROUGE : A des users avec TOTP (CRITIQUE car TOTP est compromis)
                    bgColor = '#fee2e2';
                    borderColor = '2px solid #ef4444';
                    textColor = '#991b1b';
                    hoverColor = '#fecaca';
                    badgeHtml = `
                        <span class="badge badge-danger"> ${usersWithTOTP} user${usersWithTOTP !== 1 ? 's' : ''} with TOTP (vulnerable)</span>
                    `;
                } else if (hasUsers) {
                    // VERT : A des users MAIS aucun TOTP (SAFE - pas de vulnrabilit)
                    bgColor = '#dcfce7';
                    borderColor = '2px solid #22c55e';
                    textColor = '#166534';
                    hoverColor = '#bbf7d0';
                    badgeHtml = `
                        <span class="badge badge-success"> ${item.users.length} user${item.users.length !== 1 ? 's' : ''} - No TOTP (safe)</span>
                    `;
                } else {
                    // GRIS : Pas d'utilisateurs
                    bgColor = 'var(--gray-50)';
                    borderColor = '1px solid var(--gray-200)';
                    textColor = 'var(--gray-900)';
                    hoverColor = 'var(--gray-100)';
                    badgeHtml = `<span class="badge badge-secondary">No users</span>`;
                }
                
                return `
                    <div class="firewall-user-accordion">
                        <div class="firewall-user-header ${''}" onclick="toggleUserAccordion('local-${item.firewall.id}')" style="background: ${bgColor}; border: ${borderColor};" onmouseover="this.style.background='${hoverColor}'" onmouseout="this.style.background='${bgColor}'">
                            <div class="fw-name">
                                <span></span>
                                <span style="color: ${textColor};">${fwName} (${item.firewall.ip})</span>
                            </div>
                            ${badgeHtml}
                            <span class="arrow"></span>
                        </div>
                        <div id="local-${item.firewall.id}" class="firewall-user-content ${''}">
                            ${item.error ? `
                                <div class="alert alert-danger">
                                    <strong>Error:</strong> ${item.error}
                                </div>
                            ` : item.users.length === 0 ? `
                                <div class="empty-state">
                                    <p>No local users found on this firewall</p>
                                </div>
                            ` : `
                                <table class="users-table">
                                    <thead>
                                        <tr>
                                            <th>Username</th>
                                            <th>Domain</th>
                                            <th>TOTP Status</th>
                                            <th>Email</th>
                                            <th>Expiration</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${item.users.map(user => `
                                            <tr>
                                                <td><strong>${user.name}</strong></td>
                                                <td>${user.domain || 'local'}</td>
                                                <td>
                                                    ${(user.one_time_password?.totp || user.totp_enabled || user.otp_enabled) ? 
                                                        '<span class="badge badge-success"> TOTP Enabled</span>' : 
                                                        '<span class="badge badge-danger"> No TOTP</span>'}
                                                </td>
                                                <td>${user.email || 'N/A'}</td>
                                                <td>${user.expiration || 'No expiration'}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            `}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function refreshLocalUsers() {
            checkLocalUsers();
        }

        // LOCAL Users Sub-menu Functions
        function switchLocalUsersSubmenu(submenu) {
            // Update buttons
            document.querySelectorAll('.module-submenu .submenu-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-submenu="${submenu}"]`).classList.add('active');
            
            // Update content
            document.querySelectorAll('.submenu-content').forEach(content => {
                content.classList.remove('active');
            });
            
            if (submenu === 'monitoring') {
                document.getElementById('local-users-monitoring').classList.add('active');
            } else if (submenu === 'remediation') {
                document.getElementById('local-users-remediation').classList.add('active');
                loadLocalUsersRemediation();
            }
        }

        // LOCAL Users Remediation Functions
        async function loadLocalUsersRemediation() {
            if (firewalls.length === 0) {
                showAlert('warning', 'No firewalls available. Add firewalls first.', 'local-alert-container');
                return;
            }

            const remediationGrid = document.getElementById('local-users-remediation-grid');
            remediationGrid.innerHTML = '';

            // Load remediation data for each firewall
            for (const firewall of firewalls) {
                try {
                    // Get remediation status
                    const statusResponse = await fetch(`/api/remediation/status/${firewall.id}/local_users`);
                    const statusData = await statusResponse.json();
                    
                    // Get current local users data
                    const usersResponse = await fetch('/api/local-users', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            ip: firewall.ip,
                            username: firewall.username,
                            password: firewall.password
                        })
                    });
                    const usersData = await usersResponse.json();
                    
                    console.log('Users data received in remediation:', usersData);
                    
                    const users = usersData.users || [];
                    console.log(`Users count in remediation: ${users.length}`);
                    const hasUsers = users.length > 0;
                    
                    const status = statusData.status || {};
                    
                    // Vrifier les actions dj effectues
                    const totpUnbound = status.notes && status.notes.includes('TOTP dli');
                    const passwordChangeForced = status.notes && status.notes.includes('Changement MDP');
                    
                    // Compter les utilisateurs avec TOTP (seulement si pas encore unbind)
                    const hasUsersWithTOTP = totpUnbound ? false : users.some(user => user.one_time_password?.totp || user.totp_enabled || user.otp_enabled);
                    
                    // Determine status
                    let statusColor, statusText, statusIcon;
                    if (status.is_resolved) {
                        // VERT : Totalement rsolu (TOTP + MDP)
                        statusColor = '#dcfce7';
                        statusText = ' RSOLU - TOTP dli + MDP forc';
                        statusIcon = '';
                    } else if (totpUnbound || passwordChangeForced) {
                        // ORANGE : Partiellement rsolu
                        statusColor = '#fef3c7';
                        let actions = [];
                        if (totpUnbound) actions.push('TOTP dli ');
                        if (passwordChangeForced) actions.push('MDP forc ');
                        statusText = ` PARTIELLEMENT RSOLU - ${actions.join(', ')}`;
                        statusIcon = '';
                    } else if (hasUsers && hasUsersWithTOTP) {
                        // ROUGE : Critique - TOTP dtect
                        statusColor = '#fee2e2';
                        statusText = ' CRITIQUE - TOTP vulnrable dtect';
                        statusIcon = '';
                    } else if (hasUsers && !hasUsersWithTOTP) {
                        // VERT : Safe - Pas de TOTP
                        statusColor = '#dcfce7';
                        statusText = ' SAFE - Aucun TOTP dtect';
                        statusIcon = '';
                    } else {
                        // GRIS : Aucun utilisateur
                        statusColor = 'var(--gray-50)';
                        statusText = ' OK - Aucun utilisateur';
                        statusIcon = '';
                    }
                    
                    const firewallCard = document.createElement('div');
                    firewallCard.className = 'remediation-card';
                    firewallCard.style.cssText = `
                        background: ${statusColor};
                        border: 2px solid ${statusColor === '#fee2e2' ? '#ef4444' : statusColor === '#fef3c7' ? '#f59e0b' : 'var(--gray-200)'};
                        border-radius: 12px;
                        padding: 1.5rem;
                        margin-bottom: 1rem;
                        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                    `;
                    
                    firewallCard.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <div>
                                <h3 style="margin: 0; font-size: 1.1rem;">
                                     ${firewall.name || firewall.ip} (${firewall.ip})
                                </h3>
                                <p style="margin: 0.5rem 0 0 0; color: var(--gray-600); font-size: 0.9rem;">
                                    ${statusIcon} ${statusText}
                                </p>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 1rem;">
                            <strong>Dtails:</strong>
                            <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
                                <li>Utilisateurs locaux: ${users.length}</li>
                                ${totpUnbound ? `
                                    <li>TOTP: Cls supprimes </li>
                                ` : `
                                    <li>Avec TOTP vulnrable: ${users.filter(u => u.one_time_password?.totp || u.totp_enabled || u.otp_enabled).length}</li>
                                `}
                                ${passwordChangeForced ? `
                                    <li>Changement MDP: Forc </li>
                                ` : ''}
                            </ul>
                        </div>
                        
                        ${status.is_resolved ? `
                            <div style="background: #dcfce7; border: 1px solid #22c55e; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                                <strong> Problme rsolu</strong><br>
                                Rsolu le: ${status.resolution_date ? new Date(status.resolution_date).toLocaleString() : 'Date inconnue'}<br>
                                Mthode: ${status.verification_method || 'Remediation manuelle'}<br>
                                ${status.notes ? `Notes: ${status.notes}` : ''}
                            </div>
                        ` : `
                                ${totpUnbound || passwordChangeForced ? `
                                    <div style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                                        <strong> Remediation partielle effectue</strong><br>
                                        ${totpUnbound ? ' TOTP dli<br>' : ''}
                                        ${passwordChangeForced ? ' Changement MDP forc<br>' : ''}
                                        ${status.notes ? `<span style="font-size: 0.85rem; color: var(--gray-600);">${status.notes}</span>` : ''}
                                    </div>
                                ` : ''}
                                
                                <div style="margin-bottom: 1rem;">
                                    <strong>Actions de remdiation ${totpUnbound || passwordChangeForced ? 'restantes' : 'disponibles'}:</strong>
                                    <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem; flex-wrap: wrap;">
                                        ${!passwordChangeForced ? `
                                            <button class="btn btn-danger" onclick="confirmRemediationAction(${firewall.id}, 'reset_passwords', 'Forcer le changement de mot de passe pour tous les utilisateurs locaux?')" style="font-size: 0.8rem;">
                                                 Forcer Changement MDP
                                            </button>
                                        ` : ''}
                                        ${!totpUnbound && users.filter(u => u.one_time_password?.totp || u.totp_enabled || u.otp_enabled).length > 0 ? `
                                            <button class="btn btn-warning" onclick="confirmRemediationAction(${firewall.id}, 'unbind_totp', 'Supprimer les cls TOTP pour tous les utilisateurs?')" style="font-size: 0.8rem;">
                                                 Supprimer TOTP
                                            </button>
                                        ` : ''}
                                    </div>
                                    ${!totpUnbound && !passwordChangeForced ? `
                                        <div style="margin-top: 0.5rem; padding: 0.5rem; background: #fef3c7; border-radius: 4px; font-size: 0.8rem;">
                                            <strong> Explication:</strong><br>
                                             <strong>Forcer Changement MDP:</strong> Tous les utilisateurs devront changer leur mot de passe au prochain login<br>
                                             <strong>Supprimer TOTP:</strong> Supprime les cls TOTP vulnrables de tous les utilisateurs
                                        </div>
                                    ` : ''}
                                </div>
                        `}
                        
                        ${statusData.recent_actions && statusData.recent_actions.length > 0 ? `
                            <div style="background: var(--gray-50); border-radius: 8px; padding: 1rem;">
                                <strong>Actions rcentes:</strong>
                                <ul style="margin: 0.5rem 0; padding-left: 1.5rem; font-size: 0.85rem;">
                                    ${statusData.recent_actions.slice(0, 3).map(action => `
                                        <li style="margin-bottom: 0.25rem;">
                                            ${action.action_type} - ${action.success ? '' : ''} 
                                            (${new Date(action.executed_at).toLocaleString()})
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>
                        ` : ''}
                    `;
                    
                    remediationGrid.appendChild(firewallCard);
                    
                } catch (error) {
                    console.error(`Error loading remediation for firewall ${firewall.id}:`, error);
                    const errorCard = document.createElement('div');
                    errorCard.className = 'remediation-card';
                    errorCard.style.cssText = `
                        background: #fee2e2;
                        border: 2px solid #ef4444;
                        border-radius: 12px;
                        padding: 1.5rem;
                        margin-bottom: 1rem;
                    `;
                    errorCard.innerHTML = `
                        <h3> ${firewall.name || firewall.ip}</h3>
                        <p style="color: #991b1b;"> Erreur lors du chargement: ${error.message}</p>
                    `;
                    remediationGrid.appendChild(errorCard);
                }
            }
        }

        // Remediation Action Confirmation
        function confirmRemediationAction(firewallId, actionType, message) {
            if (confirm(` ${message}\n\nCette action modifiera la configuration du firewall. tes-vous sr de vouloir continuer ?`)) {
                executeRemediationAction(firewallId, actionType);
            }
        }

        // Execute Remediation Action
        async function executeRemediationAction(firewallId, actionType) {
            try {
                showAlert('warning', 'Excution de l\'action de remdiation...', 'local-alert-container');
                
                let endpoint, payload;
                
                if (actionType === 'reset_passwords') {
                    endpoint = '/api/remediation/local-users/force-password-change';
                    payload = { firewall_id: firewallId };
                } else if (actionType === 'unbind_totp') {
                    // Get users with TOTP first
                    const firewall = firewalls.find(f => f.id === firewallId);
                    const usersResponse = await fetch('/api/local-users', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            ip: firewall.ip,
                            username: firewall.username,
                            password: firewall.password
                        })
                    });
                    const usersData = await usersResponse.json();
                    const usersWithTOTP = (usersData.users || [])
                        .filter(u => u.one_time_password?.totp || u.totp_enabled || u.otp_enabled)
                        .map(u => u.name);
                    
                    endpoint = '/api/remediation/local-users/unbind-totp';
                    payload = { 
                        firewall_id: firewallId,
                        usernames: usersWithTOTP
                    };
                }
                
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert('success', `${result.message} - Rechargement des donnes...`, 'local-alert-container');
                    // Toujours re-vrifier les utilisateurs pour obtenir les nouvelles donnes
                    setTimeout(async () => {
                        // Forcer une nouvelle vrification des utilisateurs
                        await checkLocalUsers();
                        // Recharger aussi la vue remediation
                        await loadLocalUsersRemediation();
                    }, 500);
                } else {
                    showAlert('error', result.message, 'local-alert-container');
                }
                
            } catch (error) {
                console.error('Error executing remediation action:', error);
                showAlert('error', `Erreur lors de l'excution: ${error.message}`, 'local-alert-container');
            }
        }

        function toggleUserAccordion(accordionId) {
            const content = document.getElementById(accordionId);
            const header = content.previousElementSibling;
            
            if (content.classList.contains('open')) {
                content.classList.remove('open');
                header.classList.remove('open');
            } else {
                content.classList.add('open');
                header.classList.add('open');
            }
        }

        function filterAccordions(gridId, searchText) {
            const grid = document.getElementById(gridId);
            if (!grid) return;
            
            const searchLower = searchText.toLowerCase();
            const accordions = grid.querySelectorAll('.firewall-user-accordion, .remediation-card, .firewall-ldap-line');
            
            let visibleCount = 0;
            accordions.forEach(accordion => {
                const text = accordion.textContent.toLowerCase();
                const matches = text.includes(searchLower);
                accordion.style.display = matches ? '' : 'none';
                if (matches) visibleCount++;
            });
            
            // Afficher un message si aucun rsultat
            let noResultsMsg = grid.querySelector('.no-search-results');
            if (visibleCount === 0) {
                if (!noResultsMsg) {
                    noResultsMsg = document.createElement('div');
                    noResultsMsg.className = 'no-search-results empty-state';
                    noResultsMsg.innerHTML = '<p>Aucun rsultat trouv pour "' + searchText + '"</p>';
                    grid.appendChild(noResultsMsg);
                }
            } else {
                if (noResultsMsg) {
                    noResultsMsg.remove();
                }
            }
        }

        function toggleSelectAll(firewallId) {
            const selectAll = document.getElementById(`select-all-${firewallId}`);
            const checkboxes = document.querySelectorAll(`.user-select-${firewallId}`);
            checkboxes.forEach(cb => cb.checked = selectAll.checked);
        }

        async function forcePasswordChange(firewallId) {
            const firewall = firewalls.find(fw => fw.id == firewallId);
            if (!firewall) {
                showAlert('error', 'Firewall not found', 'local-alert-container');
                return;
            }

            const checkboxes = document.querySelectorAll(`.user-select-${firewallId}:checked`);
            if (checkboxes.length === 0) {
                showAlert('warning', 'Please select at least one user', 'local-alert-container');
                return;
            }

            const usernames = Array.from(checkboxes).map(cb => cb.dataset.user);
            const confirmMsg = `Force password change for ${usernames.length} user(s)?\n\nUsers: ${usernames.join(', ')}`;
            
            if (!confirm(confirmMsg)) {
                return;
            }

            showAlert('warning', 'Forcing password change...', 'local-alert-container');

            try {
                const response = await fetch('/api/local-users/force-password-change', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        ip: firewall.ip,
                        username: firewall.username,
                        password: firewall.password,
                        change_for: 'all'  // Force all selected users
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showAlert('success', result.message, 'local-alert-container');
                    // Refresh the data
                    setTimeout(() => checkLocalUsers(), 1000);
                } else {
                    showAlert('error', result.message, 'local-alert-container');
                }
            } catch (error) {
                showAlert('error', `Error: ${error.message}`, 'local-alert-container');
            }
        }

        async function unbindTOTPBulk(firewallId) {
            const firewall = firewalls.find(fw => fw.id == firewallId);
            if (!firewall) {
                showAlert('error', 'Firewall not found', 'local-alert-container');
                return;
            }

            const checkboxes = document.querySelectorAll(`.user-select-${firewallId}:checked`);
            if (checkboxes.length === 0) {
                showAlert('warning', 'Please select at least one user', 'local-alert-container');
                return;
            }

            const usernames = Array.from(checkboxes).map(cb => cb.dataset.user);
            const confirmMsg = `Unbind TOTP for ${usernames.length} user(s)?\n\nUsers: ${usernames.join(', ')}`;
            
            if (!confirm(confirmMsg)) {
                return;
            }

            showAlert('warning', `Unbinding TOTP for ${usernames.length} user(s)...`, 'local-alert-container');

            let successCount = 0;
            let errorCount = 0;

            for (const username of usernames) {
                try {
                    const response = await fetch(`/api/local-users/unbind-totp/${username}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            ip: firewall.ip,
                            username: firewall.username,
                            password: firewall.password
                        })
                    });

                    const result = await response.json();

                    if (result.success) {
                        successCount++;
                    } else {
                        errorCount++;
                        console.error(`Error unbinding TOTP for ${username}:`, result.message);
                    }
                } catch (error) {
                    errorCount++;
                    console.error(`Error unbinding TOTP for ${username}:`, error.message);
                }
            }

            if (errorCount === 0) {
                showAlert('success', `TOTP unbound successfully for ${successCount} user(s)`, 'local-alert-container');
            } else {
                showAlert('warning', `TOTP unbound for ${successCount} user(s), ${errorCount} failed`, 'local-alert-container');
            }

            // Refresh the data
            setTimeout(() => checkLocalUsers(), 1000);
        }

        // LDAP Functions (renaming from Active Directory)
        async function checkLDAP() {
            // Reuse the existing checkActiveDirectory logic but call it checkLDAP
            if (firewalls.length === 0) {
                showAlert('warning', 'No firewalls available. Add firewalls first.', 'ldap-alert-container');
                return;
            }

            showAlert('warning', 'Checking LDAP configuration...', 'ldap-alert-container');
            
            const ldapData = [];
            
            for (const firewall of firewalls) {
                try {
                    // Get remediation status
                    const statusResponse = await fetch(`/api/remediation/status/${firewall.id}/ldap`);
                    const statusData = await statusResponse.json();
                    
                    const response = await fetch('/api/active-directory', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            ip: firewall.ip,
                            username: firewall.username,
                            password: firewall.password
                        })
                    });

                    const result = await response.json();
                    
                    const ldapConfig = result.ldap_config || {};
                    const servers = ldapConfig.servers || [];
                    const firstServer = servers[0] || {};
                    
                    ldapData.push({
                        firewall: firewall,
                        adEnabled: ldapConfig.enabled || false,
                        bindPassword: firstServer.bind_user ? '********' : 'Not configured',
                        originalBindPassword: '',
                        domain: firstServer.base_dn || 'Not configured',
                        server: firstServer.host || 'Not configured',
                        baseDN: firstServer.base_dn || 'Not configured',
                        bindUser: firstServer.bind_user || 'Not configured',
                        hasBindPassword: !!firstServer.bind_user,
                        remediationStatus: statusData.status,
                        lastChecked: new Date().toISOString()
                    });
                } catch (error) {
                    ldapData.push({
                        firewall: firewall,
                        adEnabled: false,
                        bindPassword: 'Error',
                        originalBindPassword: '',
                        domain: 'Error',
                        server: 'Error',
                        baseDN: 'Error',
                        bindUser: 'Error',
                        hasBindPassword: false,
                        remediationStatus: { is_resolved: false },
                        error: error.message,
                        lastChecked: new Date().toISOString()
                    });
                }
            }

            renderLDAP(ldapData);
            showAlert('success', 'LDAP check completed', 'ldap-alert-container');
        }

        function renderLDAP(ldapData) {
            const grid = document.getElementById('ldap-grid');
            
            if (ldapData.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon"></div>
                        <h3>No LDAP Data</h3>
                        <p>Click "Check LDAP Configuration" to analyze LDAP/AD settings</p>
                    </div>
                `;
                return;
            }

            // Use the existing renderActiveDirectory logic
            grid.innerHTML = ldapData.map(data => {
                const fwName = data.firewall.name || data.firewall.ip;
                const isResolved = data.remediationStatus?.is_resolved || false;
                const bindPasswordChanged = data.remediationStatus?.notes && data.remediationStatus.notes.includes('Bind password chang');
                const hasRisk = data.hasBindPassword && !isResolved && !bindPasswordChanged;
                
                // Dterminer les couleurs
                let bgColor, borderColor, textColor, hoverColor, badgeText;
                
                if (isResolved) {
                    // VERT : Rsolu
                    bgColor = '#dcfce7';
                    borderColor = '2px solid #22c55e';
                    textColor = '#166534';
                    hoverColor = '#bbf7d0';
                    badgeText = ` RSOLU - ${data.remediationStatus?.verification_method || 'Bind password chang'}`;
                } else if (bindPasswordChanged) {
                    // ORANGE : Partiellement rsolu
                    bgColor = '#fef3c7';
                    borderColor = '2px solid #f59e0b';
                    textColor = '#92400e';
                    hoverColor = '#fde68a';
                    badgeText = ' Bind password chang ';
                } else if (hasRisk) {
                    // ROUGE : Bind password compromis
                    bgColor = '#fee2e2';
                    borderColor = '2px solid #ef4444';
                    textColor = '#991b1b';
                    hoverColor = '#fecaca';
                    badgeText = ' Bind Password compromis';
                } else if (data.adEnabled && !data.hasBindPassword) {
                    // VERT : LDAP activ mais sans bind password (safe)
                    bgColor = '#dcfce7';
                    borderColor = '2px solid #22c55e';
                    textColor = '#166534';
                    hoverColor = '#bbf7d0';
                    badgeText = ' Safe - No bind password';
                } else {
                    // GRIS : Non configur
                    bgColor = 'white';
                    borderColor = '1px solid var(--gray-200)';
                    textColor = 'var(--gray-900)';
                    hoverColor = 'var(--gray-50)';
                    badgeText = data.adEnabled ? ' Enabled' : ' Not configured';
                }
                
                return `
                    <div class="firewall-ldap-line" style="
                        display: flex;
                        align-items: center;
                        gap: 1rem;
                        padding: 1rem 1.5rem;
                        background: ${bgColor};
                        border: ${borderColor};
                        border-radius: 12px;
                        margin-bottom: 1rem;
                        flex-wrap: wrap;
                        transition: all 0.2s;
                    " onmouseover="this.style.background='${hoverColor}'" onmouseout="this.style.background='${bgColor}'">
                        <span class="fw-name" style="flex: 0 0 180px; font-weight: 700; color: ${textColor};"> ${fwName}</span>
                        <span style="flex: 0 0 100px;">
                            ${data.adEnabled ? 
                                '<span class="badge badge-success"> Enabled</span>' : 
                                '<span class="badge badge-secondary"> Disabled</span>'}
                        </span>
                        <span style="flex: 0 0 150px; font-size: 0.9rem;"><strong>Server:</strong> ${data.server}</span>
                        <span style="flex: 1 1 200px; font-size: 0.9rem;"><strong>Domain:</strong> ${data.domain}</span>
                        <span style="flex: 1 1 250px; font-size: 0.9rem;"><strong>Base DN:</strong> ${data.baseDN}</span>
                        <span style="flex: 1 1 200px; font-size: 0.9rem;"><strong>Bind User:</strong> ${data.bindUser}</span>
                        <span style="flex: 0 0 auto;">
                            <span class="badge ${isResolved ? 'badge-success' : bindPasswordChanged ? 'badge-warning' : hasRisk ? 'badge-danger' : data.adEnabled && !data.hasBindPassword ? 'badge-success' : 'badge-secondary'}">${badgeText}</span>
                        </span>
                    </div>
                `;
            }).join('');
        }

        function refreshLDAP() {
            checkLDAP();
        }

        function switchLDAPSubmenu(submenu) {
            // Update buttons
            const section = document.getElementById('ldap-section');
            section.querySelectorAll('.module-submenu .submenu-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            section.querySelector(`[data-submenu="${submenu}"]`).classList.add('active');
            
            // Update content
            section.querySelectorAll('.submenu-content').forEach(content => {
                content.classList.remove('active');
            });
            
            if (submenu === 'monitoring') {
                document.getElementById('ldap-monitoring').classList.add('active');
            } else if (submenu === 'remediation') {
                document.getElementById('ldap-remediation').classList.add('active');
                loadLDAPRemediation();
            }
        }

        // LDAP Remediation Functions
        async function loadLDAPRemediation() {
            if (firewalls.length === 0) {
                showAlert('warning', 'No firewalls available. Add firewalls first.', 'ldap-alert-container');
                return;
            }

            const remediationGrid = document.getElementById('ldap-remediation-grid');
            remediationGrid.innerHTML = '';

            // Load remediation data for each firewall
            for (const firewall of firewalls) {
                try {
                    // Get remediation status
                    const statusResponse = await fetch(`/api/remediation/status/${firewall.id}/ldap`);
                    const statusData = await statusResponse.json();
                    
                    // Get current LDAP data
                    const ldapResponse = await fetch('/api/active-directory', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            ip: firewall.ip,
                            username: firewall.username,
                            password: firewall.password
                        })
                    });
                    const ldapData = await ldapResponse.json();
                    
                    const ldapConfig = ldapData.ldap_config || {};
                    const servers = ldapConfig.servers || [];
                    const firstServer = servers[0] || {};
                    const hasBindPassword = !!firstServer.bind_user && firstServer.bind_user !== 'Not configured';
                    const isEnabled = ldapConfig.enabled;
                    const currentBindUser = firstServer.bind_user || '';
                    
                    // Vrifier si le bind password a t chang
                    const status = statusData.status || {};
                    const bindPasswordChanged = status.notes && status.notes.includes('Bind password chang');
                    
                    // Determine status
                    let statusColor, statusText, statusIcon;
                    if (status.is_resolved) {
                        // VERT : Totalement rsolu
                        statusColor = '#dcfce7';
                        statusText = ' RSOLU - Bind password chang';
                        statusIcon = '';
                    } else if (bindPasswordChanged) {
                        // ORANGE : Bind password chang mais pas encore vrifi
                        statusColor = '#fef3c7';
                        statusText = ' PARTIELLEMENT RSOLU - Bind password chang ';
                        statusIcon = '';
                    } else if (isEnabled && hasBindPassword) {
                        // ROUGE : Critique - Bind password configur (compromis)
                        statusColor = '#fee2e2';
                        statusText = ' CRITIQUE - Bind password compromis';
                        statusIcon = '';
                    } else if (isEnabled && !hasBindPassword) {
                        // VERT : Safe - LDAP activ mais sans bind password
                        statusColor = '#dcfce7';
                        statusText = ' SAFE - LDAP sans bind password';
                        statusIcon = '';
                    } else {
                        // GRIS : LDAP non configur
                        statusColor = 'var(--gray-50)';
                        statusText = ' LDAP non configur';
                        statusIcon = '';
                    }
                    
                    const firewallCard = document.createElement('div');
                    firewallCard.className = 'remediation-card';
                    firewallCard.style.cssText = `
                        background: ${statusColor};
                        border: 2px solid ${statusColor === '#fee2e2' ? '#ef4444' : statusColor === '#fef3c7' ? '#f59e0b' : 'var(--gray-200)'};
                        border-radius: 12px;
                        padding: 1.5rem;
                        margin-bottom: 1rem;
                        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                    `;
                    
                    firewallCard.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <div>
                                <h3 style="margin: 0; font-size: 1.1rem;">
                                     ${firewall.name || firewall.ip} (${firewall.ip})
                                </h3>
                                <p style="margin: 0.5rem 0 0 0; color: var(--gray-600); font-size: 0.9rem;">
                                    ${statusIcon} ${statusText}
                                </p>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 1rem;">
                            <strong>Dtails:</strong>
                            <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
                                <li>LDAP Activ: ${isEnabled ? '' : ''}</li>
                                <li>Serveur: ${firstServer.host || 'Not configured'}</li>
                                <li>Domaine: ${firstServer.base_dn || 'Not configured'}</li>
                                <li>Bind User: ${firstServer.bind_user || 'Not configured'}</li>
                                ${bindPasswordChanged ? `
                                    <li>Bind Password: Chang </li>
                                ` : hasBindPassword ? `
                                    <li>Bind Password: Configur (compromis) </li>
                                ` : `
                                    <li>Bind Password: Non configur</li>
                                `}
                            </ul>
                        </div>
                        
                        ${status.is_resolved ? `
                            <div style="background: #dcfce7; border: 1px solid #22c55e; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                                <strong> Problme rsolu</strong><br>
                                Rsolu le: ${status.resolution_date ? new Date(status.resolution_date).toLocaleString() : 'Date inconnue'}<br>
                                Mthode: ${status.verification_method || 'Remediation manuelle'}<br>
                                ${status.notes ? `Notes: ${status.notes}` : ''}
                            </div>
                        ` : `
                                ${bindPasswordChanged ? `
                                    <div style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                                        <strong> Remediation partielle effectue</strong><br>
                                         Bind password chang<br>
                                        ${status.notes ? `<span style="font-size: 0.85rem; color: var(--gray-600);">${status.notes}</span>` : ''}
                                    </div>
                                ` : ''}
                                
                                ${isEnabled && hasBindPassword && !bindPasswordChanged ? `
                                    <div style="margin-bottom: 1rem;">
                                        <strong>Actions de remdiation disponibles:</strong>
                                        <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem; flex-wrap: wrap;">
                                            <button class="btn btn-danger" onclick="confirmLDAPRemediation(${firewall.id}, 'Changer le bind password LDAP et le configurer automatiquement sur le firewall?')" style="font-size: 0.8rem;">
                                                 Changer Bind Password
                                            </button>
                                        </div>
                                        <div style="margin-top: 0.5rem; padding: 0.5rem; background: #fef3c7; border-radius: 4px; font-size: 0.8rem;">
                                            <strong> Explication:</strong><br>
                                             <strong>Changer Bind Password:</strong> Gnre un nouveau mot de passe scuris et le configure sur le serveur LDAP
                                        </div>
                                    </div>
                                ` : !isEnabled ? `
                                    <div class="empty-state"><p>LDAP non configur sur ce firewall</p></div>
                                ` : !hasBindPassword ? `
                                    <div style="background: #dcfce7; border: 1px solid #22c55e; border-radius: 8px; padding: 1rem;">
                                        <strong> Safe</strong> - LDAP configur sans bind password
                                    </div>
                                ` : ''}
                        `}
                    `;
                    
                    remediationGrid.appendChild(firewallCard);
                } catch (error) {
                    console.error('Error loading LDAP remediation:', error);
                }
            }
        }

        async function confirmLDAPRemediation(firewallId, message) {
            // Rcuprer les donnes LDAP actuelles pour le firewall
            const firewall = firewalls.find(f => f.id === firewallId);
            if (!firewall) {
                showAlert('error', 'Firewall non trouv', 'ldap-alert-container');
                return;
            }

            try {
                // Rcuprer la config LDAP actuelle
                const ldapResponse = await fetch('/api/active-directory', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        ip: firewall.ip,
                        username: firewall.username,
                        password: firewall.password
                    })
                });
                const ldapData = await ldapResponse.json();
                const ldapConfig = ldapData.ldap_config || {};
                const servers = ldapConfig.servers || [];
                const firstServer = servers[0] || {};
                const currentBindUser = firstServer.bind_user && firstServer.bind_user !== 'Not configured' ? firstServer.bind_user : '';
                
                console.log('LDAP Modal - ldapConfig:', ldapConfig);
                console.log('LDAP Modal - bind_user:', currentBindUser);
                
                // Crer un modal pour demander le bind user
                const modalHtml = `
                    <div id="ldap-remediation-modal" style="
                        position: fixed;
                        top: 0;
                        left: 0;
                        right: 0;
                        bottom: 0;
                        background: rgba(0,0,0,0.5);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        z-index: 10000;
                    ">
                        <div style="
                            background: white;
                            padding: 2rem;
                            border-radius: 12px;
                            max-width: 600px;
                            width: 90%;
                            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
                        ">
                            <h3 style="margin: 0 0 1rem 0;"> Changer Bind Password LDAP</h3>
                            <p style="margin-bottom: 1.5rem; color: var(--gray-600);">
                                Configurez le nouveau bind user et mot de passe. Les modifications seront appliques sur le firewall et sauvegardes en base de donnes.
                            </p>
                            
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">
                                    Bind User:
                                </label>
                                <input 
                                    type="text" 
                                    id="ldap-bind-user-input" 
                                    value="${currentBindUser && currentBindUser !== 'Not configured' ? currentBindUser : ''}"
                                    placeholder="Ex: ldapbind, cn=admin,dc=example,dc=com"
                                    style="
                                        width: 100%;
                                        padding: 0.75rem;
                                        border: 1px solid var(--gray-300);
                                        border-radius: 6px;
                                        font-size: 0.95rem;
                                    "
                                >
                                <small style="color: var(--gray-500);">
                                    L'utilisateur actuel est pr-rempli. Vous pouvez le modifier si ncessaire.
                                </small>
                            </div>
                            
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">
                                    Nouveau Bind Password:
                                </label>
                                <input 
                                    type="password" 
                                    id="ldap-bind-password-input" 
                                    placeholder="Entrez le nouveau mot de passe"
                                    style="
                                        width: 100%;
                                        padding: 0.75rem;
                                        border: 1px solid var(--gray-300);
                                        border-radius: 6px;
                                        font-size: 0.95rem;
                                    "
                                >
                                <small style="color: var(--gray-500);">
                                    Entrez un mot de passe fort. Il sera configur sur le firewall et sauvegard en base.
                                </small>
                            </div>
                            
                            <div style="background: #fee2e2; padding: 0.75rem; border-radius: 6px; margin-bottom: 1.5rem; font-size: 0.85rem;">
                                <strong> Important:</strong> Vous devez configurer ce mme mot de passe sur votre serveur Active Directory/LDAP pour que l'authentification fonctionne.
                            </div>
                            
                            <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
                                <button class="btn btn-secondary" onclick="closeLDAPModal()">
                                    Annuler
                                </button>
                                <button class="btn btn-danger" onclick="executeLDAPRemediation(${firewallId})">
                                     Changer Bind Password
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                // Ajouter le modal au DOM
                const existingModal = document.getElementById('ldap-remediation-modal');
                if (existingModal) {
                    existingModal.remove();
                }
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                
            } catch (error) {
                console.error('Error loading LDAP data:', error);
                showAlert('error', 'Erreur lors du chargement des donnes LDAP', 'ldap-alert-container');
            }
        }

        function closeLDAPModal() {
            const modal = document.getElementById('ldap-remediation-modal');
            if (modal) {
                modal.remove();
            }
        }

        async function executeLDAPRemediation(firewallId) {
            const bindUserInput = document.getElementById('ldap-bind-user-input');
            const bindPasswordInput = document.getElementById('ldap-bind-password-input');
            const bindUser = bindUserInput?.value?.trim();
            const bindPassword = bindPasswordInput?.value?.trim();
            
            if (!bindUser) {
                alert('Veuillez entrer un bind user');
                return;
            }
            
            if (!bindPassword) {
                alert('Veuillez entrer un mot de passe');
                return;
            }

            console.log('LDAP Remediation - Bind User:', bindUser);
            console.log('LDAP Remediation - Password length:', bindPassword.length);

            closeLDAPModal();

            try {
                showAlert('warning', 'Changement du bind password LDAP en cours...', 'ldap-alert-container');
                
                const response = await fetch('/api/remediation/ldap/change-bind-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        firewall_id: firewallId,
                        bind_user: bindUser,
                        bind_password: bindPassword
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert('success', `${result.message} - Le nouveau mot de passe est sauvegard en base de donnes`, 'ldap-alert-container');
                    
                    // Recharger les donnes
                    setTimeout(async () => {
                        await checkLDAP();
                        await loadLDAPRemediation();
                    }, 500);
                } else {
                    showAlert('error', result.message, 'ldap-alert-container');
                }
                
            } catch (error) {
                console.error('Error executing LDAP remediation:', error);
                showAlert('error', `Erreur lors de l'excution: ${error.message}`, 'ldap-alert-container');
            }
        }

        function switchRADIUSSubmenu(submenu) {
            // Update buttons
            const section = document.getElementById('radius-section');
            section.querySelectorAll('.module-submenu .submenu-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            section.querySelector(`[data-submenu="${submenu}"]`).classList.add('active');
            
            // Update content
            section.querySelectorAll('.submenu-content').forEach(content => {
                content.classList.remove('active');
            });
            
            if (submenu === 'monitoring') {
                document.getElementById('radius-monitoring').classList.add('active');
            } else if (submenu === 'remediation') {
                document.getElementById('radius-remediation').classList.add('active');
                loadRADIUSRemediation();
            }
        }

        // RADIUS Remediation Functions
        async function loadRADIUSRemediation() {
            if (firewalls.length === 0) {
                showAlert('warning', 'No firewalls available. Add firewalls first.', 'radius-alert-container');
                return;
            }

            const remediationGrid = document.getElementById('radius-remediation-grid');
            remediationGrid.innerHTML = '';

            for (const firewall of firewalls) {
                try {
                    const statusResponse = await fetch(`/api/remediation/status/${firewall.id}/radius`);
                    const statusData = await statusResponse.json();
                    
                    const radiusResponse = await fetch('/api/radius-config', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            ip: firewall.ip,
                            username: firewall.username,
                            password: firewall.password
                        })
                    });
                    const radiusData = await radiusResponse.json();
                    
                    const config = radiusData.radius_config || {};
                    const servers = config.user?.radius?.server || [];
                    const secretsCount = servers.filter(s => s.shared_secret).length;
                    const hasSecrets = secretsCount > 0;
                    
                    const status = statusData.status || {};
                    const secretsChanged = status.notes && status.notes.includes('Shared secrets changs');
                    
                    let statusColor, statusText, statusIcon;
                    if (status.is_resolved) {
                        statusColor = '#dcfce7';
                        statusText = ' RSOLU - Shared secrets changs';
                        statusIcon = '';
                    } else if (secretsChanged) {
                        statusColor = '#fef3c7';
                        statusText = ' PARTIELLEMENT RSOLU - Shared secrets changs ';
                        statusIcon = '';
                    } else if (hasSecrets) {
                        statusColor = '#fee2e2';
                        statusText = ' CRITIQUE - Shared secrets compromis';
                        statusIcon = '';
                    } else {
                        statusColor = '#dcfce7';
                        statusText = ' SAFE - Aucun shared secret configur';
                        statusIcon = '';
                    }
                    
                    const firewallCard = document.createElement('div');
                    firewallCard.className = 'remediation-card';
                    firewallCard.style.cssText = `
                        background: ${statusColor};
                        border: 2px solid ${statusColor === '#fee2e2' ? '#ef4444' : statusColor === '#fef3c7' ? '#f59e0b' : 'var(--gray-200)'};
                        border-radius: 12px;
                        padding: 1.5rem;
                        margin-bottom: 1rem;
                        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                    `;
                    
                    firewallCard.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <div>
                                <h3 style="margin: 0; font-size: 1.1rem;">
                                     ${firewall.name || firewall.ip} (${firewall.ip})
                                </h3>
                                <p style="margin: 0.5rem 0 0 0; color: var(--gray-600); font-size: 0.9rem;">
                                    ${statusIcon} ${statusText}
                                </p>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 1rem;">
                            <strong>Dtails:</strong>
                            <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
                                <li>Serveurs RADIUS: ${servers.length}</li>
                                ${secretsChanged ? `
                                    <li>Shared Secrets: Changs </li>
                                ` : hasSecrets ? `
                                    <li>Shared Secrets: ${secretsCount} configur(s) (compromis) </li>
                                ` : `
                                    <li>Shared Secrets: Aucun</li>
                                `}
                            </ul>
                        </div>
                        
                        ${status.is_resolved ? `
                            <div style="background: #dcfce7; border: 1px solid #22c55e; border-radius: 8px; padding: 1rem;">
                                <strong> Problme rsolu</strong><br>
                                Rsolu le: ${status.resolution_date ? new Date(status.resolution_date).toLocaleString() : 'Date inconnue'}<br>
                                Mthode: ${status.verification_method || 'Remediation manuelle'}
                            </div>
                        ` : hasSecrets && !secretsChanged ? `
                            <div style="margin-bottom: 1rem;">
                                <strong>Actions de remdiation disponibles:</strong>
                                <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                                    <button class="btn btn-danger" onclick="confirmRADIUSRemediation(${firewall.id})" style="font-size: 0.8rem;">
                                         Changer Shared Secrets
                                    </button>
                                </div>
                            </div>
                        ` : !hasSecrets ? `
                            <div style="background: #dcfce7; border: 1px solid #22c55e; border-radius: 8px; padding: 1rem;">
                                <strong> Safe</strong> - Aucun shared secret configur
                            </div>
                        ` : ''}
                    `;
                    
                    remediationGrid.appendChild(firewallCard);
                } catch (error) {
                    console.error('Error loading RADIUS remediation:', error);
                }
            }
        }

        async function confirmRADIUSRemediation(firewallId) {
            const firewall = firewalls.find(f => f.id === firewallId);
            if (!firewall) {
                showAlert('error', 'Firewall non trouv', 'radius-alert-container');
                return;
            }

            try {
                const radiusResponse = await fetch('/api/radius-config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        ip: firewall.ip,
                        username: firewall.username,
                        password: firewall.password
                    })
                });
                const radiusData = await radiusResponse.json();
                const servers = radiusData.radius_config?.user?.radius?.server || [];
                
                console.log('RADIUS Remediation - servers:', servers);
                
                if (servers.length === 0) {
                    showAlert('error', 'Aucun serveur RADIUS trouv', 'radius-alert-container');
                    return;
                }
                
                let modalInputs = '';
                servers.forEach((server, idx) => {
                    modalInputs += `
                        <div style="margin-bottom: 1rem; padding: 0.75rem; background: var(--gray-50); border-radius: 6px;">
                            <div style="margin-bottom: 0.5rem;">
                                <strong>Serveur ${idx + 1}:</strong> ${server.host}:${server.port}
                            </div>
                            <input 
                                type="password" 
                                id="radius-secret-${idx}" 
                                placeholder="Nouveau shared secret"
                                data-server-host="${server.host}"
                                style="
                                    width: 100%;
                                    padding: 0.5rem;
                                    border: 1px solid var(--gray-300);
                                    border-radius: 4px;
                                    font-size: 0.9rem;
                                "
                            >
                        </div>
                    `;
                });
                
                const modalHtml = `
                    <div id="radius-remediation-modal" style="
                        position: fixed;
                        top: 0;
                        left: 0;
                        right: 0;
                        bottom: 0;
                        background: rgba(0,0,0,0.5);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        z-index: 10000;
                    ">
                        <div style="
                            background: white;
                            padding: 2rem;
                            border-radius: 12px;
                            max-width: 600px;
                            width: 90%;
                            max-height: 80vh;
                            overflow-y: auto;
                            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
                        ">
                            <h3 style="margin: 0 0 1rem 0;"> Changer Shared Secrets RADIUS</h3>
                            <p style="margin-bottom: 1.5rem; color: var(--gray-600);">
                                Configurez les nouveaux shared secrets pour les serveurs RADIUS. Ils seront configurs sur le firewall et sauvegards en base.
                            </p>
                            
                            ${modalInputs}
                            
                            <div style="background: #fee2e2; padding: 0.75rem; border-radius: 6px; margin-bottom: 1.5rem; font-size: 0.85rem;">
                                <strong> Important:</strong> Vous devez configurer ces mmes shared secrets sur vos serveurs RADIUS pour que l'authentification fonctionne.
                            </div>
                            
                            <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
                                <button class="btn btn-secondary" onclick="closeRADIUSModal()">
                                    Annuler
                                </button>
                                <button class="btn btn-danger" onclick="executeRADIUSRemediation(${firewallId}, ${servers.length})">
                                     Changer Shared Secrets
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                const existingModal = document.getElementById('radius-remediation-modal');
                if (existingModal) {
                    existingModal.remove();
                }
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                
            } catch (error) {
                console.error('Error loading RADIUS data:', error);
                showAlert('error', 'Erreur lors du chargement des donnes RADIUS', 'radius-alert-container');
            }
        }

        function closeRADIUSModal() {
            const modal = document.getElementById('radius-remediation-modal');
            if (modal) {
                modal.remove();
            }
        }

        async function executeRADIUSRemediation(firewallId, serverCount) {
            const secrets = [];
            for (let i = 0; i < serverCount; i++) {
                const input = document.getElementById(`radius-secret-${i}`);
                const secret = input?.value?.trim();
                const host = input?.getAttribute('data-server-host');
                
                if (!secret) {
                    alert(`Veuillez entrer un shared secret pour le serveur ${host}`);
                    return;
                }
                
                secrets.push({
                    host: host,
                    secret: secret
                });
            }

            closeRADIUSModal();

            try {
                showAlert('warning', 'Changement des shared secrets RADIUS en cours...', 'radius-alert-container');
                
                const response = await fetch('/api/remediation/radius/change-secrets', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        firewall_id: firewallId,
                        secrets: secrets
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert('success', `${result.message} - Shared secrets sauvegards en base de donnes`, 'radius-alert-container');
                    
                    setTimeout(async () => {
                        await checkRADIUS();
                        await loadRADIUSRemediation();
                    }, 500);
                } else {
                    showAlert('error', result.message, 'radius-alert-container');
                }
                
            } catch (error) {
                console.error('Error executing RADIUS remediation:', error);
                showAlert('error', `Erreur lors de l'excution: ${error.message}`, 'radius-alert-container');
            }
        }

        // RADIUS Functions
        async function checkRADIUS() {
            if (firewalls.length === 0) {
                showAlert('warning', 'No firewalls available. Add firewalls first.', 'radius-alert-container');
                return;
            }

            showAlert('warning', 'Checking RADIUS configuration...', 'radius-alert-container');
            
            const radiusData = [];
            
            for (const firewall of firewalls) {
                try {
                    const statusResponse = await fetch(`/api/remediation/status/${firewall.id}/radius`);
                    const statusData = await statusResponse.json();
                    
                    const response = await fetch('/api/radius-config', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            ip: firewall.ip,
                            username: firewall.username,
                            password: firewall.password
                        })
                    });

                    const result = await response.json();
                    
                    const config = result.radius_config || {};
                    const servers = config.user?.radius?.server || [];
                    const secretsCount = servers.filter(s => s.shared_secret).length;
                    
                    radiusData.push({
                        firewall: firewall,
                        config: config,
                        servers: servers,
                        secretsCount: secretsCount,
                        remediationStatus: statusData.status || {},
                        lastChecked: new Date().toISOString()
                    });
                } catch (error) {
                    radiusData.push({
                        firewall: firewall,
                        config: {},
                        secretsCount: 0,
                        remediationStatus: {},
                        error: error.message,
                        lastChecked: new Date().toISOString()
                    });
                }
            }

            renderRADIUS(radiusData);
            showAlert('success', 'RADIUS check completed', 'radius-alert-container');
        }

        function renderRADIUS(data) {
            const grid = document.getElementById('radius-grid');
            
            if (data.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon"></div>
                        <h3>No RADIUS Data</h3>
                        <p>Click "Check RADIUS Configuration" to analyze RADIUS servers</p>
                    </div>
                `;
                return;
            }

            grid.innerHTML = data.map((item, index) => {
                const fwName = item.firewall.name || item.firewall.ip;
                const config = item.config;
                const servers = item.servers || [];
                const hasRisk = item.secretsCount > 0;
                const remediationStatus = item.remediationStatus || {};
                const isResolved = remediationStatus.is_resolved;
                const secretsChanged = remediationStatus.notes && remediationStatus.notes.includes('Shared secrets changs');
                
                let statusColor, statusBadge;
                if (isResolved) {
                    statusColor = '#dcfce7';
                    statusBadge = `<span class="badge badge-success"> Secrets changs</span>`;
                } else if (secretsChanged) {
                    statusColor = '#fef3c7';
                    statusBadge = `<span class="badge badge-warning"> Secrets changs</span>`;
                } else if (hasRisk) {
                    statusColor = '#fee2e2';
                    statusBadge = `<span class="badge badge-danger"> ${item.secretsCount} secret${item.secretsCount !== 1 ? 's' : ''} compromis</span>`;
                } else if (servers.length === 0) {
                    statusColor = 'var(--gray-50)';
                    statusBadge = `<span class="badge badge-secondary">Not configured</span>`;
                } else {
                    statusColor = '#dcfce7';
                    statusBadge = `<span class="badge badge-success"> Safe</span>`;
                }
                
                return `
                    <div class="firewall-user-accordion">
                        <div class="firewall-user-header ${''}" onclick="toggleUserAccordion('radius-${item.firewall.id}')" style="background: ${statusColor}; ${isResolved ? 'border: 2px solid #22c55e;' : hasRisk ? 'border: 2px solid ' + (secretsChanged ? '#f59e0b' : '#ef4444') + ';' : ''}" onmouseover="this.style.background='${statusColor === '#fee2e2' ? '#fecaca' : statusColor === '#fef3c7' ? '#fde68a' : statusColor === '#dcfce7' ? '#bbf7d0' : 'var(--gray-100)'}'" onmouseout="this.style.background='${statusColor}'">
                            <div class="fw-name">
                                <span></span>
                                <span style="color: ${isResolved ? '#166534' : hasRisk ? '#991b1b' : 'var(--gray-900)'};">${fwName} (${item.firewall.ip})</span>
                            </div>
                            ${statusBadge}
                            <span class="arrow"></span>
                        </div>
                        <div id="radius-${item.firewall.id}" class="firewall-user-content ${''}">
                            ${item.error ? `
                                <div class="alert alert-danger"><strong>Error:</strong> ${item.error}</div>
                            ` : servers.length === 0 ? `
                                <div class="empty-state"><p>No RADIUS servers configured on this firewall</p></div>
                            ` : `
                                <div style="margin-bottom: 1rem;">
                                    <h4 style="font-size: 0.95rem; margin-bottom: 0.5rem;"> RADIUS Servers (${servers.length})</h4>
                                    <table class="users-table">
                                        <thead>
                                            <tr>
                                                <th>Host</th>
                                                <th>Port</th>
                                                <th>Status</th>
                                                <th>Shared Secret</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${servers.map(srv => `
                                                <tr>
                                                    <td><strong>${srv.host || 'N/A'}</strong></td>
                                                    <td>${srv.port || 1812}</td>
                                                    <td>${srv.enable ? '<span class="badge badge-success"> Enabled</span>' : '<span class="badge badge-secondary"> Disabled</span>'}</td>
                                                    <td>${srv.shared_secret ? '<span class="badge badge-warning"> Configured</span>' : '<span class="badge badge-secondary">Not configured</span>'}</td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                                
                                ${hasRisk && !isResolved ? `
                                    <div style="background: #fee2e2; border: 1px solid #ef4444; border-radius: 8px; padding: 1rem;">
                                        <strong> Alerte Scurit</strong><br>
                                        ${item.secretsCount} serveur(s) RADIUS ont des shared secrets qui doivent tre changs.
                                    </div>
                                ` : ''}
                            `}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function refreshRADIUS() {
            checkRADIUS();
        }

        function switchTACACSSubmenu(submenu) {
            // Update buttons
            const section = document.getElementById('tacacs-section');
            section.querySelectorAll('.module-submenu .submenu-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            section.querySelector(`[data-submenu="${submenu}"]`).classList.add('active');
            
            // Update content
            section.querySelectorAll('.submenu-content').forEach(content => {
                content.classList.remove('active');
            });
            
            if (submenu === 'monitoring') {
                document.getElementById('tacacs-monitoring').classList.add('active');
            } else if (submenu === 'remediation') {
                document.getElementById('tacacs-remediation').classList.add('active');
                loadTACACSRemediation();
            }
        }

        // TACACS+ Remediation Functions
        async function loadTACACSRemediation() {
            if (firewalls.length === 0) {
                showAlert('warning', 'No firewalls available. Add firewalls first.', 'tacacs-alert-container');
                return;
            }

            const remediationGrid = document.getElementById('tacacs-remediation-grid');
            remediationGrid.innerHTML = '';

            for (const firewall of firewalls) {
                try {
                    const statusResponse = await fetch(`/api/remediation/status/${firewall.id}/tacacs`);
                    const statusData = await statusResponse.json();
                    
                    const tacacsResponse = await fetch('/api/tacacs-config', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            ip: firewall.ip,
                            username: firewall.username,
                            password: firewall.password
                        })
                    });
                    const tacacsData = await tacacsResponse.json();
                    
                    const config = tacacsData.tacacs_config || {};
                    const servers = config.user?.tacacs?.server || [];
                    const secretsCount = servers.filter(s => s.shared_secret).length;
                    const hasSecrets = secretsCount > 0;
                    
                    const status = statusData.status || {};
                    const secretsChanged = status.notes && status.notes.includes('Shared secrets changs');
                    
                    let statusColor, statusText, statusIcon;
                    if (status.is_resolved) {
                        statusColor = '#dcfce7';
                        statusText = ' RSOLU - Shared secrets changs';
                        statusIcon = '';
                    } else if (secretsChanged) {
                        statusColor = '#fef3c7';
                        statusText = ' PARTIELLEMENT RSOLU - Shared secrets changs ';
                        statusIcon = '';
                    } else if (hasSecrets) {
                        statusColor = '#fee2e2';
                        statusText = ' CRITIQUE - Shared secrets compromis';
                        statusIcon = '';
                    } else {
                        statusColor = '#dcfce7';
                        statusText = ' SAFE - Aucun shared secret configur';
                        statusIcon = '';
                    }
                    
                    const firewallCard = document.createElement('div');
                    firewallCard.className = 'remediation-card';
                    firewallCard.style.cssText = `
                        background: ${statusColor};
                        border: 2px solid ${statusColor === '#fee2e2' ? '#ef4444' : statusColor === '#fef3c7' ? '#f59e0b' : 'var(--gray-200)'};
                        border-radius: 12px;
                        padding: 1.5rem;
                        margin-bottom: 1rem;
                        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                    `;
                    
                    firewallCard.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <div>
                                <h3 style="margin: 0; font-size: 1.1rem;">
                                     ${firewall.name || firewall.ip} (${firewall.ip})
                                </h3>
                                <p style="margin: 0.5rem 0 0 0; color: var(--gray-600); font-size: 0.9rem;">
                                    ${statusIcon} ${statusText}
                                </p>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 1rem;">
                            <strong>Dtails:</strong>
                            <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
                                <li>Serveurs TACACS+: ${servers.length}</li>
                                ${secretsChanged ? `
                                    <li>Shared Secrets: Changs </li>
                                ` : hasSecrets ? `
                                    <li>Shared Secrets: ${secretsCount} configur(s) (compromis) </li>
                                ` : `
                                    <li>Shared Secrets: Aucun</li>
                                `}
                            </ul>
                        </div>
                        
                        ${status.is_resolved ? `
                            <div style="background: #dcfce7; border: 1px solid #22c55e; border-radius: 8px; padding: 1rem;">
                                <strong> Problme rsolu</strong><br>
                                Rsolu le: ${status.resolution_date ? new Date(status.resolution_date).toLocaleString() : 'Date inconnue'}<br>
                                Mthode: ${status.verification_method || 'Remediation manuelle'}
                            </div>
                        ` : hasSecrets && !secretsChanged ? `
                            <div style="margin-bottom: 1rem;">
                                <strong>Actions de remdiation disponibles:</strong>
                                <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                                    <button class="btn btn-danger" onclick="confirmTACACSRemediation(${firewall.id})" style="font-size: 0.8rem;">
                                         Changer Shared Secrets
                                    </button>
                                </div>
                            </div>
                        ` : !hasSecrets ? `
                            <div style="background: #dcfce7; border: 1px solid #22c55e; border-radius: 8px; padding: 1rem;">
                                <strong> Safe</strong> - Aucun shared secret configur
                            </div>
                        ` : ''}
                    `;
                    
                    remediationGrid.appendChild(firewallCard);
                } catch (error) {
                    console.error('Error loading TACACS+ remediation:', error);
                }
            }
        }

        async function confirmTACACSRemediation(firewallId) {
            const firewall = firewalls.find(f => f.id === firewallId);
            if (!firewall) {
                showAlert('error', 'Firewall non trouv', 'tacacs-alert-container');
                return;
            }

            try {
                const tacacsResponse = await fetch('/api/tacacs-config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        ip: firewall.ip,
                        username: firewall.username,
                        password: firewall.password
                    })
                });
                const tacacsData = await tacacsResponse.json();
                const servers = tacacsData.tacacs_config?.user?.tacacs?.server || [];
                
                console.log('TACACS Remediation - servers:', servers);
                
                if (servers.length === 0) {
                    showAlert('error', 'Aucun serveur TACACS+ trouv', 'tacacs-alert-container');
                    return;
                }
                
                let modalInputs = '';
                servers.forEach((server, idx) => {
                    modalInputs += `
                        <div style="margin-bottom: 1rem; padding: 0.75rem; background: var(--gray-50); border-radius: 6px;">
                            <div style="margin-bottom: 0.5rem;">
                                <strong>Serveur ${idx + 1}:</strong> ${server.host}:${server.port}
                            </div>
                            <input 
                                type="password" 
                                id="tacacs-secret-${idx}" 
                                placeholder="Nouveau shared secret"
                                data-server-host="${server.host}"
                                style="
                                    width: 100%;
                                    padding: 0.5rem;
                                    border: 1px solid var(--gray-300);
                                    border-radius: 4px;
                                    font-size: 0.9rem;
                                "
                            >
                        </div>
                    `;
                });
                
                const modalHtml = `
                    <div id="tacacs-remediation-modal" style="
                        position: fixed;
                        top: 0;
                        left: 0;
                        right: 0;
                        bottom: 0;
                        background: rgba(0,0,0,0.5);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        z-index: 10000;
                    ">
                        <div style="
                            background: white;
                            padding: 2rem;
                            border-radius: 12px;
                            max-width: 600px;
                            width: 90%;
                            max-height: 80vh;
                            overflow-y: auto;
                            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
                        ">
                            <h3 style="margin: 0 0 1rem 0;"> Changer Shared Secrets TACACS+</h3>
                            <p style="margin-bottom: 1.5rem; color: var(--gray-600);">
                                Configurez les nouveaux shared secrets pour les serveurs TACACS+. Ils seront configurs sur le firewall et sauvegards en base.
                            </p>
                            
                            ${modalInputs}
                            
                            <div style="background: #fee2e2; padding: 0.75rem; border-radius: 6px; margin-bottom: 1.5rem; font-size: 0.85rem;">
                                <strong> Important:</strong> Vous devez configurer ces mmes shared secrets sur vos serveurs TACACS+ pour que l'authentification fonctionne.
                            </div>
                            
                            <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
                                <button class="btn btn-secondary" onclick="closeTACACSModal()">
                                    Annuler
                                </button>
                                <button class="btn btn-danger" onclick="executeTACACSRemediation(${firewallId}, ${servers.length})">
                                     Changer Shared Secrets
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                const existingModal = document.getElementById('tacacs-remediation-modal');
                if (existingModal) {
                    existingModal.remove();
                }
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                
            } catch (error) {
                console.error('Error loading TACACS+ data:', error);
                showAlert('error', 'Erreur lors du chargement des donnes TACACS+', 'tacacs-alert-container');
            }
        }

        function closeTACACSModal() {
            const modal = document.getElementById('tacacs-remediation-modal');
            if (modal) {
                modal.remove();
            }
        }

        async function executeTACACSRemediation(firewallId, serverCount) {
            const secrets = [];
            for (let i = 0; i < serverCount; i++) {
                const input = document.getElementById(`tacacs-secret-${i}`);
                const secret = input?.value?.trim();
                const host = input?.getAttribute('data-server-host');
                
                if (!secret) {
                    alert(`Veuillez entrer un shared secret pour le serveur ${host}`);
                    return;
                }
                
                secrets.push({
                    host: host,
                    secret: secret
                });
            }

            closeTACACSModal();

            try {
                showAlert('warning', 'Changement des shared secrets TACACS+ en cours...', 'tacacs-alert-container');
                
                const response = await fetch('/api/remediation/tacacs/change-secrets', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        firewall_id: firewallId,
                        secrets: secrets
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert('success', `${result.message} - Shared secrets sauvegards en base de donnes`, 'tacacs-alert-container');
                    
                    setTimeout(async () => {
                        await checkTACACS();
                        await loadTACACSRemediation();
                    }, 500);
                } else {
                    showAlert('error', result.message, 'tacacs-alert-container');
                }
                
            } catch (error) {
                console.error('Error executing TACACS+ remediation:', error);
                showAlert('error', `Erreur lors de l'excution: ${error.message}`, 'tacacs-alert-container');
            }
        }

        // TACACS+ Functions
        async function checkTACACS() {
            if (firewalls.length === 0) {
                showAlert('warning', 'No firewalls available. Add firewalls first.', 'tacacs-alert-container');
                return;
            }

            showAlert('warning', 'Checking TACACS+ configuration...', 'tacacs-alert-container');
            
            const tacacsData = [];
            
            for (const firewall of firewalls) {
                try {
                    const statusResponse = await fetch(`/api/remediation/status/${firewall.id}/tacacs`);
                    const statusData = await statusResponse.json();
                    
                    const response = await fetch('/api/tacacs-config', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            ip: firewall.ip,
                            username: firewall.username,
                            password: firewall.password
                        })
                    });

                    const result = await response.json();
                    
                    const config = result.tacacs_config || {};
                    const servers = config.user?.tacacs?.server || [];
                    const secretsCount = servers.filter(s => s.shared_secret).length;
                    
                    tacacsData.push({
                        firewall: firewall,
                        config: config,
                        servers: servers,
                        secretsCount: secretsCount,
                        remediationStatus: statusData.status || {},
                        lastChecked: new Date().toISOString()
                    });
                } catch (error) {
                    tacacsData.push({
                        firewall: firewall,
                        config: {},
                        secretsCount: 0,
                        remediationStatus: {},
                        error: error.message,
                        lastChecked: new Date().toISOString()
                    });
                }
            }

            renderTACACS(tacacsData);
            showAlert('success', 'TACACS+ check completed', 'tacacs-alert-container');
        }

        function renderTACACS(data) {
            const grid = document.getElementById('tacacs-grid');
            
            if (data.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon"></div>
                        <h3>No TACACS+ Data</h3>
                        <p>Click "Check TACACS+ Configuration" to analyze TACACS+ servers</p>
                    </div>
                `;
                return;
            }

            grid.innerHTML = data.map((item, index) => {
                const fwName = item.firewall.name || item.firewall.ip;
                const config = item.config;
                const servers = item.servers || [];
                const hasRisk = item.secretsCount > 0;
                const remediationStatus = item.remediationStatus || {};
                const isResolved = remediationStatus.is_resolved;
                const secretsChanged = remediationStatus.notes && remediationStatus.notes.includes('Shared secrets changs');
                
                let statusColor, statusBadge;
                if (isResolved) {
                    statusColor = '#dcfce7';
                    statusBadge = `<span class="badge badge-success"> Secrets changs</span>`;
                } else if (secretsChanged) {
                    statusColor = '#fef3c7';
                    statusBadge = `<span class="badge badge-warning"> Secrets changs</span>`;
                } else if (hasRisk) {
                    statusColor = '#fee2e2';
                    statusBadge = `<span class="badge badge-danger"> ${item.secretsCount} secret${item.secretsCount !== 1 ? 's' : ''} compromis</span>`;
                } else if (authServers.length === 0 && acctServers.length === 0) {
                    statusColor = 'var(--gray-50)';
                    statusBadge = `<span class="badge badge-secondary">Not configured</span>`;
                } else {
                    statusColor = '#dcfce7';
                    statusBadge = `<span class="badge badge-success"> Safe</span>`;
                }
                
                return `
                    <div class="firewall-user-accordion">
                        <div class="firewall-user-header ${''}" onclick="toggleUserAccordion('tacacs-${item.firewall.id}')" style="background: ${statusColor}; ${isResolved ? 'border: 2px solid #22c55e;' : hasRisk ? 'border: 2px solid ' + (secretsChanged ? '#f59e0b' : '#ef4444') + ';' : ''}" onmouseover="this.style.background='${statusColor === '#fee2e2' ? '#fecaca' : statusColor === '#fef3c7' ? '#fde68a' : statusColor === '#dcfce7' ? '#bbf7d0' : 'var(--gray-100)'}'" onmouseout="this.style.background='${statusColor}'">
                            <div class="fw-name">
                                <span></span>
                                <span style="color: ${isResolved ? '#166534' : hasRisk ? '#991b1b' : 'var(--gray-900)'};">${fwName} (${item.firewall.ip})</span>
                            </div>
                            ${statusBadge}
                            <span class="arrow"></span>
                        </div>
                        <div id="tacacs-${item.firewall.id}" class="firewall-user-content ${''}">
                            ${item.error ? `
                                <div class="alert alert-danger"><strong>Error:</strong> ${item.error}</div>
                            ` : servers.length === 0 ? `
                                <div class="empty-state"><p>No TACACS+ servers configured on this firewall</p></div>
                            ` : `
                                <div style="margin-bottom: 1rem;">
                                    <h4 style="font-size: 0.95rem; margin-bottom: 0.5rem;"> TACACS+ Servers (${servers.length})</h4>
                                    <table class="users-table">
                                        <thead>
                                            <tr>
                                                <th>Host</th>
                                                <th>Port</th>
                                                <th>Status</th>
                                                <th>Shared Secret</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${servers.map(srv => `
                                                <tr>
                                                    <td><strong>${srv.host || 'N/A'}</strong></td>
                                                    <td>${srv.port || 49}</td>
                                                    <td>${srv.enable ? '<span class="badge badge-success"> Enabled</span>' : '<span class="badge badge-secondary"> Disabled</span>'}</td>
                                                    <td>${srv.shared_secret ? '<span class="badge badge-warning"> Configured</span>' : '<span class="badge badge-secondary">Not configured</span>'}</td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                                
                                ${hasRisk && !isResolved ? `
                                    <div style="background: #fee2e2; border: 1px solid #ef4444; border-radius: 8px; padding: 1rem;">
                                        <strong> Alerte Scurit</strong><br>
                                        ${item.secretsCount} serveur(s) TACACS+ ont des shared secrets qui doivent tre changs.
                                    </div>
                                ` : ''}
                            `}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function refreshTACACS() {
            checkTACACS();
        }

        function switchSSOSubmenu(submenu) {
            const section = document.getElementById('sso-section');
            section.querySelectorAll('.module-submenu .submenu-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            section.querySelector(`[data-submenu="${submenu}"]`).classList.add('active');
            
            section.querySelectorAll('.submenu-content').forEach(content => {
                content.classList.remove('active');
            });
            
            if (submenu === 'monitoring') {
                document.getElementById('sso-monitoring').classList.add('active');
            } else if (submenu === 'remediation') {
                document.getElementById('sso-remediation').classList.add('active');
                loadSSORemediation();
            }
        }

        // SSO Remediation Functions
        async function loadSSORemediation() {
            if (firewalls.length === 0) {
                showAlert('warning', 'No firewalls available. Add firewalls first.', 'sso-alert-container');
                return;
            }

            const remediationGrid = document.getElementById('sso-remediation-grid');
            remediationGrid.innerHTML = '';

            for (const firewall of firewalls) {
                try {
                    // Get remediation status for each SSO type
                    const statusResponseAgent = await fetch(`/api/remediation/status/${firewall.id}/sso_agent`);
                    const statusAgent = await statusResponseAgent.json();
                    
                    const statusResponseTS = await fetch(`/api/remediation/status/${firewall.id}/sso_ts`);
                    const statusTS = await statusResponseTS.json();
                    
                    const statusResponseRadius = await fetch(`/api/remediation/status/${firewall.id}/sso_radius`);
                    const statusRadius = await statusResponseRadius.json();
                    
                    const ssoResponse = await fetch('/api/sso-config', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            ip: firewall.ip,
                            username: firewall.username,
                            password: firewall.password
                        })
                    });
                    const ssoData = await ssoResponse.json();
                    
                    const config = ssoData.sso_config || {};
                    const ssoConfig = config.user?.sso || {};
                    const agents = ssoConfig.agents || [];
                    const tsAgents = ssoConfig.ts_agents || [];
                    const radiusClients = ssoConfig.radius_clients || [];
                    
                    const hasAgents = agents.length > 0;
                    const hasTS = tsAgents.length > 0;
                    const hasRadius = radiusClients.length > 0;
                    
                    const agentResolved = statusAgent.status?.is_resolved;
                    const tsResolved = statusTS.status?.is_resolved;
                    const radiusResolved = statusRadius.status?.is_resolved;
                    
                    // Logique de rsolution : Vert si tous les types configurs sont rsolus
                    let totalConfigured = 0;
                    let totalResolved = 0;
                    
                    if (hasAgents) {
                        totalConfigured++;
                        if (agentResolved) totalResolved++;
                    }
                    if (hasTS) {
                        totalConfigured++;
                        if (tsResolved) totalResolved++;
                    }
                    if (hasRadius) {
                        totalConfigured++;
                        if (radiusResolved) totalResolved++;
                    }
                    
                    let statusColor, statusText, statusIcon;
                    if (totalConfigured === 0) {
                        statusColor = '#dcfce7';
                        statusText = ' SAFE - Aucun agent SSO configur';
                        statusIcon = '';
                    } else if (totalResolved === totalConfigured) {
                        statusColor = '#dcfce7';
                        statusText = ' RSOLU - Tous les shared keys changs';
                        statusIcon = '';
                    } else if (totalResolved > 0) {
                        statusColor = '#fef3c7';
                        statusText = ` PARTIELLEMENT RSOLU - ${totalResolved}/${totalConfigured} types rsolus`;
                        statusIcon = '';
                    } else {
                        statusColor = '#fee2e2';
                        statusText = ' CRITIQUE - Shared keys compromis';
                        statusIcon = '';
                    }
                    
                    const firewallCard = document.createElement('div');
                    firewallCard.className = 'remediation-card';
                    firewallCard.style.cssText = `
                        background: ${statusColor};
                        border: 2px solid ${statusColor === '#fee2e2' ? '#ef4444' : statusColor === '#fef3c7' ? '#f59e0b' : 'var(--gray-200)'};
                        border-radius: 12px;
                        padding: 1.5rem;
                        margin-bottom: 1rem;
                        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                    `;
                    
                    let detailsHTML = '<strong>Dtails:</strong><ul style="margin: 0.5rem 0; padding-left: 1.5rem;">';
                    if (hasAgents) {
                        detailsHTML += `<li>SSO Agents: ${agents.length} ${agentResolved ? ' Rsolu' : '  rsoudre'}</li>`;
                    }
                    if (hasTS) {
                        detailsHTML += `<li>TS Agents: ${tsAgents.length} ${tsResolved ? ' Rsolu' : '  rsoudre'}</li>`;
                    }
                    if (hasRadius) {
                        detailsHTML += `<li>RADIUS Acct: ${radiusClients.length} ${radiusResolved ? ' Rsolu' : '  rsoudre'}</li>`;
                    }
                    detailsHTML += '</ul>';
                    
                    firewallCard.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <div>
                                <h3 style="margin: 0; font-size: 1.1rem;">
                                     ${firewall.name || firewall.ip} (${firewall.ip})
                                </h3>
                                <p style="margin: 0.5rem 0 0 0; color: var(--gray-600); font-size: 0.9rem;">
                                    ${statusIcon} ${statusText}
                                </p>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 1rem;">
                            ${detailsHTML}
                        </div>
                        
                        ${totalResolved === totalConfigured ? `
                            <div style="background: #dcfce7; border: 1px solid #22c55e; border-radius: 8px; padding: 1rem;">
                                <strong> Problme rsolu</strong><br>
                                Tous les shared keys ont t changs
                            </div>
                        ` : totalConfigured > 0 ? `
                            <div style="margin-bottom: 1rem;">
                                <strong>Actions de remdiation disponibles:</strong>
                                <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem; flex-wrap: wrap;">
                                    ${hasAgents && !agentResolved ? `
                                        <button class="btn btn-danger" onclick="confirmSSORemediation(${firewall.id}, 'agent')" style="font-size: 0.8rem;">
                                             Changer SSO Agent Keys
                                        </button>
                                    ` : ''}
                                    ${hasTS && !tsResolved ? `
                                        <button class="btn btn-danger" onclick="confirmSSORemediation(${firewall.id}, 'ts')" style="font-size: 0.8rem;">
                                             Changer TS Agent Keys
                                        </button>
                                    ` : ''}
                                    ${hasRadius && !radiusResolved ? `
                                        <button class="btn btn-danger" onclick="confirmSSORemediation(${firewall.id}, 'radius')" style="font-size: 0.8rem;">
                                             Changer RADIUS Acct Keys
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        ` : `
                            <div style="background: #dcfce7; border: 1px solid #22c55e; border-radius: 8px; padding: 1rem;">
                                <strong> Safe</strong> - Aucun agent SSO configur
                            </div>
                        `}
                    `;
                    
                    remediationGrid.appendChild(firewallCard);
                } catch (error) {
                    console.error('Error loading SSO remediation:', error);
                }
            }
        }

        async function confirmSSORemediation(firewallId, type) {
            const firewall = firewalls.find(f => f.id === firewallId);
            if (!firewall) {
                showAlert('error', 'Firewall non trouv', 'sso-alert-container');
                return;
            }

            try {
                const ssoResponse = await fetch('/api/sso-config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        ip: firewall.ip,
                        username: firewall.username,
                        password: firewall.password
                    })
                });
                const ssoData = await ssoResponse.json();
                const config = ssoData.sso_config || {};
                const ssoConfig = config.user?.sso || {};
                
                let servers = [];
                let title = '';
                let endpoint = '';
                
                if (type === 'agent') {
                    servers = ssoConfig.agents || [];
                    title = 'SSO Agents';
                    endpoint = 'agent-keys';
                } else if (type === 'ts') {
                    servers = ssoConfig.ts_agents || [];
                    title = 'Terminal Services Agents';
                    endpoint = 'ts-keys';
                } else if (type === 'radius') {
                    servers = ssoConfig.radius_clients || [];
                    title = 'RADIUS Accounting Clients';
                    endpoint = 'radius-secrets';
                }
                
                if (servers.length === 0) {
                    showAlert('error', `Aucun ${title} trouv`, 'sso-alert-container');
                    return;
                }
                
                let modalInputs = '';
                servers.forEach((server, idx) => {
                    const serverHost = server.host || server.name || `Server ${idx + 1}`;
                    
                    // SSO Agent et TS Agent ncessitent validation hex, RADIUS Accounting non
                    const needsHexValidation = (type === 'agent' || type === 'ts');
                    const placeholder = needsHexValidation 
                        ? 'Nouveau shared key (hex: 0-9,a-f,A-F seulement)' 
                        : 'Nouveau shared secret';
                    
                    modalInputs += `
                        <div style="margin-bottom: 1rem; padding: 0.75rem; background: var(--gray-50); border-radius: 6px;">
                            <div style="margin-bottom: 0.5rem;">
                                <strong>Server ${idx + 1}:</strong> ${serverHost}
                            </div>
                            <input 
                                type="password" 
                                id="sso-secret-${idx}" 
                                placeholder="${placeholder}"
                                data-server-host="${serverHost}"
                                ${needsHexValidation ? 'oninput="validateSSOSecret(this)"' : ''}
                                style="
                                    width: 100%;
                                    padding: 0.5rem;
                                    border: 1px solid var(--gray-300);
                                    border-radius: 4px;
                                    font-size: 0.9rem;
                                "
                            >
                            ${needsHexValidation ? `
                            <div id="sso-secret-${idx}-error" style="color: #ef4444; font-size: 0.8rem; margin-top: 0.25rem; display: none;">
                                 Format invalide. Utilisez seulement 0-9, a-f, A-F
                            </div>
                            ` : ''}
                        </div>
                    `;
                });
                
                const modalHtml = `
                    <div id="sso-remediation-modal" style="
                        position: fixed;
                        top: 0;
                        left: 0;
                        right: 0;
                        bottom: 0;
                        background: rgba(0,0,0,0.5);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        z-index: 10000;
                    ">
                        <div style="
                            background: white;
                            padding: 2rem;
                            border-radius: 12px;
                            max-width: 600px;
                            width: 90%;
                            max-height: 80vh;
                            overflow-y: auto;
                            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
                        ">
                            <h3 style="margin: 0 0 1rem 0;"> Changer Shared Keys - ${title}</h3>
                            <p style="margin-bottom: 1.5rem; color: var(--gray-600);">
                                Configurez les nouveaux shared keys pour les ${title}. Ils seront configurs sur le firewall et sauvegards en base.
                            </p>
                            
                            ${modalInputs}
                            
                            <div style="background: #fee2e2; padding: 0.75rem; border-radius: 6px; margin-bottom: 1.5rem; font-size: 0.85rem;">
                                <strong> Important:</strong> Vous devez configurer ces mmes shared keys sur vos serveurs SSO.
                            </div>
                            
                            <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
                                <button class="btn btn-secondary" onclick="closeSSOModal()">
                                    Annuler
                                </button>
                                <button class="btn btn-danger" onclick="executeSSORemediation(${firewallId}, '${type}', '${endpoint}', ${servers.length})">
                                     Changer Shared Keys
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                const existingModal = document.getElementById('sso-remediation-modal');
                if (existingModal) {
                    existingModal.remove();
                }
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                
            } catch (error) {
                console.error('Error loading SSO data:', error);
                showAlert('error', 'Erreur lors du chargement des donnes SSO', 'sso-alert-container');
            }
        }

        function closeSSOModal() {
            const modal = document.getElementById('sso-remediation-modal');
            if (modal) {
                modal.remove();
            }
        }

        function validateSSOSecret(input) {
            const value = input.value;
            // Find the error div (works for sso-secret-*, ts-secret-*, radius-secret-*)
            const errorDiv = document.getElementById(input.id + '-error');
            const isValid = /^[0-9a-fA-F]+$/.test(value);
            
            if (value && !isValid) {
                input.style.borderColor = '#ef4444';
                if (errorDiv) errorDiv.style.display = 'block';
            } else {
                input.style.borderColor = '#22c55e';
                if (errorDiv) errorDiv.style.display = 'none';
            }
            
            return isValid;
        }

        async function executeSSORemediation(firewallId, type, endpoint, serverCount) {
            const secrets = [];
            let hasValidationErrors = false;
            
            // Determine if hex validation is needed (only for agent and ts types)
            const needsHexValidation = (type === 'agent' || type === 'ts');
            
            for (let i = 0; i < serverCount; i++) {
                const input = document.getElementById(`sso-secret-${i}`);
                const secret = input?.value?.trim();
                const host = input?.getAttribute('data-server-host');
                
                if (!secret) {
                    alert(`Veuillez entrer un shared ${needsHexValidation ? 'key' : 'secret'} pour le serveur ${host}`);
                    return;
                }
                
                // Validate hex format only for SSO Agents and TS Agents
                if (needsHexValidation && !validateSSOSecret(input)) {
                    hasValidationErrors = true;
                    alert(`Format invalide pour le serveur ${host}. Utilisez seulement 0-9, a-f, A-F`);
                    return;
                }
                
                secrets.push({
                    host: host,
                    secret: secret
                });
            }
            
            if (hasValidationErrors) {
                return;
            }

            closeSSOModal();

            try {
                showAlert('warning', 'Changement des shared keys SSO en cours...', 'sso-alert-container');
                
                const response = await fetch(`/api/remediation/sso/change-${endpoint}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        firewall_id: firewallId,
                        type: type,
                        secrets: secrets
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert('success', `${result.message} - Shared keys sauvegards en base de donnes`, 'sso-alert-container');
                    
                    setTimeout(async () => {
                        await checkSSO();
                        await loadSSORemediation();
                    }, 500);
                } else {
                    showAlert('error', result.message, 'sso-alert-container');
                }
                
            } catch (error) {
                console.error('Error executing SSO remediation:', error);
                showAlert('error', `Erreur lors de l'excution: ${error.message}`, 'sso-alert-container');
            }
        }

        // SSO Functions
        async function checkSSO() {
            if (firewalls.length === 0) {
                showAlert('warning', 'No firewalls available. Add firewalls first.', 'sso-alert-container');
                return;
            }

            showAlert('warning', 'Checking SSO configuration...', 'sso-alert-container');
            
            const ssoData = [];
            
            for (const firewall of firewalls) {
                try {
                    const response = await fetch('/api/sso-config', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            ip: firewall.ip,
                            username: firewall.username,
                            password: firewall.password
                        })
                    });

                    const result = await response.json();
                    
                    // Get remediation status for all 3 SSO types
                    const statusResponseAgent = await fetch(`/api/remediation/status/${firewall.id}/sso_agent`);
                    const statusAgent = await statusResponseAgent.json();
                    
                    const statusResponseTS = await fetch(`/api/remediation/status/${firewall.id}/sso_ts`);
                    const statusTS = await statusResponseTS.json();
                    
                    const statusResponseRadius = await fetch(`/api/remediation/status/${firewall.id}/sso_radius`);
                    const statusRadius = await statusResponseRadius.json();
                    
                    ssoData.push({
                        firewall: firewall,
                        config: result.sso_config || {},
                        keysCount: result.sso_config?.user?.sso?.keys_count || 0,
                        remediationStatusAgent: statusAgent.status || {},
                        remediationStatusTS: statusTS.status || {},
                        remediationStatusRadius: statusRadius.status || {},
                        lastChecked: new Date().toISOString()
                    });
                } catch (error) {
                    ssoData.push({
                        firewall: firewall,
                        config: {},
                        keysCount: 0,
                        error: error.message,
                        lastChecked: new Date().toISOString()
                    });
                }
            }

            renderSSO(ssoData);
            showAlert('success', 'SSO check completed', 'sso-alert-container');
        }

        function renderSSO(data) {
            const grid = document.getElementById('sso-grid');
            
            if (data.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon"></div>
                        <h3>No SSO Data</h3>
                        <p>Click "Check SSO Configuration" to analyze SSO configuration</p>
                    </div>
                `;
                return;
            }

            grid.innerHTML = data.map((item, index) => {
                const fwName = item.firewall.name || item.firewall.ip;
                const config = item.config;
                const ssoConfig = config.user?.sso || {};
                const methods = ssoConfig.method || {};
                const agents = ssoConfig.agents || [];
                const tsAgents = ssoConfig.ts_agents || [];
                const radiusClients = ssoConfig.radius_clients || [];
                const hasRisk = item.keysCount > 0;
                
                // Get remediation status for all 3 types
                const remediationStatusAgent = item.remediationStatusAgent || {};
                const remediationStatusTS = item.remediationStatusTS || {};
                const remediationStatusRadius = item.remediationStatusRadius || {};
                
                const hasAgents = agents.length > 0;
                const hasTS = tsAgents.length > 0;
                const hasRadiusClients = radiusClients.length > 0;
                
                const agentResolved = remediationStatusAgent.is_resolved;
                const tsResolved = remediationStatusTS.is_resolved;
                const radiusResolved = remediationStatusRadius.is_resolved;
                
                // Calculate overall remediation status (same logic as in remediation view)
                let totalConfigured = 0;
                let totalResolved = 0;
                
                if (hasAgents) {
                    totalConfigured++;
                    if (agentResolved) totalResolved++;
                }
                if (hasTS) {
                    totalConfigured++;
                    if (tsResolved) totalResolved++;
                }
                if (hasRadiusClients) {
                    totalConfigured++;
                    if (radiusResolved) totalResolved++;
                }
                
                let statusColor, statusBadge;
                if (totalConfigured === 0) {
                    // No SSO configured = Safe (green)
                    statusColor = '#dcfce7';
                    statusBadge = `<span class="badge badge-secondary">Not configured</span>`;
                } else if (totalResolved === totalConfigured) {
                    // All configured types resolved = Green
                    statusColor = '#dcfce7';
                    statusBadge = `<span class="badge badge-success"> Tous les keys changs</span>`;
                } else if (totalResolved > 0) {
                    // Some resolved = Orange
                    statusColor = '#fef3c7';
                    statusBadge = `<span class="badge badge-warning"> ${totalResolved}/${totalConfigured} types rsolus</span>`;
                } else {
                    // None resolved = Red
                    statusColor = '#fee2e2';
                    statusBadge = `<span class="badge badge-danger"> ${item.keysCount} shared key${item.keysCount !== 1 ? 's' : ''} compromis</span>`;
                }
                
                return `
                    <div class="firewall-user-accordion">
                        <div class="firewall-user-header ${''}" onclick="toggleUserAccordion('sso-${item.firewall.id}')" style="background: ${statusColor}; ${totalResolved === totalConfigured && totalConfigured > 0 ? 'border: 2px solid #22c55e;' : totalConfigured > 0 ? 'border: 2px solid ' + (statusColor === '#fee2e2' ? '#ef4444' : '#f59e0b') + ';' : ''}" onmouseover="this.style.background='${statusColor === '#fee2e2' ? '#fecaca' : statusColor === '#fef3c7' ? '#fde68a' : statusColor === '#dcfce7' ? '#bbf7d0' : 'var(--gray-100)'}'" onmouseout="this.style.background='${statusColor}'">
                            <div class="fw-name">
                                <span></span>
                                <span style="color: ${totalResolved === totalConfigured && totalConfigured > 0 ? '#166534' : statusColor === '#fee2e2' ? '#991b1b' : 'var(--gray-900)'};">${fwName} (${item.firewall.ip})</span>
                            </div>
                            ${statusBadge}
                            <span class="arrow"></span>
                        </div>
                        <div id="sso-${item.firewall.id}" class="firewall-user-content ${''}">
                            ${item.error ? `
                                <div class="alert alert-danger"><strong>Error:</strong> ${item.error}</div>
                            ` : `
                                <div style="margin-bottom: 1rem;">
                                    <h4 style="font-size: 0.95rem; margin-bottom: 0.5rem;"> SSO Configuration</h4>
                                    <p style="font-size: 0.9rem; color: var(--gray-600);">
                                        SSO Agent: ${agents.length > 0 ? '' : ''} | 
                                        TS Agent: ${tsAgents.length > 0 ? '' : ''} | 
                                        RADIUS Acct: ${radiusClients.length > 0 ? '' : ''}
                                    </p>
                                </div>
                                
                                ${agents.length > 0 ? `
                                    <div style="margin-bottom: 1rem;">
                                        <h4 style="font-size: 0.95rem; margin-bottom: 0.5rem;"> SSO Agents (${agents.length})</h4>
                                        <table class="users-table">
                                            <thead>
                                                <tr>
                                                    <th>Host</th>
                                                    <th>Port</th>
                                                    <th>Status</th>
                                                    <th>Shared Key</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${agents.map(agent => `
                                                    <tr>
                                                        <td><strong>${agent.host}</strong></td>
                                                        <td>${agent.port}</td>
                                                        <td>${agent.enabled ? '<span class="badge badge-success"> Enabled</span>' : '<span class="badge badge-secondary"> Disabled</span>'}</td>
                                                        <td>${agent.has_shared_key ? '<span class="badge badge-warning"> Configured</span>' : '<span class="badge badge-secondary">Not configured</span>'}</td>
                                                    </tr>
                                                `).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                ` : ''}
                                
                                ${tsAgents.length > 0 ? `
                                    <div style="margin-bottom: 1rem;">
                                        <h4 style="font-size: 0.95rem; margin-bottom: 0.5rem;"> Terminal Services Agents (${tsAgents.length})</h4>
                                        <table class="users-table">
                                            <thead>
                                                <tr>
                                                    <th>Host</th>
                                                    <th>Port</th>
                                                    <th>Status</th>
                                                    <th>Shared Key</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${tsAgents.map(agent => `
                                                    <tr>
                                                        <td><strong>${agent.host}</strong></td>
                                                        <td>${agent.port}</td>
                                                        <td>${agent.enabled ? '<span class="badge badge-success"> Enabled</span>' : '<span class="badge badge-secondary"> Disabled</span>'}</td>
                                                        <td>${agent.has_shared_key ? '<span class="badge badge-warning"> Configured</span>' : '<span class="badge badge-secondary">Not configured</span>'}</td>
                                                    </tr>
                                                `).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                ` : ''}
                                
                                ${radiusClients.length > 0 ? `
                                    <div>
                                        <h4 style="font-size: 0.95rem; margin-bottom: 0.5rem;"> RADIUS Accounting Clients (${radiusClients.length})</h4>
                                        <table class="users-table">
                                            <thead>
                                                <tr>
                                                    <th>Host</th>
                                                    <th>Shared Secret</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${radiusClients.map(client => `
                                                    <tr>
                                                        <td><strong>${client.host}</strong></td>
                                                        <td>${client.has_shared_secret ? '<span class="badge badge-warning"> Configured</span>' : '<span class="badge badge-secondary">Not configured</span>'}</td>
                                                    </tr>
                                                `).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                ` : ''}
                                
                                ${agents.length === 0 && tsAgents.length === 0 && radiusClients.length === 0 ? `
                                    <div class="empty-state"><p>No SSO agents configured on this firewall</p></div>
                                ` : ''}
                            `}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function refreshSSO() {
            checkSSO();
        }

        // Cloud Secure Edge (CSE) Functions
        async function checkCSE() {
            if (firewalls.length === 0) {
                showAlert('warning', 'No firewalls available. Add firewalls first.', 'cse-alert-container');
                return;
            }

            showAlert('warning', 'Checking Cloud Secure Edge configuration...', 'cse-alert-container');
            
            const cseData = [];
            
            for (const firewall of firewalls) {
                try {
                    const response = await fetch('/api/cse-config', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            ip: firewall.ip,
                            username: firewall.username,
                            password: firewall.password
                        })
                    });

                    const result = await response.json();
                    
                    const cseConfig = result.cse_config || {};
                    const connectors = cseConfig.connectors || [];
                    const enabledCount = connectors.filter(c => c.enable === true).length;
                    
                    // Rcuprer le statut de remediation
                    const statusResponse = await fetch(`/api/remediation/status/${firewall.id}/cse`);
                    const status = await statusResponse.json();
                    
                    // Rcuprer le statut de ractivation
                    const reactivationResponse = await fetch(`/api/remediation/can-reactivate/${firewall.id}/cse`);
                    const reactivationData = await reactivationResponse.json();
                    
                    cseData.push({
                        firewall: firewall,
                        config: cseConfig,
                        enabledConnectors: enabledCount,
                        remediationStatus: status,
                        canReactivate: reactivationData.can_reactivate,
                        lastChecked: new Date().toISOString()
                    });
                } catch (error) {
                    cseData.push({
                        firewall: firewall,
                        config: {},
                        enabledConnectors: 0,
                        error: error.message,
                        lastChecked: new Date().toISOString()
                    });
                }
            }

            renderCSE(cseData);
            showAlert('success', 'CSE check completed', 'cse-alert-container');
        }

        function renderCSE(data) {
            const grid = document.getElementById('cse-grid');
            
            if (data.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon"></div>
                        <h3>No CSE Data</h3>
                        <p>Loading Cloud Secure Edge configuration automatically...</p>
                    </div>
                `;
                return;
            }

            grid.innerHTML = data.map((item, index) => {
                const fwName = item.firewall.name || item.firewall.ip;
                const config = item.config;
                const connectors = config.connectors || [];
                const baseConfig = config.base?.cloud_secure_edge || {};
                const hasRisk = item.enabledConnectors > 0;
                const isCreated = baseConfig.created || false;
                
                // Dterminer le statut de remediation
                const isResolved = (item.remediationStatus && item.remediationStatus.status && item.remediationStatus.status.is_resolved) || false;
                const canReactivate = item.canReactivate || false;
                
                console.log(`[CSE Monitoring] ${fwName} - isResolved: ${isResolved}, canReactivate: ${canReactivate}`, item.remediationStatus);
                
                // Dterminer les couleurs selon le statut (comme SSO)
                let bgColor, borderColor, textColor, hoverColor, badgeText, badgeClass;
                
                if (isResolved) {
                    // VERT : Rsolu
                    bgColor = '#dcfce7';
                    borderColor = '#22c55e';
                    textColor = '#166534';
                    hoverColor = '#bbf7d0';
                    badgeText = ' RSOLU - CSE ractiv';
                    badgeClass = 'badge-success';
                } else if (canReactivate) {
                    // ORANGE : En attente de ractivation
                    bgColor = '#fef3c7';
                    borderColor = '#f59e0b';
                    textColor = '#92400e';
                    hoverColor = '#fde68a';
                    badgeText = ' PRT - Timer expir';
                    badgeClass = 'badge-warning';
                } else if (hasRisk) {
                    // ROUGE : Connectors activs (risque)
                    bgColor = '#fee2e2';
                    borderColor = '#ef4444';
                    textColor = '#991b1b';
                    hoverColor = '#fecaca';
                    badgeText = ` ${item.enabledConnectors} CSE connector${item.enabledConnectors !== 1 ? 's' : ''} enabled`;
                    badgeClass = 'badge-danger';
                } else if (isCreated) {
                    // ORANGE : CSE cr mais pas de connectors
                    bgColor = '#fef3c7';
                    borderColor = '#f59e0b';
                    textColor = '#92400e';
                    hoverColor = '#fde68a';
                    badgeText = 'CSE created but no connectors';
                    badgeClass = 'badge-warning';
                } else {
                    // GRIS : Non configur
                    bgColor = 'var(--gray-50)';
                    borderColor = '';
                    textColor = 'var(--gray-900)';
                    hoverColor = 'var(--gray-100)';
                    badgeText = 'Not configured';
                    badgeClass = 'badge-secondary';
                }
                
                return `
                    <div class="firewall-user-accordion">
                        <div class="firewall-user-header" onclick="toggleUserAccordion('cse-${item.firewall.id}')" 
                             style="background: ${bgColor}; ${borderColor ? `border: 2px solid ${borderColor};` : ''}" 
                             onmouseover="this.style.background='${hoverColor}'" 
                             onmouseout="this.style.background='${bgColor}'">
                            <div class="fw-name">
                                <span></span>
                                <span style="color: ${textColor};">${fwName} (${item.firewall.ip})</span>
                            </div>
                            <span class="${badgeClass}">${badgeText}</span>
                            <span class="arrow"></span>
                        </div>
                        <div id="cse-${item.firewall.id}" class="firewall-user-content ${''}">
                            ${item.error ? `
                                <div class="alert alert-danger"><strong>Error:</strong> ${item.error}</div>
                            ` : !isCreated ? `
                                <div class="empty-state"><p>Cloud Secure Edge not configured on this firewall</p></div>
                            ` : `
                                <div style="margin-bottom: 1rem;">
                                    <h4 style="font-size: 0.95rem; margin-bottom: 0.5rem;"> Base Settings</h4>
                                    <p style="font-size: 0.9rem; color: var(--gray-600);">
                                        CSE Created: ${baseConfig.created ? '' : ''} | 
                                        Extended Networking: ${baseConfig.extended_networking ? '' : ''}
                                    </p>
                                </div>
                                
                                ${connectors.length > 0 ? `
                                    <div>
                                        <h4 style="font-size: 0.95rem; margin-bottom: 0.5rem;"> Connectors (${connectors.length})</h4>
                                        <table class="users-table">
                                            <thead>
                                                <tr>
                                                    <th>Connector Name</th>
                                                    <th>Status</th>
                                                    <th>Allowed IPs</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${connectors.map(conn => `
                                                    <tr style="background: ${conn.enable ? '#fef2f2' : 'white'};">
                                                        <td><strong>${conn.name}</strong></td>
                                                        <td>${conn.enable ? '<span class="badge badge-danger"> Enabled</span>' : '<span class="badge badge-secondary"> Disabled</span>'}</td>
                                                        <td>${conn.allowed_ips?.address_group || 'Any'}</td>
                                                    </tr>
                                                `).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                ` : `
                                    <div class="empty-state"><p>No connectors configured</p></div>
                                `}
                            `}
                        </div>
                    </div>
                `;
            }).join('');
            
            // Rappliquer le filtre de recherche aprs le rendu
            setTimeout(() => reapplyGlobalSearch(), 100);
        }

        function refreshCSE() {
            checkCSE();
        }

        function switchCSESubmenu(submenu) {
            const section = document.getElementById('cse-section');
            section.querySelectorAll('.module-submenu .submenu-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            section.querySelector(`[data-submenu="${submenu}"]`).classList.add('active');
            
            section.querySelectorAll('.submenu-content').forEach(content => {
                content.classList.remove('active');
            });
            
            if (submenu === 'monitoring') {
                document.getElementById('cse-monitoring').classList.add('active');
            } else if (submenu === 'remediation') {
                document.getElementById('cse-remediation').classList.add('active');
                loadCSERemediation();
            }
        }

        // CSE Remediation Functions
        async function loadCSERemediation() {
            if (firewalls.length === 0) {
                showAlert('warning', 'No firewalls available. Add firewalls first.', 'cse-alert-container');
                return;
            }

            const remediationGrid = document.getElementById('cse-remediation-grid');
            remediationGrid.innerHTML = '';

            for (const firewall of firewalls) {
                try {
                    // Get remediation status
                    const statusResponse = await fetch(`/api/remediation/status/${firewall.id}/cse`);
                    const status = await statusResponse.json();
                    console.log(`[CSE Remediation] Status response for ${firewall.name}:`, status);
                    
                    // Get timer status
                    const timerResponse = await fetch(`/api/remediation/timer/${firewall.id}/cse`);
                    const timerData = await timerResponse.json();
                    console.log(`[CSE Remediation] Timer response for ${firewall.name}:`, timerData);
                    
                    // Get reactivation status
                    const reactivationResponse = await fetch(`/api/remediation/can-reactivate/${firewall.id}/cse`);
                    const reactivationData = await reactivationResponse.json();
                    console.log(`[CSE Remediation] Reactivation response for ${firewall.name}:`, reactivationData);
                    
                    // Get current CSE configuration
                    const cseResponse = await fetch('/api/cse-config', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            ip: firewall.ip,
                            username: firewall.username,
                            password: firewall.password
                        })
                    });
                    const cseData = await cseResponse.json();
                    
                    const config = cseData.cse_config || {};
                    const isResolved = status.status?.is_resolved || false;
                    const activeTimer = timerData.timer;
                    const timerExpired = timerData.expired;
                    const canReactivate = reactivationData.can_reactivate;
                    
                    // Debug logs
                    console.log(`CSE Debug for ${firewall.name}:`, {
                        isResolved,
                        activeTimer,
                        timerExpired,
                        canReactivate,
                        reactivationData,
                        verificationMethod: status.status?.verification_method,
                        fullStatus: status
                    });
                    
                    // Determine colors based on status (Rouge  Orange  Vert)
                    let bgColor, borderColor, textColor, hoverColor, badgeText, badgeClass;
                    
                    // VERT : CSE remediation termine
                    if (isResolved) {
                        bgColor = '#dcfce7';
                        borderColor = '#22c55e';
                        textColor = '#166534';
                        hoverColor = '#bbf7d0';
                        badgeText = ' RSOLU - CSE ractiv';
                        badgeClass = 'badge-success';
                    }
                    // ORANGE : Timer expir ou statut en attente de ractivation
                    else if (timerExpired || 
                            (activeTimer && activeTimer.remaining_seconds <= 0) || 
                            canReactivate) {
                        bgColor = '#fef3c7';
                        borderColor = '#f59e0b';
                        textColor = '#92400e';
                        hoverColor = '#fde68a';
                        badgeText = ' PRT - Timer expir';
                        badgeClass = 'badge-warning';
                        console.log('CSE: Timer expir dtect, affichage bouton ractivation');
                    }
                    // ORANGE : Timer actif (remediation en cours)
                    else if (activeTimer && activeTimer.remaining_seconds > 0) {
                        bgColor = '#fef3c7';
                        borderColor = '#f59e0b';
                        textColor = '#92400e';
                        hoverColor = '#fde68a';
                        badgeText = ' TIMER ACTIF - Attente 30s';
                        badgeClass = 'badge-warning';
                    }
                    // ROUGE : Aucune action effectue
                    else {
                        bgColor = '#fee2e2';
                        borderColor = '#ef4444';
                        textColor = '#991b1b';
                        hoverColor = '#fecaca';
                        badgeText = ' ACTION REQUISE - Dissociation manuelle';
                        badgeClass = 'badge-danger';
                    }

                    const remediationCard = document.createElement('div');
                    remediationCard.className = 'firewall-card';
                    remediationCard.style.cssText = `
                        background: ${bgColor};
                        border: 2px solid ${borderColor};
                        color: ${textColor};
                        transition: all 0.3s ease;
                        margin-bottom: 1rem;
                        padding: 1.5rem;
                        border-radius: 12px;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                    `;
                    
                    remediationCard.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                            <div>
                                <h3 style="margin: 0 0 0.5rem 0; font-size: 1.1rem; font-weight: 600;">
                                    ${firewall.name} (${firewall.ip})
                                </h3>
                                <div style="font-size: 0.9rem; opacity: 0.8;">
                                    CSE Status: ${config.cloud_secure_edge?.created ? 'Enabled' : 'Disabled'}
                                    ${config.cloud_secure_edge?.extended_networking ? ' | Extended Networking: Yes' : ''}
                                </div>
                            </div>
                            <span class="${badgeClass}">${badgeText}</span>
                        </div>
                        
                        ${isResolved ? `
                            <div style="margin-bottom: 1rem; padding: 1rem; background: #ecfdf5; border: 1px solid #22c55e; border-radius: 8px;">
                                <div style="font-weight: 600; color: #166534; margin-bottom: 0.5rem;">
                                     CSE Remediation termine
                                </div>
                                <div style="font-size: 0.9rem; color: #15803d;">
                                    Le CSE a t ractiv avec succs aprs la remediation.
                                </div>
                            </div>
                        ` : (timerExpired || (activeTimer && activeTimer.remaining_seconds <= 0) || canReactivate) ? `
                            <div style="margin-bottom: 1rem; padding: 1rem; background: #f0f9ff; border: 1px solid #0ea5e9; border-radius: 8px;">
                                <div style="font-weight: 600; color: #0c4a6e; margin-bottom: 0.5rem;">
                                     Timer expir - Prt pour ractivation
                                </div>
                                <div style="font-size: 0.9rem; color: #0369a1; margin-bottom: 1rem;">
                                    Le dlai de 30 secondes est coul. Vous pouvez maintenant ractiver CSE.
                                </div>
                                <div style="margin-top: 1rem;">
                                    <button 
                                        class="btn btn-success" 
                                        onclick="reactivateCSE(${firewall.id})"
                                        style="
                                            background: #22c55e;
                                            color: white;
                                            border: none;
                                            padding: 0.75rem 1.5rem;
                                            border-radius: 6px;
                                            cursor: pointer;
                                            font-size: 1rem;
                                            font-weight: 600;
                                        "
                                    >
                                         Ractiver CSE maintenant
                                    </button>
                                </div>
                            </div>
                        ` : activeTimer && activeTimer.remaining_seconds > 0 ? `
                            <div style="margin-bottom: 1rem; padding: 1rem; background: #f0f9ff; border: 1px solid #0ea5e9; border-radius: 8px;">
                                <div style="font-weight: 600; color: #0c4a6e; margin-bottom: 0.5rem;">
                                     Timer de remediation actif
                                </div>
                                <div style="font-size: 0.9rem; color: #0369a1; margin-bottom: 1rem;">
                                    Vous avez dmarr la remediation. Attendez 30 secondes avant de pouvoir ractiver CSE.
                                </div>
                                <div id="cse-timer-${firewall.id}">
                                    <div style="padding: 0.75rem; background: #e0f2fe; border: 1px solid #0ea5e9; border-radius: 6px;">
                                        <div style="font-weight: 600; color: #0c4a6e; margin-bottom: 0.5rem;">
                                             Temps restant avant ractivation :
                                        </div>
                                        <div id="cse-countdown-${firewall.id}" style="font-size: 1.1rem; font-weight: 700; color: #0c4a6e;">
                                            ${Math.floor(activeTimer.remaining_seconds / 60).toString().padStart(2, '0')}:${(activeTimer.remaining_seconds % 60).toString().padStart(2, '0')}
                                        </div>
                                        <div style="font-size: 0.85rem; color: #0369a1; margin-top: 0.5rem;">
                                            Une fois le dlai coul, vous pourrez ractiver CSE automatiquement.
                                        </div>
                                    </div>
                                </div>
                            </div>
                        ` : `
                            <div style="margin-bottom: 1rem; padding: 1rem; background: #fef2f2; border: 1px solid #ef4444; border-radius: 8px;">
                                <div style="font-weight: 600; color: #991b1b; margin-bottom: 0.5rem;">
                                     Action manuelle requise
                                </div>
                                <div style="font-size: 0.9rem; color: #7f1d1d; margin-bottom: 1rem;">
                                    Vous devez d'abord dissocier le Firewall Connector dans MySonicWall avant de pouvoir dmarrer la remediation CSE.
                                </div>
                                <div style="margin-bottom: 1rem;">
                                    <button 
                                        class="btn btn-primary" 
                                        onclick="startCSERemediation(${firewall.id})"
                                        style="
                                            background: #3b82f6;
                                            color: white;
                                            border: none;
                                            padding: 0.5rem 1rem;
                                            border-radius: 6px;
                                            cursor: pointer;
                                            font-size: 0.9rem;
                                            font-weight: 500;
                                        "
                                    >
                                         Dmarrer la remediation CSE
                                    </button>
                                </div>
                                <div style="font-size: 0.85rem; color: #7f1d1d; padding: 0.75rem; background: #fef2f2; border-radius: 6px; border: 1px solid #fecaca;">
                                    <strong> Important :</strong> Assurez-vous d'avoir effectu la dissociation manuelle dans MySonicWall avant de cliquer sur ce bouton.
                                </div>
                            </div>
                        `}
                    `;
                    
                    remediationGrid.appendChild(remediationCard);
                    
                    // Si il y a un timer actif, dmarrer le countdown
                    if (activeTimer && activeTimer.remaining_seconds > 0) {
                        startCSECountdown(firewall.id, activeTimer.remaining_seconds);
                    }
                } catch (error) {
                    console.error(`Error loading CSE remediation for ${firewall.name}:`, error);
                }
            }
            
            // Rappliquer le filtre de recherche aprs le chargement
            reapplyGlobalSearch();
        }

        // CSE Remediation Actions
        async function startCSERemediation(firewallId) {
            const firewall = firewalls.find(f => f.id === firewallId);
            if (!firewall) return;

            try {
                showAlert('info', `Starting CSE remediation for ${firewall.name}...`, 'cse-alert-container');
                
                // Mark remediation as started
                const response = await fetch(`/api/remediation/start/${firewallId}/cse`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        ip: firewall.ip,
                        username: firewall.username,
                        password: firewall.password
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    showAlert('success', `CSE remediation started for ${firewall.name}. Manual action required in MySonicWall.`, 'cse-alert-container');
                    
                    // Reload the remediation view to show the timer
                    loadCSERemediation();
                    
                    // Start the countdown for this specific firewall
                    startCSECountdown(firewallId, result.timer.remaining_seconds);
                } else {
                    showAlert('error', `Failed to start CSE remediation for ${firewall.name}`, 'cse-alert-container');
                }
            } catch (error) {
                console.error('Error starting CSE remediation:', error);
                showAlert('error', `Error starting CSE remediation: ${error.message}`, 'cse-alert-container');
            }
        }

        // Start countdown for a specific firewall
        function startCSECountdown(firewallId, remainingSeconds) {
            const countdownDiv = document.getElementById(`cse-countdown-${firewallId}`);
            if (!countdownDiv) return;

            let remainingTime = remainingSeconds;
            
            const countdownInterval = setInterval(() => {
                const minutes = Math.floor(remainingTime / 60);
                const seconds = remainingTime % 60;
                countdownDiv.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                if (remainingTime <= 0) {
                    clearInterval(countdownInterval);
                    countdownDiv.textContent = '00:00';
                    
                    // Reload the remediation view to show the reactivation button
                    setTimeout(() => {
                        loadCSERemediation();
                    }, 100); // Petit dlai pour s'assurer que le backend a mis  jour le statut
                }
                
                remainingTime--;
            }, 1000);
        }

        async function reactivateCSE(firewallId) {
            const firewall = firewalls.find(f => f.id === firewallId);
            if (!firewall) return;

            try {
                showAlert('info', `Reactivating CSE for ${firewall.name}...`, 'cse-alert-container');
                
                // Step 1: Dsactiver CSE d'abord
                showAlert('info', `Step 1: Disabling CSE for ${firewall.name}...`, 'cse-alert-container');
                
                const disableResponse = await fetch('/api/cse-config', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        ip: firewall.ip,
                        username: firewall.username,
                        password: firewall.password,
                        cloud_secure_edge: {
                            created: false,
                            extended_networking: false
                        }
                    })
                });

                if (!disableResponse.ok) {
                    showAlert('error', `Failed to disable CSE for ${firewall.name}`, 'cse-alert-container');
                    return;
                }

                // Attendre un peu pour s'assurer que la dsactivation est prise en compte
                await new Promise(resolve => setTimeout(resolve, 2000));

                // Step 2: Ractiver CSE
                showAlert('info', `Step 2: Enabling CSE for ${firewall.name}...`, 'cse-alert-container');
                
                const enableResponse = await fetch('/api/cse-config', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        ip: firewall.ip,
                        username: firewall.username,
                        password: firewall.password,
                        cloud_secure_edge: {
                            created: true,
                            extended_networking: true
                        }
                    })
                });

                if (enableResponse.ok) {
                    // Mark as resolved
                    const resolveResponse = await fetch(`/api/remediation/resolve/${firewallId}/cse`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    
                    console.log('Resolve response:', await resolveResponse.json());
                    
                    showAlert('success', `CSE successfully reactivated for ${firewall.name} (disabled then enabled)`, 'cse-alert-container');
                    
                    // Attendre un peu pour s'assurer que la DB est mise  jour
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                    // Reload remediation view AND monitoring view
                    loadCSERemediation();
                    checkCSE();
                } else {
                    showAlert('error', `Failed to reactivate CSE for ${firewall.name}`, 'cse-alert-container');
                }
            } catch (error) {
                console.error('Error reactivating CSE:', error);
                showAlert('error', `Error reactivating CSE: ${error.message}`, 'cse-alert-container');
            }
        }

        async function resetCSERemediation(firewallId) {
            try {
                const response = await fetch(`/api/remediation/reset/${firewallId}/cse`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (response.ok) {
                    showAlert('success', 'CSE remediation status reset', 'cse-alert-container');
                    loadCSERemediation();
                } else {
                    showAlert('error', 'Failed to reset CSE remediation status', 'cse-alert-container');
                }
            } catch (error) {
                console.error('Error resetting CSE remediation:', error);
                showAlert('error', `Error resetting CSE remediation: ${error.message}`, 'cse-alert-container');
            }
        }

        // PPPoE/PPTP/L2TP Functions
        async function checkPPPoEPPTPL2TP() {
            if (firewalls.length === 0) {
                showAlert('warning', 'No firewalls available. Add firewalls first.', 'pppoe-pptp-l2tp-alert-container');
                return;
            }

            showAlert('warning', 'Checking PPPoE/PPTP/L2TP configuration...', 'pppoe-pptp-l2tp-alert-container');
            
            const protocolData = [];
            
            for (const firewall of firewalls) {
                try {
                    const response = await fetch('/api/pppoe-pptp-l2tp', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            ip: firewall.ip,
                            username: firewall.username,
                            password: firewall.password,
                            firewall_id: firewall.id
                        })
                    });

                    const result = await response.json();
                    
                    protocolData.push({
                        firewall: firewall,
                        ppp_config: result.ppp_config || {},
                        is_secure: result.is_secure || false,
                        security_status: result.security_status || 'at_risk',
                        security_message: result.security_message || '',
                        remediation_status: result.remediation_status || null,
                        lastChecked: new Date().toISOString()
                    });
                } catch (error) {
                    protocolData.push({
                        firewall: firewall,
                        error: error.message,
                        lastChecked: new Date().toISOString()
                    });
                }
            }

            renderPPPoEPPTPL2TP(protocolData);
            showAlert('success', 'PPPoE/PPTP/L2TP check completed', 'pppoe-pptp-l2tp-alert-container');
        }

        function renderPPPoEPPTPL2TP(data) {
            const grid = document.getElementById('pppoe-pptp-l2tp-grid');
            
            if (data.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon"></div>
                        <h3>No PPPoE/PPTP/L2TP Data</h3>
                        <p>Loading WAN interface protocols automatically...</p>
                    </div>
                `;
                return;
            }

            grid.innerHTML = data.map(item => {
                const fwName = item.firewall.name || item.firewall.ip;
                const securityStatus = item.security_status || 'at_risk';
                const isSecure = item.is_secure || false;
                const pppConfig = item.ppp_config || {};
                const interfaces = pppConfig.interfaces || [];
                
                // Dterminer les couleurs selon le status
                let bgColor, borderColor, textColor, hoverColor;
                if (securityStatus === 'secure') {
                    bgColor = '#dcfce7';
                    borderColor = '#22c55e';
                    textColor = '#166534';
                    hoverColor = '#bbf7d0';
                } else if (securityStatus === 'partial') {
                    bgColor = '#fef3c7';
                    borderColor = '#f59e0b';
                    textColor = '#92400e';
                    hoverColor = '#fde68a';
                } else {
                    bgColor = '#fee2e2';
                    borderColor = '#ef4444';
                    textColor = '#991b1b';
                    hoverColor = '#fecaca';
                }
                
                return `
                    <div class="firewall-user-accordion" style="background: ${bgColor} !important; border: 2px solid ${borderColor} !important;">
                        <div class="firewall-user-header" onclick="toggleUserAccordion('pppoe-${item.firewall.id}')" style="background: ${bgColor} !important;" onmouseover="this.parentElement.style.background='${hoverColor} !important'" onmouseout="this.parentElement.style.background='${bgColor} !important'">
                            <div class="fw-name">
                                <span></span>
                                <span style="color: ${textColor};">${fwName} (${item.firewall.ip})</span>
                            </div>
                            <div style="flex: 1; display: flex; align-items: center; gap: 0.5rem; justify-content: flex-end;">
                                <span class="badge ${securityStatus === 'secure' ? 'badge-success' : securityStatus === 'partial' ? 'badge-warning' : 'badge-danger'}">
                                    ${item.security_message}
                                </span>
                            </div>
                            <span class="arrow"></span>
                        </div>
                        <div id="pppoe-${item.firewall.id}" class="firewall-user-content" style="background: ${bgColor} !important;">
                            ${item.error ? `
                                <div class="alert alert-danger">
                                    <strong>Error:</strong> ${item.error}
                                </div>
                            ` : `
                                <div class="firewall-info" style="margin-bottom: 1rem; background: transparent !important;">
                                    <div class="firewall-info-item">
                                        <span class="firewall-info-label">Interfaces WAN:</span>
                                        <span class="firewall-info-value">${pppConfig.total_interfaces || 0}</span>
                                    </div>
                                    <div class="firewall-info-item">
                                        <span class="firewall-info-label">Interfaces  risque:</span>
                                        <span class="firewall-info-value">${pppConfig.risk_interfaces || 0}</span>
                                    </div>
                                    <div class="firewall-info-item">
                                        <span class="firewall-info-label">Status de scurit:</span>
                                        <span class="firewall-info-value" style="color: ${securityStatus === 'secure' ? '#22c55e' : securityStatus === 'partial' ? '#f59e0b' : '#ef4444'};">
                                            ${item.security_message}
                                        </span>
                                    </div>
                                    <div class="firewall-info-item">
                                        <span class="firewall-info-label">Last Checked:</span>
                                        <span class="firewall-info-value">${formatDate(item.lastChecked)}</span>
                                    </div>
                                </div>
                                
                                ${interfaces.length > 0 ? `
                                    <div class="firewall-info" style="margin-bottom: 1rem; background: transparent !important;">
                                        <h4 style="margin: 0 0 1rem 0; color: var(--gray-900); font-size: 1rem; font-weight: 600;">Interfaces dtectes:</h4>
                                        <div style="background: white; border-radius: 8px; padding: 1rem;">
                                            ${interfaces.map(iface => `
                                                <div style="margin-bottom: 0.75rem; padding: 0.75rem; background: ${iface.is_risk ? '#fee2e2' : '#dcfce7'}; border-left: 4px solid ${iface.is_risk ? '#ef4444' : '#22c55e'}; border-radius: 4px;">
                                                    <strong>${iface.is_risk ? '' : ''} ${iface.name}</strong> (${iface.zone})<br>
                                                    <small style="color: var(--gray-600);">Protocole: ${iface.mode.toUpperCase()}</small>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                ` : ''}
                                
                                <div class="firewall-actions" style="margin-top: 1rem; background: transparent !important;">
                                    <button class="btn btn-secondary" onclick="checkPPPoEPPTPL2TP()">
                                        <span></span> Refresh
                                    </button>
                                </div>
                            `}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function refreshPPPoEPPTPL2TP() {
            checkPPPoEPPTPL2TP();
        }

        function switchPPPoESubmenu(submenu) {
            // Mettre  jour les boutons actifs
            document.querySelectorAll('#pppoe-pptp-l2tp-section .submenu-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            if (submenu === 'monitoring') {
                checkPPPoEPPTPL2TP();
            } else if (submenu === 'remediation') {
                loadPPPoERemediation();
            }
        }

        async function loadPPPoERemediation() {
            if (firewalls.length === 0) {
                document.getElementById('pppoe-pptp-l2tp-grid').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon"></div>
                        <h3>No PPPoE/PPTP/L2TP Remediation Data</h3>
                        <p>No firewalls available for remediation</p>
                    </div>
                `;
                return;
            }

            showAlert('warning', 'Loading PPPoE/PPTP/L2TP remediation data...', 'pppoe-pptp-l2tp-alert-container');
            
            const remediationData = [];
            
            for (const firewall of firewalls) {
                try {
                    const response = await fetch('/api/pppoe-pptp-l2tp', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            ip: firewall.ip,
                            username: firewall.username,
                            password: firewall.password,
                            firewall_id: firewall.id
                        })
                    });

                    const result = await response.json();
                    
                    // Parser les interfaces dj modifies depuis les notes
                    let modifiedInterfaces = [];
                    if (result.remediation_status && result.remediation_status.notes) {
                        const match = result.remediation_status.notes.match(/Interfaces modifies: \[(.*?)\]/);
                        if (match && match[1]) {
                            modifiedInterfaces = match[1].split(',').map(name => name.trim());
                        }
                    }
                    
                    // Filtrer les interfaces pour ne garder que celles non modifies
                    const allInterfaces = result.ppp_config?.interfaces || [];
                    const interfacesToModify = allInterfaces.filter(iface => !modifiedInterfaces.includes(iface.name));
                    
                    remediationData.push({
                        firewall: firewall,
                        ppp_config: {
                            ...result.ppp_config,
                            interfaces: interfacesToModify,
                            all_interfaces: allInterfaces
                        },
                        is_secure: result.is_secure || false,
                        security_status: result.security_status || 'at_risk',
                        security_message: result.security_message || '',
                        remediation_status: result.remediation_status || null,
                        modified_interfaces: modifiedInterfaces
                    });
                } catch (error) {
                    remediationData.push({
                        firewall: firewall,
                        error: error.message
                    });
                }
            }

            renderPPPoERemediation(remediationData);
        }

        function renderPPPoERemediation(data) {
            const grid = document.getElementById('pppoe-pptp-l2tp-grid');
            
            if (data.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon"></div>
                        <h3>No PPPoE/PPTP/L2TP Remediation Data</h3>
                        <p>No firewalls available for remediation</p>
                    </div>
                `;
                return;
            }

            grid.innerHTML = data.map(item => {
                const fwName = item.firewall.name || item.firewall.ip;
                const securityStatus = item.security_status || 'at_risk';
                const isSecure = item.is_secure || false;
                const pppConfig = item.ppp_config || {};
                const interfaces = pppConfig.interfaces || [];
                
                // Dterminer les couleurs
                let bgColor, borderColor, textColor, hoverColor;
                if (securityStatus === 'secure') {
                    bgColor = '#dcfce7';
                    borderColor = '#22c55e';
                    textColor = '#166534';
                    hoverColor = '#bbf7d0';
                } else if (securityStatus === 'partial') {
                    bgColor = '#fef3c7';
                    borderColor = '#f59e0b';
                    textColor = '#92400e';
                    hoverColor = '#fde68a';
                } else {
                    bgColor = '#fee2e2';
                    borderColor = '#ef4444';
                    textColor = '#991b1b';
                    hoverColor = '#fecaca';
                }
                
                return `
                    <div class="firewall-user-accordion" style="background: ${bgColor} !important; border: 2px solid ${borderColor} !important;">
                        <div class="firewall-user-header" onclick="toggleUserAccordion('pppoe-remediation-${item.firewall.id}')" style="background: ${bgColor} !important;" onmouseover="this.parentElement.style.background='${hoverColor} !important'" onmouseout="this.parentElement.style.background='${bgColor} !important'">
                            <div class="fw-name">
                                <span></span>
                                <span style="color: ${textColor};">${fwName} (${item.firewall.ip})</span>
                            </div>
                            <div style="flex: 1; display: flex; align-items: center; gap: 0.5rem; justify-content: flex-end;">
                                <span class="badge ${securityStatus === 'secure' ? 'badge-success' : securityStatus === 'partial' ? 'badge-warning' : 'badge-danger'}">
                                    ${item.security_message}
                                </span>
                            </div>
                            <span class="arrow"></span>
                        </div>
                        <div id="pppoe-remediation-${item.firewall.id}" class="firewall-user-content" style="background: ${bgColor} !important;">
                            ${item.error ? `
                                <div class="alert alert-danger">
                                    <strong>Error:</strong> ${item.error}
                                </div>
                            ` : isSecure ? `
                                <div style="margin-bottom: 1rem; padding: 1rem; background: #dcfce7; border: 1px solid #22c55e; border-radius: 8px;">
                                    <strong> SCURIS</strong><br>
                                    ${item.remediation_status?.is_resolved ? 'Toutes les interfaces PPPoE/PPTP/L2TP sont scurises' : 'Aucune interface PPPoE/PPTP/L2TP dtecte'}
                                </div>
                            ` : `
                                <div style="margin-bottom: 1rem;">
                                    ${item.modified_interfaces && item.modified_interfaces.length > 0 ? `
                                        <div style="background: #dcfce7; border: 2px solid #22c55e; border-radius: 8px; padding: 0.75rem; margin-bottom: 1rem;">
                                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                                <span style="font-size: 1.2rem;"></span>
                                                <div>
                                                    <strong>Interfaces dj scurises:</strong><br>
                                                    ${item.modified_interfaces.join(', ')}
                                                </div>
                                            </div>
                                        </div>
                                    ` : ''}
                                    
                                    <div style="background: #fee2e2; border: 2px solid #ef4444; border-radius: 8px; padding: 0.75rem; margin-bottom: 1rem;">
                                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                                            <span style="font-size: 1.2rem;"></span>
                                            <div>
                                                <strong>RISQUE DE SCURIT!</strong><br>
                                                Interfaces WAN utilisant des protocoles PPPoE/PPTP/L2TP non scuriss
                                            </div>
                                        </div>
                                    </div>
                                    
                                    ${interfaces.length > 0 ? `
                                        <div style="margin-bottom: 1.5rem;">
                                            <h4 style="margin: 0 0 1rem 0; color: var(--gray-900); font-size: 1rem; font-weight: 600;">Interfaces  scuriser:</h4>
                                            
                                            <div style="background: white; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                                                ${interfaces.map(iface => `
                                                    <div style="margin-bottom: 1rem; padding: 1rem; border: 1px solid #e5e7eb; border-radius: 8px;">
                                                        <h5 style="margin: 0 0 0.5rem 0; color: var(--gray-900);">${iface.name} (${iface.zone})</h5>
                                                        <div style="margin-bottom: 0.75rem;">
                                                            <strong>Protocole:</strong> ${iface.mode.toUpperCase()}<br>
                                                            <strong>MTU:</strong> ${iface.mtu}
                                                        </div>
                                                        <div style="display: grid; grid-template-columns: ${iface.mode === 'l2tp' ? '1fr 1fr 1fr' : '1fr 1fr'}; gap: 0.5rem; margin-bottom: 0.75rem;">
                                                            <input type="text" placeholder="Nouveau username" class="pppoe-username-input" data-interface="${iface.name}" style="padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                                                            <input type="password" placeholder="Nouveau password" class="pppoe-password-input" data-interface="${iface.name}" style="padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                                                            ${iface.mode === 'l2tp' ? `<input type="password" placeholder="Nouveau shared secret" class="pppoe-shared-secret-input" data-interface="${iface.name}" style="padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">` : ''}
                                                        </div>
                                                        <button class="btn btn-primary pppoe-change-credentials-btn" data-firewall-id="${item.firewall.id}" data-interface="${iface.name}" style="width: 100%;">
                                                             Changer les credentials
                                                        </button>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>
                                    ` : ''}
                                </div>
                            `}
                        </div>
                    </div>
                `;
            }).join('');
            
            // Attacher les event listeners pour changer les credentials
            document.querySelectorAll('.pppoe-change-credentials-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const firewallId = button.dataset.firewallId;
                    const interfaceName = button.dataset.interface;
                    executePPPoECredentialsChange(firewallId, interfaceName);
                });
            });
        }

        async function executePPPoECredentialsChange(firewallId, interfaceName) {
            const usernameInput = document.querySelector(`.pppoe-username-input[data-interface="${interfaceName}"]`);
            const passwordInput = document.querySelector(`.pppoe-password-input[data-interface="${interfaceName}"]`);
            const sharedSecretInput = document.querySelector(`.pppoe-shared-secret-input[data-interface="${interfaceName}"]`);
            
            const newUsername = usernameInput.value.trim();
            const newPassword = passwordInput.value.trim();
            const newSharedSecret = sharedSecretInput ? sharedSecretInput.value.trim() : '';
            
            if (!newUsername || !newPassword) {
                showAlert('error', 'Veuillez remplir tous les champs obligatoires', 'pppoe-pptp-l2tp-alert-container');
                return;
            }
            
            // Pour L2TP, vrifier que le shared secret est fourni
            if (sharedSecretInput && !newSharedSecret) {
                showAlert('error', 'Le shared secret est obligatoire pour L2TP', 'pppoe-pptp-l2tp-alert-container');
                return;
            }
            
            if (newPassword.length < 8) {
                showAlert('error', 'Le mot de passe doit contenir au moins 8 caractres', 'pppoe-pptp-l2tp-alert-container');
                return;
            }
            
            showAlert('warning', `Changement des credentials pour ${interfaceName}...`, 'pppoe-pptp-l2tp-alert-container');
            
            try {
                const response = await fetch('/api/remediation/pppoe-pptp-l2tp/change-credentials', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        firewall_id: firewallId,
                        interfaces: [{
                            name: interfaceName,
                            new_username: newUsername,
                            new_password: newPassword,
                            new_shared_secret: newSharedSecret
                        }]
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    showAlert('success', result.message, 'pppoe-pptp-l2tp-alert-container');
                    
                    // Vider les champs et les dsactiver
                    usernameInput.value = '';
                    passwordInput.value = '';
                    if (sharedSecretInput) {
                        sharedSecretInput.value = '';
                        sharedSecretInput.disabled = true;
                    }
                    usernameInput.disabled = true;
                    passwordInput.disabled = true;
                    
                    // Recharger les donnes
                    loadPPPoERemediation();
                } else {
                    showAlert('error', result.message, 'pppoe-pptp-l2tp-alert-container');
                }
            } catch (error) {
                showAlert('error', `Erreur: ${error.message}`, 'pppoe-pptp-l2tp-alert-container');
            }
        }

        // SSL VPN Functions
        async function checkSSLVPN() {
            if (firewalls.length === 0) {
                showAlert('warning', 'No firewalls available. Add firewalls first.', 'ssl-alert-container');
                return;
            }

            showAlert('warning', 'Checking SSL VPN configuration...', 'ssl-alert-container');
            
            const sslData = [];
            
            for (const firewall of firewalls) {
                try {
                    const response = await fetch('/api/ssl-vpn', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            ip: firewall.ip,
                            username: firewall.username,
                            password: firewall.password,
                            firewall_id: firewall.id
                        })
                    });

                    const result = await response.json();
                    
                    sslData.push({
                        firewall: firewall,
                        wan_enabled: result.wan_enabled,
                        is_secure: result.is_secure,
                        security_status: result.security_status,
                        security_message: result.security_message,
                        conditions: result.conditions,
                        config: result.ssl_vpn_config,
                        lastChecked: new Date().toISOString()
                    });
                } catch (error) {
                    sslData.push({
                        firewall: firewall,
                        wan_enabled: false,
                        is_secure: false,
                        security_status: 'error',
                        security_message: error.message,
                        error: error.message,
                        lastChecked: new Date().toISOString()
                    });
                }
            }

            renderSSLVPN(sslData);
            showAlert('success', 'SSL VPN check completed', 'ssl-alert-container');
        }

        function renderSSLVPN(sslData) {
            const container = document.getElementById('ssl-vpn-grid');
            
            if (sslData.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon"></div>
                        <h3>No SSL VPN Data</h3>
                        <p>Loading SSL VPN configuration automatically...</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = sslData.map(item => {
                const fwName = item.firewall.name || item.firewall.ip;
                const securityStatus = item.security_status || 'at_risk';
                const isSecure = item.is_secure || false;
                const wanEnabled = item.wan_enabled || false;
                const authMethod = item.auth_method || 'local';
                const authMethodsConfigured = item.auth_methods_configured || [];
                const authStatuses = item.auth_statuses || {};
                
                // Dterminer les couleurs selon le status
                let bgColor, borderColor, textColor, hoverColor;
                if (securityStatus === 'secure') {
                    bgColor = '#dcfce7';
                    borderColor = '#22c55e';
                    textColor = '#166534';
                    hoverColor = '#bbf7d0';
                } else if (securityStatus === 'partial') {
                    bgColor = '#fef3c7';
                    borderColor = '#f59e0b';
                    textColor = '#92400e';
                    hoverColor = '#fde68a';
                } else {
                    bgColor = '#fee2e2';
                    borderColor = '#ef4444';
                    textColor = '#991b1b';
                    hoverColor = '#fecaca';
                }
                
                return `
                    <div class="firewall-user-accordion" style="background: ${bgColor} !important; border: 2px solid ${borderColor} !important;">
                        <div class="firewall-user-header" onclick="toggleUserAccordion('ssl-${item.firewall.id}')" style="background: ${bgColor} !important;" onmouseover="this.parentElement.style.background='${hoverColor} !important'" onmouseout="this.parentElement.style.background='${bgColor} !important'">
                            <div class="fw-name">
                                <span></span>
                                <span style="color: ${textColor};">${fwName} (${item.firewall.ip})</span>
                            </div>
                            <div style="flex: 1; display: flex; align-items: center; gap: 0.5rem; justify-content: flex-end;">
                                <span class="badge ${securityStatus === 'secure' ? 'badge-success' : securityStatus === 'partial' ? 'badge-warning' : 'badge-danger'}">
                                    ${item.security_message}
                                </span>
                            </div>
                            <span class="arrow"></span>
                        </div>
                        <div id="ssl-${item.firewall.id}" class="firewall-user-content" style="background: ${bgColor} !important;">
                            ${item.error ? `
                                <div class="alert alert-danger">
                                    <strong>Error:</strong> ${item.error}
                                </div>
                            ` : `
                                <div class="firewall-info" style="margin-bottom: 1rem; background: transparent !important;">
                                    <div class="firewall-info-item">
                                        <span class="firewall-info-label">SSL VPN sur WAN:</span>
                                        <span class="firewall-info-value">${wanEnabled ? ' Activ' : ' Dsactiv'}</span>
                                    </div>
                                    ${authMethodsConfigured.length > 0 ? `
                                        ${authMethodsConfigured.map(method => {
                                            const methodStatus = authStatuses[method];
                                            if (methodStatus) {
                                                const methodDisplay = method.replace('_', ' ').toUpperCase();
                                                return `
                                                    <div class="firewall-info-item">
                                                        <span class="firewall-info-label">${methodDisplay} rsolu:</span>
                                                        <span class="firewall-info-value">${methodStatus.resolved ? ' Oui' : ' Non'}</span>
                                                    </div>
                                                `;
                                            }
                                            return '';
                                        }).join('')}
                                    ` : `
                                        <div class="firewall-info-item">
                                            <span class="firewall-info-label">Aucune mthode configure:</span>
                                            <span class="firewall-info-value"> Non</span>
                                        </div>
                                    `}
                                    <div class="firewall-info-item">
                                        <span class="firewall-info-label">Status de scurit:</span>
                                        <span class="firewall-info-value" style="color: ${securityStatus === 'secure' ? '#22c55e' : securityStatus === 'partial' ? '#f59e0b' : '#ef4444'};">
                                            ${item.security_message}
                                        </span>
                                    </div>
                                    <div class="firewall-info-item">
                                        <span class="firewall-info-label">Last Checked:</span>
                                        <span class="firewall-info-value">${formatDate(item.lastChecked)}</span>
                                    </div>
                                </div>
                                
                                <div class="firewall-actions" style="margin-top: 1rem; background: transparent !important;">
                                    <button class="btn btn-secondary" onclick="checkSSLVPN()">
                                        <span></span> Refresh
                                    </button>
                                </div>
                            `}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function switchSSLVPNSubmenu(submenu) {
            const section = document.getElementById('ssl-vpn-section');
            section.querySelectorAll('.module-submenu .submenu-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            section.querySelector(`[data-submenu="${submenu}"]`).classList.add('active');
            
            section.querySelectorAll('.submenu-content').forEach(content => {
                content.classList.remove('active');
            });
            
            if (submenu === 'monitoring') {
                document.getElementById('ssl-monitoring').classList.add('active');
                checkSSLVPN();
            } else if (submenu === 'remediation') {
                document.getElementById('ssl-remediation').classList.add('active');
                loadSSLVPNRemediation();
            }
        }
        
        async function loadSSLVPNRemediation() {
            const grid = document.getElementById('ssl-remediation-grid');
            
            if (firewalls.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon"></div>
                        <h3>No Firewalls Available</h3>
                        <p>Add firewalls first to perform remediation</p>
                    </div>
                `;
                return;
            }

            // Show loading
            grid.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon"></div>
                    <h3>Loading Remediation Data...</h3>
                    <p>Checking SSL VPN security status...</p>
                </div>
            `;

            const remediationData = [];
            
            for (const firewall of firewalls) {
                try {
                    const response = await fetch('/api/ssl-vpn', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            ip: firewall.ip,
                            username: firewall.username,
                            password: firewall.password,
                            firewall_id: firewall.id
                        })
                    });

                    const result = await response.json();
                    
                    remediationData.push({
                        firewall: firewall,
                        wan_enabled: result.wan_enabled,
                        is_secure: result.is_secure,
                        security_status: result.security_status,
                        security_message: result.security_message,
                        auth_method: result.auth_method,
                        auth_methods_configured: result.auth_methods_configured,
                        auth_statuses: result.auth_statuses,
                        all_configured_resolved: result.all_configured_resolved
                    });
                } catch (error) {
                    remediationData.push({
                        firewall: firewall,
                        wan_enabled: false,
                        is_secure: false,
                        security_status: 'error',
                        security_message: error.message,
                        error: error.message
                    });
                }
            }

            renderSSLVPNRemediation(remediationData);
        }
        
        function renderSSLVPNRemediation(data) {
            const grid = document.getElementById('ssl-remediation-grid');
            
            if (data.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon"></div>
                        <h3>No SSL VPN Remediation Data</h3>
                        <p>No firewalls available for remediation</p>
                    </div>
                `;
                return;
            }

            grid.innerHTML = data.map(item => {
                const fwName = item.firewall.name || item.firewall.ip;
                const securityStatus = item.security_status || 'at_risk';
                const isSecure = item.is_secure || false;
                const wanEnabled = item.wan_enabled || false;
                const authMethod = item.auth_method || 'local';
                const authMethodsConfigured = item.auth_methods_configured || [];
                const authStatuses = item.auth_statuses || {};
                const allConfiguredResolved = item.all_configured_resolved || false;
                
                // Dterminer les couleurs
                let bgColor, borderColor, textColor, hoverColor;
                if (securityStatus === 'secure') {
                    bgColor = '#dcfce7';
                    borderColor = '#22c55e';
                    textColor = '#166534';
                    hoverColor = '#bbf7d0';
                } else if (securityStatus === 'partial') {
                    bgColor = '#fef3c7';
                    borderColor = '#f59e0b';
                    textColor = '#92400e';
                    hoverColor = '#fde68a';
                } else {
                    bgColor = '#fee2e2';
                    borderColor = '#ef4444';
                    textColor = '#991b1b';
                    hoverColor = '#fecaca';
                }
                
                return `
                    <div class="firewall-user-accordion" style="background: ${bgColor} !important; border: 2px solid ${borderColor} !important;">
                        <div class="firewall-user-header" onclick="toggleUserAccordion('ssl-remediation-${item.firewall.id}')" style="background: ${bgColor} !important;" onmouseover="this.parentElement.style.background='${hoverColor} !important'" onmouseout="this.parentElement.style.background='${bgColor} !important'">
                            <div class="fw-name">
                                <span></span>
                                <span style="color: ${textColor};">${fwName} (${item.firewall.ip})</span>
                            </div>
                            <div style="flex: 1; display: flex; align-items: center; gap: 0.5rem; justify-content: flex-end;">
                                <span class="badge ${securityStatus === 'secure' ? 'badge-success' : securityStatus === 'partial' ? 'badge-warning' : 'badge-danger'}">
                                    ${item.security_message}
                                </span>
                            </div>
                            <span class="arrow"></span>
                        </div>
                        <div id="ssl-remediation-${item.firewall.id}" class="firewall-user-content" style="background: ${bgColor} !important;">
                            ${item.error ? `
                                <div class="alert alert-danger">
                                    <strong>Error:</strong> ${item.error}
                                </div>
                            ` : isSecure ? `
                                <div style="margin-bottom: 1rem; padding: 1rem; background: #dcfce7; border: 1px solid #22c55e; border-radius: 8px;">
                                    <strong> SCURIS</strong><br>
                                    ${!wanEnabled ? 'SSL VPN dsactiv sur WAN' : 'SSL VPN actif mais toutes les conditions de scurit sont remplies'}
                                </div>
                            ` : `
                                <div style="margin-bottom: 1rem;">
                                    ${securityStatus === 'partial' ? `
                                        <div style="background: #fef3c7; border: 2px solid #f59e0b; border-radius: 8px; padding: 0.75rem; margin-bottom: 1rem;">
                                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                                <span style="font-size: 1.2rem;"></span>
                                                <div>
                                                    <strong>PARTIELLEMENT RSOLU</strong><br>
                                                    SSL VPN actif sur WAN mais toutes les conditions ne sont pas encore remplies
                                                </div>
                                            </div>
                                        </div>
                                    ` : `
                                        <div style="background: #fee2e2; border: 2px solid #ef4444; border-radius: 8px; padding: 0.75rem; margin-bottom: 1rem;">
                                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                                <span style="font-size: 1.2rem;"></span>
                                                <div>
                                                    <strong>RISQUE DE SCURIT!</strong><br>
                                                    SSL VPN actif sur WAN et les conditions de scurit ne sont pas remplies
                                                </div>
                                            </div>
                                        </div>
                                    `}
                                    
                                    <div style="margin-bottom: 1.5rem;">
                                        <h4 style="margin: 0 0 1rem 0; color: var(--gray-900); font-size: 1rem; font-weight: 600;"> tat des mthodes d'authentification:</h4>
                                        
                                        <div style="background: white; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                                            
                                            ${authMethodsConfigured.length > 0 ? authMethodsConfigured.map(method => {
                                                const methodStatus = authStatuses[method];
                                                const methodDisplay = method.replace('_', ' ').toUpperCase();
                                                const methodResolved = methodStatus ? methodStatus.resolved : false;
                                                
                                                let actionText = '';
                                                switch(method) {
                                                    case 'local_users':
                                                        actionText = methodResolved ? 'Mots de passe changs et TOTP retir' : 'Action requise: Aller dans LOCAL Users  Remediation';
                                                        break;
                                                    case 'ldap':
                                                        actionText = methodResolved ? 'Bind password chang' : 'Action requise: Aller dans LDAP  Remediation';
                                                        break;
                                                    case 'radius':
                                                        actionText = methodResolved ? 'Secrets RADIUS changs' : 'Action requise: Aller dans RADIUS  Remediation';
                                                        break;
                                                    case 'tacacs':
                                                        actionText = methodResolved ? 'Secrets TACACS+ changs' : 'Action requise: Aller dans TACACS+  Remediation';
                                                        break;
                                                    default:
                                                        actionText = methodResolved ? 'Module scuris' : 'Action requise dans le module correspondant';
                                                }
                                                
                                                return `
                                                    <div style="margin-bottom: 0.75rem; padding: 0.75rem; background: ${methodResolved ? '#dcfce7' : '#fee2e2'}; border-left: 4px solid ${methodResolved ? '#22c55e' : '#ef4444'}; border-radius: 4px;">
                                                        <strong>${methodResolved ? '' : ''} ${methodDisplay}</strong><br>
                                                        <small style="color: var(--gray-600);">${actionText}</small>
                                                    </div>
                                                `;
                                            }).join('') : `
                                                <div style="padding: 0.75rem; background: #fee2e2; border-left: 4px solid #ef4444; border-radius: 4px;">
                                                    <strong> Aucune mthode d'authentification configure</strong><br>
                                                    <small style="color: var(--gray-600);">SSL VPN actif sans authentification scurise</small>
                                                </div>
                                            `}
                                        </div>
                                    </div>
                                    
                                    ${wanEnabled && !isSecure ? `
                                        <div style="margin-bottom: 1rem; padding: 1rem; background: #fffbeb; border: 1px solid #fbbf24; border-radius: 8px;">
                                            <strong> Action optionnelle disponible</strong><br>
                                            <p style="margin: 0.5rem 0; font-size: 0.9rem; color: var(--gray-700);">
                                                Vous pouvez dsactiver temporairement SSL VPN sur WAN en attendant de rsoudre les autres modules. 
                                                <strong>Attention :</strong> Ceci peut impacter l'accs  distance.
                                            </p>
                                            <button 
                                                class="btn btn-warning ssl-disable-wan-btn"
                                                data-firewall-id="${item.firewall.id}"
                                                style="margin-top: 0.5rem;">
                                                 Dsactiver SSL VPN sur WAN (optionnel)
                                            </button>
                                        </div>
                                    ` : ''}
                                </div>
                            `}
                        </div>
                    </div>
                `;
            }).join('');
            
            // Attacher les event listeners pour dsactiver WAN
            document.querySelectorAll('.ssl-disable-wan-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const firewallId = button.dataset.firewallId;
                    confirmDisableSSLVPNWAN(firewallId);
                });
            });
        }
        
        async function confirmDisableSSLVPNWAN(firewallId) {
            const confirmMsg = ' tes-vous sr de vouloir dsactiver SSL VPN sur les zones WAN ?\n\n ATTENTION:\n Ceci va bloquer l\'accs SSL VPN depuis l\'extrieur\n Les utilisateurs ne pourront plus se connecter via SSL VPN depuis Internet\n Cette action est rversible mais ncessite une reconfiguration';
            
            if (!confirm(confirmMsg)) {
                return;
            }
            
            showAlert('warning', 'Dsactivation du SSL VPN sur WAN en cours...', 'ssl-alert-container');
            
            try {
                const response = await fetch('/api/remediation/ssl-vpn/disable-wan', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        firewall_id: firewallId
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert('success', result.message, 'ssl-alert-container');
                    
                    setTimeout(async () => {
                        await checkSSLVPN();
                        await loadSSLVPNRemediation();
                    }, 500);
                } else {
                    showAlert('error', result.message, 'ssl-alert-container');
                }
                
            } catch (error) {
                console.error('Error disabling SSL VPN on WAN:', error);
                showAlert('error', 'Erreur lors de la dsactivation', 'ssl-alert-container');
            }
        }


        // Edit Firewall Functions
        function editFirewall(firewallId) {
            const firewall = firewalls.find(fw => fw.id === firewallId);
            if (!firewall) return;

            // Populate modal with firewall data
            document.getElementById('edit-firewall-id').value = firewall.id;
            document.getElementById('edit-firewall-name').value = firewall.name || '';
            document.getElementById('edit-firewall-ip').value = firewall.ip;
            document.getElementById('edit-firewall-username').value = firewall.username;
            document.getElementById('edit-firewall-password').value = firewall.password;

            // Show modal
            document.getElementById('edit-modal').classList.add('active');
        }

        function closeEditModal() {
            document.getElementById('edit-modal').classList.remove('active');
        }

        async function saveFirewallEdit(event) {
            event.preventDefault();

            const firewallId = parseInt(document.getElementById('edit-firewall-id').value);
            const name = document.getElementById('edit-firewall-name').value.trim();
            const ip = document.getElementById('edit-firewall-ip').value.trim();
            const username = document.getElementById('edit-firewall-username').value.trim();
            const password = document.getElementById('edit-firewall-password').value;

            try {
                const response = await fetch(`/api/firewalls/${firewallId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: name,
                        ip: ip,
                        username: username,
                        password: password
                    })
                });

                const result = await response.json();

                if (result.success) {
                    // Close modal and refresh display
                    closeEditModal();
                    renderFirewalls();
                    
                    // Show success message
                    showAlert('success', 'Firewall updated successfully!', 'alert-container');
                } else {
                    showAlert('error', result.message || 'Failed to update firewall', 'alert-container');
                }
            } catch (error) {
                console.error('Error updating firewall:', error);
                showAlert('error', 'Connection error: ' + error.message, 'alert-container');
            }
        }

        // Close modal when clicking outside
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('edit-modal').addEventListener('click', (e) => {
                if (e.target.id === 'edit-modal') {
                    closeEditModal();
                }
            });
        });
    </script>

    <!-- Edit Firewall Modal -->
    <div id="edit-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"> Edit Firewall</h3>
                <button class="modal-close" onclick="closeEditModal()"></button>
            </div>
            <form id="edit-firewall-form" onsubmit="saveFirewallEdit(event)">
                <input type="hidden" id="edit-firewall-id">
                <div class="form-group">
                    <label class="form-label" for="edit-firewall-name">Firewall Name</label>
                    <input type="text" id="edit-firewall-name" class="form-input" placeholder="HQ-Firewall-01" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="edit-firewall-ip">IP Address</label>
                    <input type="text" id="edit-firewall-ip" class="form-input" placeholder="192.168.1.1:443" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="edit-firewall-username">Username</label>
                    <input type="text" id="edit-firewall-username" class="form-input" placeholder="admin" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="edit-firewall-password">Password</label>
                    <input type="password" id="edit-firewall-password" class="form-input" required>
                    <div class="form-help">Enter password to update (leave as-is to keep current)</div>
                </div>
                <div style="display: flex; gap: 0.5rem; margin-top: 1.5rem;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">
                        <span></span> Save Changes
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeEditModal()">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Global Search Functionality
        const globalSearchInput = document.getElementById('global-search-input');
        const globalSearchClear = document.getElementById('global-search-clear');

        // Fonction utilitaire pour rappliquer le filtre (appele aprs chaque chargement de donnes)
        window.reapplyGlobalSearch = function() {
            const searchTerm = globalSearchInput?.value?.toLowerCase().trim() || '';
            if (searchTerm) {
                filterAllFirewallCards(searchTerm);
            }
        }

        // Observer pour rappliquer automatiquement le filtre quand le contenu change
        window.contentObserver = new MutationObserver(() => {
            const searchTerm = globalSearchInput?.value?.toLowerCase().trim() || '';
            if (searchTerm) {
                // Utiliser un debounce pour viter trop d'appels
                clearTimeout(window.searchDebounce);
                window.searchDebounce = setTimeout(() => {
                    filterAllFirewallCards(searchTerm);
                }, 200);
            }
        });

        // Observer le contenu principal
        setTimeout(() => {
            const content = document.querySelector('.content');
            if (content) {
                window.contentObserver.observe(content, {
                    childList: true,
                    subtree: true
                });
            }
        }, 1000);

        globalSearchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase().trim();
            
            // Show/hide clear button
            if (searchTerm) {
                globalSearchClear.classList.add('visible');
            } else {
                globalSearchClear.classList.remove('visible');
            }
            
            // Show search suggestions
            showSearchSuggestions(searchTerm);
            
            // Filter all firewall cards across all sections
            filterAllFirewallCards(searchTerm);
        });

        globalSearchClear.addEventListener('click', function() {
            globalSearchInput.value = '';
            globalSearchClear.classList.remove('visible');
            hideSearchSuggestions();
            filterAllFirewallCards('');
        });

        // Hide dropdown when clicking outside
        document.addEventListener('click', function(e) {
            const searchWrapper = document.querySelector('.global-search-wrapper');
            if (searchWrapper && !searchWrapper.contains(e.target)) {
                hideSearchSuggestions();
            }
        });

        function showSearchSuggestions(searchTerm) {
            const dropdown = document.getElementById('search-results-dropdown');
            
            if (!searchTerm) {
                hideSearchSuggestions();
                return;
            }

            // Search through firewalls
            console.log('[Search Suggestions] Total firewalls:', window.firewalls ? window.firewalls.length : 0);
            const matchingFirewalls = window.firewalls ? window.firewalls.filter(fw => {
                const name = (fw.name || '').toLowerCase();
                const ip = (fw.ip || '').toLowerCase();
                const username = (fw.username || '').toLowerCase();
                return name.includes(searchTerm) || ip.includes(searchTerm) || username.includes(searchTerm);
            }) : [];
            console.log('[Search Suggestions] Matching firewalls:', matchingFirewalls.length);

            if (matchingFirewalls.length === 0) {
                dropdown.innerHTML = `
                    <div class="search-no-results">
                        <div class="search-no-results-icon"></div>
                        <div style="font-weight: 600; color: var(--gray-700);">No firewalls found</div>
                        <div style="font-size: 0.875rem; margin-top: 0.25rem;">Try a different search term</div>
                    </div>
                `;
                dropdown.classList.add('visible');
                return;
            }

            // Build dropdown content
            let html = `
                <div class="search-result-section">
                    <div class="search-result-header">
                         Firewalls
                        <span class="search-result-count">${matchingFirewalls.length}</span>
                    </div>
            `;

            matchingFirewalls.slice(0, 10).forEach(fw => {
                const statusClass = fw.status === 'connected' ? 'connected' : 'disconnected';
                const statusColor = fw.status === 'connected' ? '#22c55e' : '#ef4444';
                const statusText = fw.status === 'connected' ? 'Connected' : 'Disconnected';
                const firewallName = fw.name || fw.ip;
                
                html += `
                    <div class="search-result-item" onclick="selectFirewall('${firewallName.replace(/'/g, "\\'")}', '${fw.id}')">
                        <div class="search-result-icon"></div>
                        <div class="search-result-info">
                            <div class="search-result-name">${firewallName}</div>
                            <div class="search-result-detail">
                                ${fw.name ? fw.ip + '  ' : ''}${fw.username}
                            </div>
                        </div>
                        <span class="search-result-badge" style="background: ${statusColor}20; color: ${statusColor};">
                            ${statusText}
                        </span>
                    </div>
                `;
            });

            if (matchingFirewalls.length > 10) {
                html += `
                    <div style="padding: 0.75rem 1rem; text-align: center; color: var(--gray-500); font-size: 0.875rem; background: var(--gray-50);">
                        +${matchingFirewalls.length - 10} more results
                    </div>
                `;
            }

            html += `</div>`;
            dropdown.innerHTML = html;
            dropdown.classList.add('visible');
        }

        function hideSearchSuggestions() {
            const dropdown = document.getElementById('search-results-dropdown');
            if (dropdown) {
                dropdown.classList.remove('visible');
            }
        }

        function selectFirewall(firewallName, firewallId) {
            // Remplir la barre de recherche avec le nom du firewall
            const searchInput = document.getElementById('global-search-input');
            searchInput.value = firewallName;
            
            // Afficher le bouton clear
            document.getElementById('global-search-clear').classList.add('visible');
            
            // Fermer le dropdown
            hideSearchSuggestions();
            
            // Appliquer le filtre
            filterAllFirewallCards(firewallName.toLowerCase());
        }

        function goToFirewall(firewallId) {
            hideSearchSuggestions();
            // Switch to firewalls tab
            switchTab('firewalls');
            // Scroll to firewall
            setTimeout(() => {
                const element = document.getElementById(`firewall-${firewallId}`);
                if (element) {
                    element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    // Highlight the firewall card briefly
                    element.style.boxShadow = '0 0 0 3px var(--primary-500)';
                    setTimeout(() => {
                        element.style.boxShadow = '';
                    }, 2000);
                }
            }, 300);
        }

        function filterAllFirewallCards(searchTerm) {
            console.log('[Global Search] Filtering with term:', searchTerm);
            
            // Dsactiver temporairement l'observer pour viter les boucles infinies
            if (window.contentObserver) {
                window.contentObserver.disconnect();
            }
            
            // Get all firewall cards/accordions from all sections
            const selectors = [
                '.firewall-card',  // For standard cards
                '.remediation-card',  // For remediation cards
                '.firewall-user-accordion',  // For accordion-style cards
                '.firewall-ldap-line',  // For LDAP lines
                '.firewall-item',  // For list items
                '.protocol-card'  // For protocol cards
            ];

            let totalCards = 0;
            let visibleCards = 0;
            let hiddenCards = 0;

            selectors.forEach(selector => {
                const cards = document.querySelectorAll(selector);
                totalCards += cards.length;
                
                cards.forEach(card => {
                    const text = card.textContent.toLowerCase();
                    if (searchTerm === '' || text.includes(searchTerm)) {
                        // Rafficher la carte
                        card.style.removeProperty('display');
                        card.style.display = '';  // Force empty string
                        visibleCards++;
                    } else {
                        card.style.display = 'none';
                        hiddenCards++;
                    }
                });
            });

            console.log(`[Global Search] Total cards: ${totalCards}, Visible: ${visibleCards}, Hidden: ${hiddenCards}`);

            // Check if any results are visible in each section
            updateEmptyStates(searchTerm);
            
            // Ractiver l'observer aprs un court dlai
            setTimeout(() => {
                if (window.contentObserver) {
                    const content = document.querySelector('.content');
                    if (content) {
                        window.contentObserver.observe(content, {
                            childList: true,
                            subtree: true
                        });
                    }
                }
            }, 300);
        }

        function updateEmptyStates(searchTerm) {
            // Si pas de recherche, nettoyer tous les messages "no results"
            if (!searchTerm) {
                const messages = document.querySelectorAll('.no-search-results');
                console.log('[Global Search] Clearing', messages.length, 'no-results messages');
                messages.forEach(msg => msg.remove());
                return;
            }

            // List of grid/container IDs to check
            const containerIds = [
                'firewall-grid',  // Section Firewalls principale
                'wan-grid',
                'wan-remediation-grid',  // WAN remediation
                'local-users-grid',
                'local-users-remediation-grid',  // Local Users remediation
                'ldap-grid',
                'ldap-remediation-grid',  // LDAP remediation
                'radius-grid',
                'radius-remediation-grid',  // RADIUS remediation
                'tacacs-grid',
                'tacacs-remediation-grid',  // TACACS+ remediation
                'sso-grid',
                'sso-remediation-grid',  // SSO remediation (overview)
                'sso-agent-remediation-grid',
                'sso-ts-remediation-grid',
                'sso-radius-remediation-grid',
                'ipsec-vpn-grid',
                'ipsec-remediation-grid',  // IPSec remediation
                'ssl-vpn-grid',
                'ssl-remediation-grid',  // SSL VPN remediation
                'pppoe-pptp-l2tp-grid',
                'cse-grid',
                'cse-remediation-grid'  // CSE remediation
            ];

            containerIds.forEach(containerId => {
                const container = document.getElementById(containerId);
                if (!container) return;

                const visibleCards = container.querySelectorAll('.firewall-card:not([style*="display: none"]), .remediation-card:not([style*="display: none"]), .firewall-user-accordion:not([style*="display: none"]), .firewall-ldap-line:not([style*="display: none"]), .protocol-card:not([style*="display: none"])');
                
                // Remove existing "no results" message
                const existingMessage = container.querySelector('.no-search-results');
                if (existingMessage) {
                    existingMessage.remove();
                }

                // Add "no results" message if no cards are visible
                if (visibleCards.length === 0 && searchTerm) {
                    const noResultsDiv = document.createElement('div');
                    noResultsDiv.className = 'no-search-results';
                    noResultsDiv.style.cssText = `
                        padding: 3rem 2rem;
                        text-align: center;
                        color: var(--gray-500);
                        background: var(--gray-50);
                        border-radius: 12px;
                        border: 2px dashed var(--gray-300);
                    `;
                    noResultsDiv.innerHTML = `
                        <div style="font-size: 3rem; margin-bottom: 1rem;"></div>
                        <h3 style="margin-bottom: 0.5rem; color: var(--gray-700);">No results found</h3>
                        <p>No firewalls match "${searchTerm}" in this section</p>
                    `;
                    container.appendChild(noResultsDiv);
                }
            });
        }

        // Firewall Dashboard Functions
        async function showFirewallDashboard(firewallId) {
            const firewall = window.firewalls.find(fw => fw.id === firewallId);
            if (!firewall) return;

            const modal = document.getElementById('firewall-dashboard-modal');
            const title = document.getElementById('dashboard-title');
            const content = document.getElementById('dashboard-content');

            title.textContent = `Security Audit - ${firewall.name || firewall.ip}`;
            content.innerHTML = '<div style="text-align: center; padding: 3rem; color: var(--gray-600);"><div style="width: 48px; height: 48px; border: 4px solid var(--primary-200); border-top-color: var(--primary-600); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1rem;"></div><p>Analyzing security modules...</p></div>';
            modal.classList.add('active');

            try {
                // Calculate security score with detailed module info
                const scoreData = await calculateSecurityScore(firewall);
                
                // Render dashboard
                content.innerHTML = renderFirewallDashboard(firewall, scoreData);
                
                // Animate all module scores
                setTimeout(() => {
                    // Animer le score global
                    const globalScoreContainer = document.getElementById('global-score-container');
                    if (globalScoreContainer) {
                        animateSecurityScore(globalScoreContainer);
                    }
                    
                    // Animer tous les scores de modules
                    document.querySelectorAll('.module-score-container').forEach(container => {
                        animateSecurityScore(container);
                    });
                }, 100);
            } catch (error) {
                console.error('Error loading dashboard:', error);
                content.innerHTML = '<div style="text-align: center; padding: 3rem; color: var(--error-500);"><div style="font-size: 3rem;"></div><p>Error loading dashboard</p></div>';
            }
        }

        function closeFirewallDashboard() {
            document.getElementById('firewall-dashboard-modal').classList.remove('active');
        }

        // Close dashboard with ESC key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const modal = document.getElementById('firewall-dashboard-modal');
                if (modal && modal.classList.contains('active')) {
                    closeFirewallDashboard();
                }
            }
        });

        function renderFirewallDashboard(firewall, scoreData) {
            const moduleDetails = [
                { name: 'WAN Management', key: 'wan_management', weight: 15, color: '#3b82f6' },
                { name: 'SSO', key: 'sso', weight: 15, color: '#8b5cf6' },
                { name: 'CSE', key: 'cse', weight: 10, color: '#06b6d4' },
                { name: 'SSL VPN', key: 'ssl_vpn', weight: 10, color: '#10b981' },
                { name: 'IPSec VPN', key: 'ipsec', weight: 10, color: '#14b8a6' },
                { name: 'Local Users', key: 'local_users', weight: 10, color: '#f59e0b' },
                { name: 'LDAP', key: 'ldap', weight: 10, color: '#f97316' },
                { name: 'RADIUS', key: 'radius', weight: 10, color: '#6366f1' },
                { name: 'TACACS+', key: 'tacacs', weight: 10, color: '#ec4899' }
            ];

            let modulesHtml = '';
            let index = 0;
            
            moduleDetails.forEach(module => {
                const moduleData = scoreData.modules[module.key];
                const isResolved = moduleData?.status?.is_resolved || false;
                const configChecked = moduleData?.config?.configChecked || false;
                const hasRealProblem = moduleData?.config?.hasRealProblem !== false;
                
                let moduleScore = 0;
                let statusText = '';
                let statusColor = '';
                let statusIcon = '';
                
                if (isResolved || (configChecked && !hasRealProblem)) {
                    moduleScore = 100;
                    statusText = isResolved ? 'Resolved' : 'No issues detected';
                    statusColor = '#22c55e';
                } else if (moduleData?.status?.verification_method === 'timer_expired_waiting_reactivation') {
                    moduleScore = 50;
                    statusText = 'Timer active - Pending';
                    statusColor = '#f59e0b';
                } else {
                    moduleScore = 0;
                    statusText = moduleData?.status ? 'Issues detected' : 'Not checked';
                    statusColor = '#ef4444';
                }

                modulesHtml += `
                    <div class="dashboard-module-card" style="--module-color: ${module.color}; animation-delay: ${index * 0.05}s; animation: cardFadeIn 0.5s ease-out forwards; opacity: 0;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="flex: 1;">
                                <div style="margin-bottom: 0.75rem;">
                                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                        <div style="
                                            width: 8px; 
                                            height: 8px; 
                                            background: ${module.color};
                                            border-radius: 50%;
                                            box-shadow: 0 0 12px ${module.color}60;
                                        "></div>
                                        <h3 style="margin: 0; font-size: 1.1rem; font-weight: 600; color: var(--gray-800);">${module.name}</h3>
                                    </div>
                                    <p style="margin: 0; padding-left: 1.25rem; font-size: 0.85rem; color: var(--gray-600);">${statusText}</p>
                                </div>
                                <div style="padding-left: 1.25rem; display: flex; gap: 0.5rem; align-items: center;">
                                    <div style="flex: 1; height: 6px; background: var(--gray-200); border-radius: 3px; overflow: hidden;">
                                        <div style="
                                            height: 100%; 
                                            width: ${moduleScore}%; 
                                            background: ${statusColor}; 
                                            border-radius: 3px;
                                            transition: width 1.5s ease-out;
                                            box-shadow: 0 0 8px ${statusColor}40;
                                        "></div>
                                    </div>
                                    <span style="font-size: 0.75rem; color: var(--gray-500); min-width: 40px; text-align: right;">${module.weight} pts</span>
                                </div>
                            </div>
                            <div class="module-score-container" style="margin-left: 1.5rem;">
                                <div class="security-score-circle" style="width: 70px; height: 70px;">
                                    <svg class="security-score-svg" viewBox="0 0 70 70">
                                        <circle class="security-score-bg" cx="35" cy="35" r="30" stroke-width="4" stroke="var(--gray-200)"></circle>
                                        <circle 
                                            class="security-score-progress security-score-animated" 
                                            cx="35" 
                                            cy="35" 
                                            r="30"
                                            stroke="${statusColor}"
                                            stroke-width="4"
                                            stroke-dasharray="${2 * Math.PI * 30}"
                                            stroke-dashoffset="${2 * Math.PI * 30}"
                                            data-final-offset="${2 * Math.PI * 30 * (1 - moduleScore/100)}"
                                            style="filter: drop-shadow(0 0 6px ${statusColor}40);"
                                        ></circle>
                                    </svg>
                                    <div class="security-score-text">
                                        <div class="security-score-value security-score-value-animated" style="color: ${statusColor}; font-size: 1.25rem; font-weight: 700;" data-final-score="${moduleScore}">0</div>
                                        <div style="font-size: 0.6rem; color: var(--gray-500); text-transform: uppercase;">%</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                index++;
            });

            return `
                <!-- Global Score Header -->
                <div style="
                    background: white;
                    border: 2px solid var(--primary-200);
                    border-radius: 20px;
                    padding: 2.5rem;
                    margin-bottom: 2rem;
                    text-align: center;
                    position: relative;
                    overflow: hidden;
                    box-shadow: 0 8px 32px rgba(59, 130, 246, 0.1);
                ">
                    <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(135deg, rgba(59, 130, 246, 0.02), rgba(139, 92, 246, 0.02)); pointer-events: none;"></div>
                    
                    <div style="position: relative; z-index: 1;">
                        <div style="display: inline-block; padding: 0.5rem 1.5rem; background: var(--primary-50); border-radius: 20px; margin-bottom: 1.5rem; border: 1px solid var(--primary-200);">
                            <span style="font-size: 0.9rem; font-weight: 600; color: var(--primary-600); text-transform: uppercase; letter-spacing: 1px;">Security Analysis</span>
                        </div>
                        
                        <div style="display: flex; flex-direction: column; align-items: center; gap: 2rem;">
                            <div id="global-score-container" style="transform: scale(1.5);">
                                ${renderSecurityScore(scoreData.score)}
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 1.2rem; color: var(--gray-700); font-weight: 500; margin-bottom: 1rem;">Security Points Earned</div>
                                <div style="display: flex; gap: 1rem; justify-content: center;">
                                    <div style="padding: 0.5rem 1rem; background: var(--success-50); border-radius: 8px; border: 1px solid var(--success-200);">
                                        <div style="font-size: 0.75rem; color: var(--gray-600); margin-bottom: 0.25rem;">Resolved</div>
                                        <div style="font-size: 1.25rem; font-weight: 700; color: var(--success-600);">${Math.round((scoreData.totalScore / scoreData.maxScore) * 100)}%</div>
                                    </div>
                                    <div style="padding: 0.5rem 1rem; background: var(--error-50); border-radius: 8px; border: 1px solid var(--error-200);">
                                        <div style="font-size: 0.75rem; color: var(--gray-600); margin-bottom: 0.25rem;">At Risk</div>
                                        <div style="font-size: 1.25rem; font-weight: 700; color: var(--error-600);">${Math.round(100 - (scoreData.totalScore / scoreData.maxScore) * 100)}%</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Modules Grid -->
                <div style="margin-bottom: 1.5rem;">
                    <h3 style="font-size: 1.25rem; font-weight: 600; color: var(--gray-800); margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.75rem;">
                        <span style="width: 4px; height: 24px; background: linear-gradient(180deg, var(--primary-500), var(--primary-600)); border-radius: 2px;"></span>
                        Security Modules Overview
                    </h3>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(380px, 1fr)); gap: 1rem;">
                    ${modulesHtml}
                </div>

                <style>
                    @keyframes cardFadeIn {
                        from {
                            opacity: 0;
                            transform: translateY(20px);
                        }
                        to {
                            opacity: 1;
                            transform: translateY(0);
                        }
                    }
                </style>
            `;
        }

        // ==================== ANALYTICS FUNCTIONS ====================
        
        async function loadAnalytics() {
            if (!window.firewalls || window.firewalls.length === 0) {
                document.getElementById('global-stats-grid').innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--gray-500);">No firewalls available for analysis</div>';
                return;
            }

            // Calculate scores for all firewalls
            const firewallScores = [];
            for (const fw of window.firewalls) {
                const scoreData = await calculateSecurityScore(fw);
                firewallScores.push({
                    firewall: fw,
                    score: scoreData.score,
                    totalScore: scoreData.totalScore,
                    maxScore: scoreData.maxScore,
                    modules: scoreData.modules
                });
            }

            // Render all analytics sections
            renderGlobalStats(firewallScores);
            renderSecurityScoreChart(firewallScores);
            renderModuleDistribution(firewallScores);
            renderFirewallRanking(firewallScores);
        }

        function renderGlobalStats(firewallScores) {
            const totalFirewalls = firewallScores.length;
            const averageScore = Math.round(firewallScores.reduce((sum, fw) => sum + fw.score, 0) / totalFirewalls);
            const criticalCount = firewallScores.filter(fw => fw.score < 35).length;
            const warningCount = firewallScores.filter(fw => fw.score >= 35 && fw.score < 70).length;
            const goodCount = firewallScores.filter(fw => fw.score >= 70).length;

            const grid = document.getElementById('global-stats-grid');
            grid.innerHTML = `
                <div class="stat-card" style="--card-color: var(--primary-500);">
                    <div class="stat-label">Total Firewalls</div>
                    <div class="stat-value">${totalFirewalls}</div>
                    <div class="stat-trend">In monitoring</div>
                </div>
                <div class="stat-card" style="--card-color: var(--success-600);">
                    <div class="stat-label">Average Security Score</div>
                    <div class="stat-value">${averageScore}<span style="font-size: 1.5rem; opacity: 0.6;">/100</span></div>
                    <div class="stat-trend">Across all devices</div>
                </div>
                <div class="stat-card" style="--card-color: #22c55e;">
                    <div class="stat-label">Good Status</div>
                    <div class="stat-value">${goodCount}</div>
                    <div class="stat-trend">${Math.round((goodCount/totalFirewalls)*100)}% of total</div>
                </div>
                <div class="stat-card" style="--card-color: #f59e0b;">
                    <div class="stat-label">Warning Status</div>
                    <div class="stat-value">${warningCount}</div>
                    <div class="stat-trend">${Math.round((warningCount/totalFirewalls)*100)}% of total</div>
                </div>
                <div class="stat-card" style="--card-color: #ef4444;">
                    <div class="stat-label">Critical Status</div>
                    <div class="stat-value">${criticalCount}</div>
                    <div class="stat-trend">${Math.round((criticalCount/totalFirewalls)*100)}% of total</div>
                </div>
            `;
        }

        function renderSecurityScoreChart(firewallScores) {
            const container = document.getElementById('security-score-chart');
            
            const sortedFirewalls = [...firewallScores].sort((a, b) => b.score - a.score);
            
            container.innerHTML = `
                <div style="text-align: center; margin-bottom: 1rem; padding: 0.75rem; background: var(--primary-50); border-radius: 8px; color: var(--primary-700); font-size: 0.9rem;">
                    Displaying all ${sortedFirewalls.length} firewalls (scroll to see more)
                </div>
                <div class="bar-chart" style="max-height: 500px; overflow-y: auto; padding-right: 0.5rem;">
                    ${sortedFirewalls.map((fw, index) => {
                        const barColor = getScoreBarColors(fw.score);
                        return `
                            <div class="bar-chart-item">
                                <div class="bar-label" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${fw.firewall.name || fw.firewall.ip}</div>
                                <div class="bar-container">
                                    <div class="bar-fill" style="--bar-start-color: ${barColor.start}; --bar-end-color: ${barColor.end}; width: 0%;" data-width="${fw.score}%">
                                        ${fw.score}/100
                                    </div>
                                </div>
                                <div class="bar-value">${fw.score}%</div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;

            // Animate bars
            setTimeout(() => {
                document.querySelectorAll('.bar-fill').forEach(bar => {
                    bar.style.width = bar.dataset.width;
                });
            }, 100);
        }

        function getScoreBarColors(score) {
            if (score >= 70) {
                return { start: '#22c55e', end: '#16a34a' };
            } else if (score >= 35) {
                return { start: '#f59e0b', end: '#d97706' };
            } else {
                return { start: '#ef4444', end: '#dc2626' };
            }
        }

        function renderModuleDistribution(firewallScores) {
            const container = document.getElementById('module-distribution-chart');
            
            const moduleNames = ['wan_management', 'sso', 'cse', 'ssl_vpn', 'ipsec', 'local_users', 'ldap', 'radius', 'tacacs'];
            const moduleLabels = {
                'wan_management': 'WAN Management',
                'sso': 'SSO',
                'cse': 'CSE',
                'ssl_vpn': 'SSL VPN',
                'ipsec': 'IPSec VPN',
                'local_users': 'Local Users',
                'ldap': 'LDAP',
                'radius': 'RADIUS',
                'tacacs': 'TACACS+'
            };

            const moduleStats = {};
            moduleNames.forEach(module => {
                moduleStats[module] = { resolved: 0, issues: 0, notChecked: 0 };
            });

            firewallScores.forEach(fw => {
                Object.keys(fw.modules).forEach(moduleKey => {
                    const moduleData = fw.modules[moduleKey];
                    if (moduleData.status?.is_resolved || (moduleData.config?.configChecked && !moduleData.config?.hasRealProblem)) {
                        moduleStats[moduleKey].resolved++;
                    } else if (moduleData.status) {
                        moduleStats[moduleKey].issues++;
                    } else {
                        moduleStats[moduleKey].notChecked++;
                    }
                });
            });

            container.innerHTML = moduleNames.map(module => {
                const stats = moduleStats[module];
                const total = stats.resolved + stats.issues + stats.notChecked;
                const resolvedPercent = Math.round((stats.resolved / total) * 100);
                
                return `
                    <div class="module-stat-card">
                        <div style="font-weight: 600; color: var(--gray-700); margin-bottom: 0.5rem;">${moduleLabels[module]}</div>
                        <div class="module-stat-value" style="color: ${stats.issues > 0 ? '#ef4444' : '#22c55e'};">
                            ${resolvedPercent}%
                        </div>
                        <div style="font-size: 0.75rem; color: var(--gray-500); margin-top: 0.25rem;">
                            ${stats.resolved}/${total} resolved
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderFirewallRanking(firewallScores) {
            const container = document.getElementById('firewall-ranking-list');
            
            const sortedFirewalls = [...firewallScores].sort((a, b) => b.score - a.score);
            
            container.innerHTML = `
                <div style="text-align: center; margin-bottom: 1rem; padding: 0.75rem; background: var(--success-50); border-radius: 8px; color: var(--success-700); font-size: 0.9rem;">
                    Displaying all ${sortedFirewalls.length} firewalls (scroll to see more)
                </div>
                <div style="max-height: 600px; overflow-y: auto; padding-right: 0.5rem;">
                    ${sortedFirewalls.map((fw, index) => `
                        <div class="ranking-item">
                            <div class="ranking-position ${index < 3 ? 'top-3' : ''}">#${index + 1}</div>
                            <div class="ranking-firewall-info">
                                <div class="ranking-firewall-name">${fw.firewall.name || 'Unnamed Firewall'}</div>
                                <div class="ranking-firewall-ip">${fw.firewall.ip}</div>
                            </div>
                            <div class="ranking-score-container" style="transform: scale(0.8);">
                                ${renderSecurityScore(fw.score)}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;

            // Animate the ranking scores
            setTimeout(() => {
                document.querySelectorAll('.ranking-item .security-score-circle').forEach(circle => {
                    const container = circle.parentElement;
                    animateSecurityScore(container);
                });
            }, 100);
        }
    </script>

    <!-- Firewall Dashboard Modal -->
    <div id="firewall-dashboard-modal" class="modal" onclick="closeFirewallDashboard()">
        <div class="modal-content" style="max-width: 1200px; max-height: 90vh; overflow-y: auto;" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2 id="dashboard-title"> Security Audit</h2>
                <button class="modal-close" onclick="closeFirewallDashboard()"></button>
            </div>
            <div class="modal-body" id="dashboard-content">
                <div style="text-align: center; padding: 3rem;">
                    <div style="font-size: 3rem;"></div>
                    <p>Loading dashboard...</p>
                </div>
            </div>
        </div>
    </div>
</body>
</html>